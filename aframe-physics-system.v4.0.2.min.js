!function o(n,s,r){function a(e,t){if(!s[e]){if(!n[e]){var i="function"==typeof require&&require;if(!t&&i)return i(e,!0);if(l)return l(e,!0);t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}i=s[e]={exports:{}};n[e][0].call(i.exports,function(t){return a(n[e][1][t]||t)},i,i.exports,o,n,s,r)}return s[e].exports}for(var l="function"==typeof require&&require,t=0;t<r.length;t++)a(r[t]);return a}({1:[function(t,e,i){var o=t("cannon-es");t("./src/components/math"),t("./src/components/body/ammo-body"),t("./src/components/body/body"),t("./src/components/body/dynamic-body"),t("./src/components/body/static-body"),t("./src/components/shape/shape"),t("./src/components/shape/ammo-shape"),t("./src/components/ammo-constraint"),t("./src/components/constraint"),t("./src/components/spring"),t("./src/system"),e.exports={registerAll:function(){console.warn("registerAll() is deprecated. Components are automatically registered.")}},window.CANNON=window.CANNON||o},{"./src/components/ammo-constraint":8,"./src/components/body/ammo-body":9,"./src/components/body/body":10,"./src/components/body/dynamic-body":11,"./src/components/body/static-body":12,"./src/components/constraint":13,"./src/components/math":14,"./src/components/shape/ammo-shape":16,"./src/components/shape/shape":17,"./src/components/spring":18,"./src/system":28,"cannon-es":4}],2:[function(t,e,i){var C=t("cannon-es");C.shape2mesh=function(t){for(var e=new THREE.Object3D,i=0;i<t.shapes.length;i++){var o=t.shapes[i];switch(o.type){case C.Shape.types.SPHERE:var n=new THREE.SphereGeometry(o.radius,8,8),s=new THREE.Mesh(n,this.currentMaterial);break;case C.Shape.types.PARTICLE:s=new THREE.Mesh(this.particleGeo,this.particleMaterial);n=this.settings;s.scale.set(n.particleSize,n.particleSize,n.particleSize);break;case C.Shape.types.PLANE:var r=new THREE.PlaneGeometry(10,10,4,4),a=(s=new THREE.Object3D,new THREE.Object3D),l=new THREE.Mesh(r,this.currentMaterial);l.scale.set(100,100,100),a.add(l),l.castShadow=!0,l.receiveShadow=!0,s.add(a);break;case C.Shape.types.BOX:l=new THREE.BoxGeometry(2*o.halfExtents.x,2*o.halfExtents.y,2*o.halfExtents.z);s=new THREE.Mesh(l,this.currentMaterial);break;case C.Shape.types.CONVEXPOLYHEDRON:for(var h=new THREE.Geometry,c=0;c<o.vertices.length;c++){var d=o.vertices[c];h.vertices.push(new THREE.Vector3(d.x,d.y,d.z))}for(c=0;c<o.faces.length;c++)for(var u=o.faces[c],p=u[0],m=1;m<u.length-1;m++){var f=u[m],y=u[m+1];h.faces.push(new THREE.Face3(p,f,y))}h.computeBoundingSphere(),h.computeFaceNormals(),s=new THREE.Mesh(h,this.currentMaterial);break;case C.Shape.types.HEIGHTFIELD:for(var r=new THREE.Geometry,v=new C.Vec3,g=new C.Vec3,w=new C.Vec3,b=0;b<o.data.length-1;b++)for(var x=0;x<o.data[b].length-1;x++)for(var E=0;E<2;E++)o.getConvexTrianglePillar(b,x,0===E),v.copy(o.pillarConvex.vertices[0]),g.copy(o.pillarConvex.vertices[1]),w.copy(o.pillarConvex.vertices[2]),v.vadd(o.pillarOffset,v),g.vadd(o.pillarOffset,g),w.vadd(o.pillarOffset,w),r.vertices.push(new THREE.Vector3(v.x,v.y,v.z),new THREE.Vector3(g.x,g.y,g.z),new THREE.Vector3(w.x,w.y,w.z)),c=r.vertices.length-3,r.faces.push(new THREE.Face3(c,c+1,c+2));r.computeBoundingSphere(),r.computeFaceNormals(),s=new THREE.Mesh(r,this.currentMaterial);break;case C.Shape.types.TRIMESH:for(r=new THREE.Geometry,v=new C.Vec3,g=new C.Vec3,w=new C.Vec3,c=0;c<o.indices.length/3;c++)o.getTriangleVertices(c,v,g,w),r.vertices.push(new THREE.Vector3(v.x,v.y,v.z),new THREE.Vector3(g.x,g.y,g.z),new THREE.Vector3(w.x,w.y,w.z)),m=r.vertices.length-3,r.faces.push(new THREE.Face3(m,m+1,m+2));r.computeBoundingSphere(),r.computeFaceNormals(),s=new THREE.Mesh(r,this.currentMaterial);break;default:throw"Visual type not recognized: "+o.type}if(s.receiveShadow=!0,s.castShadow=!0,s.children)for(c=0;c<s.children.length;c++)if(s.children[c].castShadow=!0,s.children[c].receiveShadow=!0,s.children[c])for(m=0;m<s.children[c].length;m++)s.children[c].children[m].castShadow=!0,s.children[c].children[m].receiveShadow=!0;var A=t.shapeOffsets[i],S=t.shapeOrientations[i];s.position.set(A.x,A.y,A.z),s.quaternion.set(S.x,S.y,S.z,S.w),e.add(s)}return e},e.exports=C.shape2mesh},{"cannon-es":4}],3:[function(t,e,i){THREE.AmmoDebugConstants={NoDebug:0,DrawWireframe:1,DrawAabb:2,DrawFeaturesText:4,DrawContactPoints:8,NoDeactivation:16,NoHelpText:32,DrawText:64,ProfileTimings:128,EnableSatComparison:256,DisableBulletLCP:512,EnableCCD:1024,DrawConstraints:2048,DrawConstraintLimits:4096,FastWireframe:8192,DrawNormals:16384,DrawOnTop:32768,MAX_DEBUG_DRAW_MODE:4294967295},THREE.AmmoDebugDrawer=function(t,e,i){this.scene=t,this.world=e,this.debugDrawMode=(i=i||{}).debugDrawMode||THREE.AmmoDebugConstants.DrawWireframe;t=this.debugDrawMode&THREE.AmmoDebugConstants.DrawOnTop||!1,e=i.maxBufferSize||1e6,this.geometry=new THREE.BufferGeometry,i=new Float32Array(3*e),e=new Float32Array(3*e),this.geometry.setAttribute("position",new THREE.BufferAttribute(i,3).setUsage(THREE.DynamicDrawUsage)),this.geometry.setAttribute("color",new THREE.BufferAttribute(e,3).setUsage(THREE.DynamicDrawUsage)),this.index=0,i=new THREE.LineBasicMaterial({vertexColors:!0,depthTest:!t});this.mesh=new THREE.LineSegments(this.geometry,i),t&&(this.mesh.renderOrder=999),this.mesh.frustumCulled=!1,this.enabled=!1,this.debugDrawer=new Ammo.DebugDrawer,this.debugDrawer.drawLine=this.drawLine.bind(this),this.debugDrawer.drawContactPoint=this.drawContactPoint.bind(this),this.debugDrawer.reportErrorWarning=this.reportErrorWarning.bind(this),this.debugDrawer.draw3dText=this.draw3dText.bind(this),this.debugDrawer.setDebugMode=this.setDebugMode.bind(this),this.debugDrawer.getDebugMode=this.getDebugMode.bind(this),this.debugDrawer.enable=this.enable.bind(this),this.debugDrawer.disable=this.disable.bind(this),this.debugDrawer.update=this.update.bind(this),this.world.setDebugDrawer(this.debugDrawer)},THREE.AmmoDebugDrawer.prototype=function(){return this.debugDrawer},THREE.AmmoDebugDrawer.prototype.enable=function(){this.enabled=!0,this.scene.add(this.mesh)},THREE.AmmoDebugDrawer.prototype.disable=function(){this.enabled=!1,this.scene.remove(this.mesh)},THREE.AmmoDebugDrawer.prototype.update=function(){this.enabled&&(0!=this.index&&(this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0),this.index=0,this.world.debugDrawWorld(),this.geometry.setDrawRange(0,this.index))},THREE.AmmoDebugDrawer.prototype.drawLine=function(t,e,i){var o=Ammo.HEAPF32,n=o[(i+0)/4],s=o[(i+4)/4],i=o[(i+8)/4],t=(this.geometry.attributes.position.setXYZ(this.index,o[(t+0)/4],o[(t+4)/4],o[(t+8)/4]),this.geometry.attributes.color.setXYZ(this.index++,n,s,i),o[(e+0)/4]),r=o[(e+4)/4],o=o[(e+8)/4];this.geometry.attributes.position.setXYZ(this.index,t,r,o),this.geometry.attributes.color.setXYZ(this.index++,n,s,i)},THREE.AmmoDebugDrawer.prototype.drawContactPoint=function(t,e,i,o,n){var s=Ammo.HEAPF32,r=s[(n+0)/4],a=s[(n+4)/4],n=s[(n+8)/4],l=s[(t+0)/4],h=s[(t+4)/4],t=s[(t+8)/4],c=(this.geometry.attributes.position.setXYZ(this.index,l,h,t),this.geometry.attributes.color.setXYZ(this.index++,r,a,n),s[(e+0)/4]*i),d=s[(e+4)/4]*i,s=s[(e+8)/4]*i;this.geometry.attributes.position.setXYZ(this.index,l+c,h+d,t+s),this.geometry.attributes.color.setXYZ(this.index++,r,a,n)},THREE.AmmoDebugDrawer.prototype.reportErrorWarning=function(t){Ammo.hasOwnProperty("Pointer_stringify")?console.warn(Ammo.Pointer_stringify(t)):this.warnedOnce||(this.warnedOnce=!0,console.warn("Cannot print warningString, please rebuild Ammo.js using 'debug' flag"))},THREE.AmmoDebugDrawer.prototype.draw3dText=function(t,e){console.warn("TODO: draw3dText")},THREE.AmmoDebugDrawer.prototype.setDebugMode=function(t){this.debugDrawMode=t},THREE.AmmoDebugDrawer.prototype.getDebugMode=function(){return this.debugDrawMode}},{}],4:[function(P,I,t){Object.defineProperty(t,"__esModule",{value:!0});(F=D.prototype).get=function(t,e){var i,t=t.id,e=e.id;return t<e&&(i=e,e=t,t=i),t+"-"+e in this.matrix},F.set=function(t,e,i){var o,t=t.id,e=e.id;t<e&&(o=e,e=t,t=o),i?this.matrix[t+"-"+e]=!0:delete this.matrix[t+"-"+e]},F.reset=function(){this.matrix={}},F.setNumObjects=function(t){};var F=D,L=((i=N.prototype).identity=function(){var t=this.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},i.setZero=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},i.setTrace=function(t){var e=this.elements;e[0]=t.x,e[4]=t.y,e[8]=t.z},i.getTrace=function(t){void 0===t&&(t=new W);var e=this.elements;t.x=e[0],t.y=e[4],t.z=e[8]},i.vmult=function(t,e){void 0===e&&(e=new W);var i=this.elements,o=t.x,n=t.y,t=t.z;return e.x=i[0]*o+i[1]*n+i[2]*t,e.y=i[3]*o+i[4]*n+i[5]*t,e.z=i[6]*o+i[7]*n+i[8]*t,e},i.smult=function(t){for(var e=0;e<this.elements.length;e++)this.elements[e]*=t},i.mmult=function(t,e){void 0===e&&(e=new N);for(var i=t.elements,o=0;o<3;o++)for(var n=0;n<3;n++){for(var s=0,r=0;r<3;r++)s+=i[o+3*r]*this.elements[r+3*n];e.elements[o+3*n]=s}return e},i.scale=function(t,e){void 0===e&&(e=new N);for(var i=this.elements,o=e.elements,n=0;3!==n;n++)o[3*n+0]=t.x*i[3*n+0],o[3*n+1]=t.y*i[3*n+1],o[3*n+2]=t.z*i[3*n+2];return e},i.solve=function(t,e){void 0===e&&(e=new W);for(var i,o=[],n=0;n<12;n++)o.push(0);for(n=0;n<3;n++)for(i=0;i<3;i++)o[n+4*i]=this.elements[n+3*i];o[3]=t.x,o[7]=t.y,o[11]=t.z;var s,r=3,a=r;do{if(0===o[(n=a-r)+4*n])for(i=n+1;i<a;i++)if(0!==o[n+4*i]){for(h=4;o[(s=4-h)+4*n]+=o[s+4*i],--h;);break}if(0!==o[n+4*n])for(i=n+1;i<a;i++)for(var l=o[n+4*i]/o[n+4*n],h=4;o[(s=4-h)+4*i]=s<=n?0:o[s+4*i]-o[s+4*n]*l,--h;);}while(--r);if(e.z=o[11]/o[10],e.y=(o[7]-o[6]*e.z)/o[5],e.x=(o[3]-o[2]*e.z-o[1]*e.y)/o[0],isNaN(e.x)||isNaN(e.y)||isNaN(e.z)||e.x===1/0||e.y===1/0||e.z===1/0)throw"Could not solve equation! Got x=["+e.toString()+"], b=["+t.toString()+"], A=["+this.toString()+"]";return e},i.e=function(t,e,i){if(void 0===i)return this.elements[e+3*t];this.elements[e+3*t]=i},i.copy=function(t){for(var e=0;e<t.elements.length;e++)this.elements[e]=t.elements[e];return this},i.toString=function(){for(var t="",e=0;e<9;e++)t+=this.elements[e]+",";return t},i.reverse=function(t){void 0===t&&(t=new N);for(var e,i=[],o=0;o<18;o++)i.push(0);for(o=0;o<3;o++)for(e=0;e<3;e++)i[o+6*e]=this.elements[o+3*e];i[3]=1,i[9]=0,i[15]=0,i[4]=0,i[10]=1,i[16]=0,i[5]=0,i[11]=0,i[17]=1;var n,s=3,r=s;do{if(0===i[(o=r-s)+6*o])for(e=o+1;e<r;e++)if(0!==i[o+6*e]){for(l=6;i[(n=6-l)+6*o]+=i[n+6*e],--l;);break}if(0!==i[o+6*o])for(e=o+1;e<r;e++)for(var a=i[o+6*e]/i[o+6*o],l=6;i[(n=6-l)+6*e]=n<=o?0:i[n+6*e]-i[n+6*o]*a,--l;);}while(--s);o=2;do{e=o-1;do{var h=i[o+6*e]/i[o+6*o];for(l=6;i[(n=6-l)+6*e]=i[n+6*e]-i[n+6*o]*h,--l;);}while(e--)}while(--o);o=2;do{var c=1/i[o+6*o];for(l=6;i[(n=6-l)+6*o]=i[n+6*o]*c,--l;);}while(o--);o=2;do{e=2;do{if(n=i[3+e+6*o],isNaN(n)||n===1/0)throw"Could not reverse! A=["+this.toString()+"]"}while(t.e(o,e,n),e--)}while(o--);return t},i.setRotationFromQuaternion=function(t){var e=t.x,i=t.y,o=t.z,t=t.w,n=e+e,s=i+i,r=o+o,a=e*n,l=e*s,e=e*r,h=i*s,i=i*r,o=o*r,n=t*n,s=t*s,t=t*r,r=this.elements;return r[0]=1-(h+o),r[1]=l-t,r[2]=e+s,r[3]=l+t,r[4]=1-(a+o),r[5]=i-n,r[6]=e-s,r[7]=i+n,r[8]=1-(a+h),this},i.transpose=function(t){for(var e=(t=void 0===t?new N:t).elements,i=this.elements,o=0;3!==o;o++)for(var n=0;3!==n;n++)e[3*o+n]=i[3*n+o];return t},N),W=((i=a.prototype).cross=function(t,e){void 0===e&&(e=new a);var i=t.x,o=t.y,t=t.z,n=this.x,s=this.y,r=this.z;return e.x=s*t-r*o,e.y=r*i-n*t,e.z=n*o-s*i,e},i.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},i.setZero=function(){this.x=this.y=this.z=0},i.vadd=function(t,e){if(!e)return new a(this.x+t.x,this.y+t.y,this.z+t.z);e.x=t.x+this.x,e.y=t.y+this.y,e.z=t.z+this.z},i.vsub=function(t,e){if(!e)return new a(this.x-t.x,this.y-t.y,this.z-t.z);e.x=this.x-t.x,e.y=this.y-t.y,e.z=this.z-t.z},i.crossmat=function(){return new L([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},i.normalize=function(){var t=this.x,e=this.y,i=this.z,t=Math.sqrt(t*t+e*e+i*i);return 0<t?(this.x*=e=1/t,this.y*=e,this.z*=e):(this.x=0,this.y=0,this.z=0),t},i.unit=function(t){void 0===t&&(t=new a);var e=this.x,i=this.y,o=this.z,n=Math.sqrt(e*e+i*i+o*o);return 0<n?(t.x=e*(n=1/n),t.y=i*n,t.z=o*n):(t.x=1,t.y=0,t.z=0),t},i.length=function(){var t=this.x,e=this.y,i=this.z;return Math.sqrt(t*t+e*e+i*i)},i.lengthSquared=function(){return this.dot(this)},i.distanceTo=function(t){var e=this.x,i=this.y,o=this.z,n=t.x,s=t.y,t=t.z;return Math.sqrt((n-e)*(n-e)+(s-i)*(s-i)+(t-o)*(t-o))},i.distanceSquared=function(t){var e=this.x,i=this.y,o=this.z,n=t.x,s=t.y,t=t.z;return(n-e)*(n-e)+(s-i)*(s-i)+(t-o)*(t-o)},i.scale=function(t,e){void 0===e&&(e=new a);var i=this.x,o=this.y,n=this.z;return e.x=t*i,e.y=t*o,e.z=t*n,e},i.vmul=function(t,e){return(e=void 0===e?new a:e).x=t.x*this.x,e.y=t.y*this.y,e.z=t.z*this.z,e},i.addScaledVector=function(t,e,i){return(i=void 0===i?new a:i).x=this.x+t*e.x,i.y=this.y+t*e.y,i.z=this.z+t*e.z,i},i.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},i.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},i.negate=function(t){return(t=void 0===t?new a:t).x=-this.x,t.y=-this.y,t.z=-this.z,t},i.tangents=function(t,e){var i,o=this.length();0<o?((i=V).set(this.x*(o=1/o),this.y*o,this.z*o),o=q,Math.abs(i.x)<.9?o.set(1,0,0):o.set(0,1,0),i.cross(o,t),i.cross(t,e)):(t.set(1,0,0),e.set(0,1,0))},i.toString=function(){return this.x+","+this.y+","+this.z},i.toArray=function(){return[this.x,this.y,this.z]},i.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},i.lerp=function(t,e,i){var o=this.x,n=this.y,s=this.z;i.x=o+(t.x-o)*e,i.y=n+(t.y-n)*e,i.z=s+(t.z-s)*e},i.almostEquals=function(t,e){return void 0===e&&(e=1e-6),!(Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e)},i.almostZero=function(t){return void 0===t&&(t=1e-6),!(Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t)},i.isAntiparallelTo=function(t,e){return this.negate(_),_.almostEquals(t,e)},i.clone=function(){return new a(this.x,this.y,this.z)},a);function a(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0),this.x=t=void 0===t?0:t,this.y=e,this.z=i}function N(t){this.elements=t=void 0===t?[0,0,0,0,0,0,0,0,0]:t}function D(){this.matrix={}}W.ZERO=new W(0,0,0),W.UNIT_X=new W(1,0,0),W.UNIT_Y=new W(0,1,0),W.UNIT_Z=new W(0,0,1);var V=new W,q=new W,_=new W,m=((i=Y.prototype).setFromPoints=function(t,e,i,o){var n=this.lowerBound,s=this.upperBound,r=i;n.copy(t[0]),r&&r.vmult(n,n),s.copy(n);for(var a=1;a<t.length;a++){var l=t[a];r&&(r.vmult(l,k),l=k),l.x>s.x&&(s.x=l.x),l.x<n.x&&(n.x=l.x),l.y>s.y&&(s.y=l.y),l.y<n.y&&(n.y=l.y),l.z>s.z&&(s.z=l.z),l.z<n.z&&(n.z=l.z)}return e&&(e.vadd(n,n),e.vadd(s,s)),o&&(n.x-=o,n.y-=o,n.z-=o,s.x+=o,s.y+=o,s.z+=o),this},i.copy=function(t){return this.lowerBound.copy(t.lowerBound),this.upperBound.copy(t.upperBound),this},i.clone=function(){return(new Y).copy(this)},i.extend=function(t){this.lowerBound.x=Math.min(this.lowerBound.x,t.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,t.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,t.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,t.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,t.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,t.upperBound.z)},i.overlaps=function(t){var e=this.lowerBound,i=this.upperBound,o=t.lowerBound,t=t.upperBound,n=o.x<=i.x&&i.x<=t.x||e.x<=t.x&&t.x<=i.x,s=o.y<=i.y&&i.y<=t.y||e.y<=t.y&&t.y<=i.y,o=o.z<=i.z&&i.z<=t.z||e.z<=t.z&&t.z<=i.z;return n&&s&&o},i.volume=function(){var t=this.lowerBound,e=this.upperBound;return(e.x-t.x)*(e.y-t.y)*(e.z-t.z)},i.contains=function(t){var e=this.lowerBound,i=this.upperBound,o=t.lowerBound,t=t.upperBound;return e.x<=o.x&&i.x>=t.x&&e.y<=o.y&&i.y>=t.y&&e.z<=o.z&&i.z>=t.z},i.getCorners=function(t,e,i,o,n,s,r,a){var l=this.lowerBound,h=this.upperBound;t.copy(l),e.set(h.x,l.y,l.z),i.set(h.x,h.y,l.z),o.set(l.x,h.y,h.z),n.set(h.x,l.y,h.z),s.set(l.x,h.y,l.z),r.set(l.x,l.y,h.z),a.copy(h)},i.toLocalFrame=function(t,e){var i=j,o=i[0];this.getCorners(o,i[1],i[2],i[3],i[4],i[5],i[6],i[7]);for(var n=0;8!==n;n++){var s=i[n];t.pointToLocal(s,s)}return e.setFromPoints(i)},i.toWorldFrame=function(t,e){var i=j,o=i[0];this.getCorners(o,i[1],i[2],i[3],i[4],i[5],i[6],i[7]);for(var n=0;8!==n;n++){var s=i[n];t.pointToWorld(s,s)}return e.setFromPoints(i)},i.overlapsRay=function(t){var e=t.direction,t=t.from,i=1/e.x,o=1/e.y,e=1/e.z,n=(this.lowerBound.x-t.x)*i,i=(this.upperBound.x-t.x)*i,s=(this.lowerBound.y-t.y)*o,o=(this.upperBound.y-t.y)*o,r=(this.lowerBound.z-t.z)*e,t=(this.upperBound.z-t.z)*e,e=Math.max(Math.max(Math.min(n,i),Math.min(s,o)),Math.min(r,t)),n=Math.min(Math.min(Math.max(n,i),Math.max(s,o)),Math.max(r,t));return!(n<0||n<e)},Y),k=new W,j=[new W,new W,new W,new W,new W,new W,new W,new W],U=((i=G.prototype).get=function(t,e){var i,t=t.index,e=e.index;return t<e&&(i=e,e=t,t=i),this.matrix[(t*(t+1)>>1)+e-1]},i.set=function(t,e,i){var o,t=t.index,e=e.index;t<e&&(o=e,e=t,t=o),this.matrix[(t*(t+1)>>1)+e-1]=i?1:0},i.reset=function(){for(var t=0,e=this.matrix.length;t!==e;t++)this.matrix[t]=0},i.setNumObjects=function(t){this.matrix.length=t*(t-1)>>1},G);function G(){this.matrix=[]}function Y(t){void 0===t&&(t={}),this.lowerBound=new W,this.upperBound=new W,t.lowerBound&&this.lowerBound.copy(t.lowerBound),t.upperBound&&this.upperBound.copy(t.upperBound)}function e(t,e){t.prototype=Object.create(e.prototype),(t.prototype.constructor=t).__proto__=e}function X(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(i=tt.prototype).addEventListener=function(t,e){void 0===this._listeners&&(this._listeners={});var i=this._listeners;return void 0===i[t]&&(i[t]=[]),i[t].includes(e)||i[t].push(e),this},i.hasEventListener=function(t,e){var i;return void 0!==this._listeners&&!(void 0===(i=this._listeners)[t]||!i[t].includes(e))},i.hasAnyEventListener=function(t){return void 0!==this._listeners&&void 0!==this._listeners[t]},i.removeEventListener=function(t,e){var i,o;return void 0!==this._listeners&&(void 0!==(i=this._listeners)[t]&&-1!==(o=i[t].indexOf(e)))&&i[t].splice(o,1),this},i.dispatchEvent=function(t){if(void 0!==this._listeners){var e=this._listeners[t.type];if(void 0!==e){t.target=this;for(var i=0,o=e.length;i<o;i++)e[i].call(this,t)}}return this};var i=tt,s=((o=$.prototype).set=function(t,e,i,o){return this.x=t,this.y=e,this.z=i,this.w=o,this},o.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},o.toArray=function(){return[this.x,this.y,this.z,this.w]},o.setFromAxisAngle=function(t,e){var i=Math.sin(.5*e);return this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=Math.cos(.5*e),this},o.toAxisAngle=function(t){void 0===t&&(t=new W),this.normalize();var e=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(t.x=this.x,t.y=this.y,t.z=this.z):(t.x=this.x/i,t.y=this.y/i,t.z=this.z/i),[t,e]},o.setFromVectors=function(t,e){var i;return t.isAntiparallelTo(e)?(t.tangents(i=Q,Z),this.setFromAxisAngle(i,Math.PI)):(i=t.cross(e),this.x=i.x,this.y=i.y,this.z=i.z,this.w=Math.sqrt(Math.pow(t.length(),2)*Math.pow(e.length(),2))+t.dot(e),this.normalize()),this},o.mult=function(t,e){void 0===e&&(e=new $);var i=this.x,o=this.y,n=this.z,s=this.w,r=t.x,a=t.y,l=t.z,t=t.w;return e.x=i*t+s*r+o*l-n*a,e.y=o*t+s*a+n*r-i*l,e.z=n*t+s*l+i*a-o*r,e.w=s*t-i*r-o*a-n*l,e},o.inverse=function(t){void 0===t&&(t=new $);var e=this.x,i=this.y,o=this.z,n=this.w,e=(this.conjugate(t),1/(e*e+i*i+o*o+n*n));return t.x*=e,t.y*=e,t.z*=e,t.w*=e,t},o.conjugate=function(t){return(t=void 0===t?new $:t).x=-this.x,t.y=-this.y,t.z=-this.z,t.w=this.w,t},o.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t=1/t,this.y*=t,this.z*=t,this.w*=t),this},o.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0==t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},o.vmult=function(t,e){void 0===e&&(e=new W);var i=t.x,o=t.y,t=t.z,n=this.x,s=this.y,r=this.z,a=this.w,l=a*i+s*t-r*o,h=a*o+r*i-n*t,c=a*t+n*o-s*i,i=-n*i-s*o-r*t;return e.x=l*a+i*-n+h*-r-c*-s,e.y=h*a+i*-s+c*-n-l*-r,e.z=c*a+i*-r+l*-s-h*-n,e},o.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},o.toEuler=function(t,e){void 0===e&&(e="YZX");var i=this.x,o=this.y,n=this.z,s=this.w;if("YZX"!==e)throw new Error("Euler order "+e+" not supported yet.");var r,a,l,h,c,e=i*o+n*s;.499<e&&(l=2*Math.atan2(i,s),h=Math.PI/2,c=0),e<-.499&&(l=-2*Math.atan2(i,s),h=-Math.PI/2,c=0),void 0===l&&(r=i*i,a=n*n,l=Math.atan2(2*o*s-2*i*n,1-2*(o*o)-2*a),h=Math.asin(2*e),c=Math.atan2(2*i*s-2*o*n,1-2*r-2*a)),t.y=l,t.z=h,t.x=c},o.setFromEuler=function(t,e,i,o){void 0===o&&(o="XYZ");var n=Math.cos(t/2),s=Math.cos(e/2),r=Math.cos(i/2),t=Math.sin(t/2),e=Math.sin(e/2),i=Math.sin(i/2);return"XYZ"===o?(this.x=t*s*r+n*e*i,this.y=n*e*r-t*s*i,this.z=n*s*i+t*e*r,this.w=n*s*r-t*e*i):"YXZ"===o?(this.x=t*s*r+n*e*i,this.y=n*e*r-t*s*i,this.z=n*s*i-t*e*r,this.w=n*s*r+t*e*i):"ZXY"===o?(this.x=t*s*r-n*e*i,this.y=n*e*r+t*s*i,this.z=n*s*i+t*e*r,this.w=n*s*r-t*e*i):"ZYX"===o?(this.x=t*s*r-n*e*i,this.y=n*e*r+t*s*i,this.z=n*s*i-t*e*r,this.w=n*s*r+t*e*i):"YZX"===o?(this.x=t*s*r+n*e*i,this.y=n*e*r+t*s*i,this.z=n*s*i-t*e*r,this.w=n*s*r-t*e*i):"XZY"===o&&(this.x=t*s*r-n*e*i,this.y=n*e*r-t*s*i,this.z=n*s*i+t*e*r,this.w=n*s*r+t*e*i),this},o.clone=function(){return new $(this.x,this.y,this.z,this.w)},o.slerp=function(t,e,i){void 0===i&&(i=new $);var o,n,s,r=this.x,a=this.y,l=this.z,h=this.w,c=t.x,d=t.y,u=t.z,t=t.w;return(s=r*c+a*d+l*u+h*t)<0&&(s=-s,c=-c,d=-d,u=-u,t=-t),s=1e-6<1-s?(s=Math.acos(s),o=Math.sin(s),n=Math.sin((1-e)*s)/o,Math.sin(e*s)/o):(n=1-e,e),i.x=n*r+s*c,i.y=n*a+s*d,i.z=n*l+s*u,i.w=n*h+s*t,i},o.integrate=function(t,e,i,o){void 0===o&&(o=new $);var n=t.x*i.x,s=t.y*i.y,t=t.z*i.z,i=this.x,r=this.y,a=this.z,l=this.w,e=.5*e;return o.x+=e*(n*l+s*a-t*r),o.y+=e*(s*l+t*i-n*a),o.z+=e*(t*l+n*r-s*i),o.w+=e*(-n*i-s*r-t*a),o},$),Q=new W,Z=new W,o={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256},ot=((n=J.prototype).updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},n.volume=function(){throw"volume() not implemented for shape type "+this.type},n.calculateLocalInertia=function(t,e){throw"calculateLocalInertia() not implemented for shape type "+this.type},n.calculateWorldAABB=function(t,e,i,o){throw"calculateWorldAABB() not implemented for shape type "+this.type},J);function J(t){void 0===t&&(t={}),this.id=J.idCounter++,this.type=t.type||0,this.boundingSphereRadius=0,this.collisionResponse=!t.collisionResponse||t.collisionResponse,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:1,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.material=t.material||null,this.body=null}function $(t,e,i,o){void 0===e&&(e=0),void 0===i&&(i=0),void 0===o&&(o=1),this.x=t=void 0===t?0:t,this.y=e,this.z=i,this.w=o}function tt(){}ot.idCounter=0,ot.types=o;(n=rt.prototype).pointToLocal=function(t,e){return rt.pointToLocalFrame(this.position,this.quaternion,t,e)},n.pointToWorld=function(t,e){return rt.pointToWorldFrame(this.position,this.quaternion,t,e)},n.vectorToWorldFrame=function(t,e){return void 0===e&&(e=new W),this.quaternion.vmult(t,e),e},rt.pointToLocalFrame=function(t,e,i,o){return void 0===o&&(o=new W),i.vsub(t,o),e.conjugate(it),it.vmult(o,o),o},rt.pointToWorldFrame=function(t,e,i,o){return void 0===o&&(o=new W),e.vmult(i,o),o.vadd(t,o),o},rt.vectorToWorldFrame=function(t,e,i){return void 0===i&&(i=new W),t.vmult(e,i),i},rt.vectorToLocalFrame=function(t,e,i,o){return void 0===o&&(o=new W),e.w*=-1,e.vmult(i,o),e.w*=-1,o};var et,O=rt,it=new s,nt=(e(st,et=ot),(n=st.prototype).computeEdges=function(){var t=this.faces,e=this.vertices,i=this.uniqueEdges;i.length=0;for(var o=new W,n=0;n!==t.length;n++)for(var s=t[n],r=s.length,a=0;a!==r;a++){e[s[a]].vsub(e[s[(a+1)%r]],o),o.normalize();for(var l=!1,h=0;h!==i.length;h++)if(i[h].almostEquals(o)||i[h].almostEquals(o)){l=!0;break}l||i.push(o.clone())}},n.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var t=0;t<this.faces.length;t++){for(var e=0;e<this.faces[t].length;e++)if(!this.vertices[this.faces[t][e]])throw new Error("Vertex "+this.faces[t][e]+" not found!");var i=this.faceNormals[t]||new W,o=(this.getFaceNormal(t,i),i.negate(i),this.faceNormals[t]=i,this.vertices[this.faces[t][0]]);if(i.dot(o)<0){console.error(".faceNormals["+t+"] = Vec3("+i.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var n=0;n<this.faces[t].length;n++)console.warn(".vertices["+this.faces[t][n]+"] = Vec3("+this.vertices[this.faces[t][n]].toString()+")")}}},n.getFaceNormal=function(t,e){var t=this.faces[t],i=this.vertices[t[0]],o=this.vertices[t[1]],t=this.vertices[t[2]];st.computeNormal(i,o,t,e)},n.clipAgainstHull=function(t,e,i,o,n,s,r,a,l){for(var h=new W,c=-1,d=-Number.MAX_VALUE,u=0;u<i.faces.length;u++){h.copy(i.faceNormals[u]),n.vmult(h,h);var p=h.dot(s);d<p&&(d=p,c=u)}for(var m=[],f=0;f<i.faces[c].length;f++){var y=i.vertices[i.faces[c][f]],v=new W;v.copy(y),n.vmult(v,v),o.vadd(v,v),m.push(v)}0<=c&&this.clipFaceAgainstHull(s,t,e,m,r,a,l)},n.findSeparatingAxis=function(t,e,i,o,n,s,r,a){var l=new W,h=new W,c=new W,d=new W,u=new W,p=new W,m=Number.MAX_VALUE;if(this.uniqueAxes)for(var f=0;f!==this.uniqueAxes.length;f++){i.vmult(this.uniqueAxes[f],l);var y=this.testSepAxis(l,t,e,i,o,n);if(!1===y)return!1;y<m&&(m=y,s.copy(l))}else for(var v=(r||this.faces).length,g=0;g<v;g++){var w=r?r[g]:g,w=(l.copy(this.faceNormals[w]),i.vmult(l,l),this.testSepAxis(l,t,e,i,o,n));if(!1===w)return!1;w<m&&(m=w,s.copy(l))}if(t.uniqueAxes)for(var b=0;b!==t.uniqueAxes.length;b++){n.vmult(t.uniqueAxes[b],h);var x=this.testSepAxis(h,t,e,i,o,n);if(!1===x)return!1;x<m&&(m=x,s.copy(h))}else for(var E=(a||t.faces).length,A=0;A<E;A++){var S=a?a[A]:A,S=(h.copy(t.faceNormals[S]),n.vmult(h,h),this.testSepAxis(h,t,e,i,o,n));if(!1===S)return!1;S<m&&(m=S,s.copy(h))}for(var C=0;C!==this.uniqueEdges.length;C++){i.vmult(this.uniqueEdges[C],d);for(var T=0;T!==t.uniqueEdges.length;T++)if(n.vmult(t.uniqueEdges[T],u),d.cross(u,p),!p.almostZero()){p.normalize();var B=this.testSepAxis(p,t,e,i,o,n);if(!1===B)return!1;B<m&&(m=B,s.copy(p))}}return o.vsub(e,c),0<c.dot(s)&&s.negate(s),!0},n.testSepAxis=function(t,e,i,o,n,s){st.project(this,t,i,o,lt),st.project(e,t,n,s,ht);i=lt[0],o=lt[1],e=ht[0],t=ht[1];return!(i<t||e<o)&&((n=i-t)<(s=e-o)?n:s)},n.calculateLocalInertia=function(t,e){var i=new W,o=new W,n=(this.computeLocalAABB(o,i),i.x-o.x),s=i.y-o.y,i=i.z-o.z;e.x=1/12*t*(2*s*2*s+2*i*2*i),e.y=1/12*t*(2*n*2*n+2*i*2*i),e.z=1/12*t*(2*s*2*s+2*n*2*n)},n.getPlaneConstantOfFace=function(t){var e=this.faces[t],t=this.faceNormals[t],e=this.vertices[e[0]];return-t.dot(e)},n.clipFaceAgainstHull=function(t,e,i,o,n,s,r){for(var a=new W,l=new W,h=new W,c=new W,d=new W,u=new W,p=new W,m=new W,f=o,y=[],v=-1,g=Number.MAX_VALUE,w=0;w<this.faces.length;w++){a.copy(this.faceNormals[w]),i.vmult(a,a);var b=a.dot(t);b<g&&(g=b,v=w)}if(!(v<0)){var x=this.faces[v];x.connectedFaces=[];for(var E=0;E<this.faces.length;E++)for(var A=0;A<this.faces[E].length;A++)-1!==x.indexOf(this.faces[E][A])&&E!==v&&-1===x.connectedFaces.indexOf(E)&&x.connectedFaces.push(E);for(var S=x.length,C=0;C<S;C++){var T=this.vertices[x[C]],B=this.vertices[x[(C+1)%S]],B=(T.vsub(B,l),h.copy(l),i.vmult(h,h),e.vadd(h,h),c.copy(this.faceNormals[v]),i.vmult(c,c),e.vadd(c,c),h.cross(c,d),d.negate(d),u.copy(T),i.vmult(u,u),e.vadd(u,u),x.connectedFaces[C]),T=(p.copy(this.faceNormals[B]),this.getPlaneConstantOfFace(B)),B=(m.copy(p),i.vmult(m,m),T-m.dot(e));for(this.clipFaceAgainstPlane(f,y,m,B);f.length;)f.shift();for(;y.length;)f.push(y.shift())}p.copy(this.faceNormals[v]);o=this.getPlaneConstantOfFace(v);m.copy(p),i.vmult(m,m);for(var M=o-m.dot(e),z=0;z<f.length;z++){var R,P=m.dot(f[z])+M;P<=n&&(console.log("clamped: depth="+P+" to minDist="+n),P=n),P<=s&&(R=f[z],P<=1e-6)&&r.push({point:R,normal:m,depth:P})}}},n.clipFaceAgainstPlane=function(t,e,i,o){var n=t.length;if(!(n<2))for(var s=t[t.length-1],r=i.dot(s)+o,a=0;a<n;a++){var l,h,c=t[a],d=i.dot(c)+o;r<0?d<0?((l=new W).copy(c),e.push(l)):(l=new W,s.lerp(c,r/(r-d),l),e.push(l)):d<0&&(h=new W,s.lerp(c,r/(r-d),h),e.push(h),e.push(c)),s=c,r=d}return e},n.computeWorldVertices=function(t,e){for(;this.worldVertices.length<this.vertices.length;)this.worldVertices.push(new W);for(var i=this.vertices,o=this.worldVertices,n=0;n!==this.vertices.length;n++)e.vmult(i[n],o[n]),t.vadd(o[n],o[n]);this.worldVerticesNeedsUpdate=!1},n.computeLocalAABB=function(t,e){var i=this.vertices;t.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),e.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var o=0;o<this.vertices.length;o++){var n=i[o];n.x<t.x?t.x=n.x:n.x>e.x&&(e.x=n.x),n.y<t.y?t.y=n.y:n.y>e.y&&(e.y=n.y),n.z<t.z?t.z=n.z:n.z>e.z&&(e.z=n.z)}},n.computeWorldFaceNormals=function(t){for(var e=this.faceNormals.length;this.worldFaceNormals.length<e;)this.worldFaceNormals.push(new W);for(var i=this.faceNormals,o=this.worldFaceNormals,n=0;n!==e;n++)t.vmult(i[n],o[n]);this.worldFaceNormalsNeedsUpdate=!1},n.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,i=0;i!==e.length;i++){var o=e[i].lengthSquared();t<o&&(t=o)}this.boundingSphereRadius=Math.sqrt(t)},n.calculateWorldAABB=function(t,e,i,o){for(var n,s,r,a,l,h,c=this.vertices,d=new W,u=0;u<c.length;u++)d.copy(c[u]),e.vmult(d,d),t.vadd(d,d),(void 0===n||d.x<n)&&(n=d.x),(void 0===a||d.x>a)&&(a=d.x),(void 0===s||d.y<s)&&(s=d.y),(void 0===l||d.y>l)&&(l=d.y),(void 0===r||d.z<r)&&(r=d.z),(void 0===h||d.z>h)&&(h=d.z);i.set(n,s,r),o.set(a,l,h)},n.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},n.getAveragePointLocal=function(t){void 0===t&&(t=new W);for(var e=this.vertices,i=0;i<e.length;i++)t.vadd(e[i],t);return t.scale(1/e.length,t),t},n.transformAllPoints=function(t,e){var i=this.vertices.length,o=this.vertices;if(e){for(var n=0;n<i;n++){var s=o[n];e.vmult(s,s)}for(var r=0;r<this.faceNormals.length;r++){var a=this.faceNormals[r];e.vmult(a,a)}}if(t)for(var l=0;l<i;l++){var h=o[l];h.vadd(t,h)}},n.pointIsInside=function(t){var e=this.vertices,i=this.faces,o=this.faceNormals,n=new W;this.getAveragePointLocal(n);for(var s=0;s<this.faces.length;s++){var r=o[s],a=e[i[s][0]],l=new W,l=(t.vsub(a,l),r.dot(l)),h=new W,a=(n.vsub(a,h),r.dot(h));if(l<0&&0<a||0<l&&a<0)return!1}return-1},st);function st(t){var e,t=t=void 0===t?{}:t,i=t.vertices,i=void 0===i?[]:i,o=t.faces,o=void 0===o?[]:o,n=t.normals,n=void 0===n?[]:n,s=t.axes,t=t.boundingSphereRadius;return(e=et.call(this,{type:ot.types.CONVEXPOLYHEDRON})||this).vertices=i,e.faces=o,e.faceNormals=n,0===e.faceNormals.length&&e.computeNormals(),t?e.boundingSphereRadius=t:e.updateBoundingSphereRadius(),e.worldVertices=[],e.worldVerticesNeedsUpdate=!0,e.worldFaceNormals=[],e.worldFaceNormalsNeedsUpdate=!0,e.uniqueAxes=s?s.slice():null,e.uniqueEdges=[],e.computeEdges(),e}function rt(t){void 0===t&&(t={}),this.position=new W,this.quaternion=new s,t.position&&this.position.copy(t.position),t.quaternion&&this.quaternion.copy(t.quaternion)}nt.computeNormal=function(t,e,i,o){var n=new W,s=new W;e.vsub(t,s),i.vsub(e,n),n.cross(s,o),o.isZero()||o.normalize()};var at,lt=[],ht=[],ct=(nt.project=function(t,e,i,o,n){var s=t.vertices.length,r=new W,a=0,l=0,h=new W,c=t.vertices,t=(h.setZero(),O.vectorToLocalFrame(i,o,e,r),O.pointToLocalFrame(i,o,h,h),h.dot(r));l=a=c[0].dot(r);for(var d=1;d<s;d++){var u=c[d].dot(r);a<u&&(a=u),u<l&&(l=u)}(l-=t)>(a-=t)&&(e=l,l=a,a=e),n[0]=a,n[1]=l},e(dt,at=ot),(n=dt.prototype).updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,e=this.halfExtents.y,i=this.halfExtents.z,o=W,t=[new o(-t,-e,-i),new o(t,-e,-i),new o(t,e,-i),new o(-t,e,-i),new o(-t,-e,i),new o(t,-e,i),new o(t,e,i),new o(-t,e,i)],e=[new o(0,0,1),new o(0,1,0),new o(1,0,0)],i=new nt({vertices:t,faces:[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],axes:e});(this.convexPolyhedronRepresentation=i).material=this.material},n.calculateLocalInertia=function(t,e){return void 0===e&&(e=new W),dt.calculateInertia(this.halfExtents,t,e),e},n.getSideNormals=function(t,e){var i=t,t=this.halfExtents;if(i[0].set(t.x,0,0),i[1].set(0,t.y,0),i[2].set(0,0,t.z),i[3].set(-t.x,0,0),i[4].set(0,-t.y,0),i[5].set(0,0,-t.z),void 0!==e)for(var o=0;o!==i.length;o++)e.vmult(i[o],i[o]);return i},n.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},n.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.length()},n.forEachWorldCorner=function(t,e,i){for(var o=this.halfExtents,n=[[o.x,o.y,o.z],[-o.x,o.y,o.z],[-o.x,-o.y,o.z],[-o.x,-o.y,-o.z],[o.x,-o.y,-o.z],[o.x,o.y,-o.z],[-o.x,o.y,-o.z],[o.x,-o.y,o.z]],s=0;s<n.length;s++)pt.set(n[s][0],n[s][1],n[s][2]),e.vmult(pt,pt),t.vadd(pt,pt),i(pt.x,pt.y,pt.z)},n.calculateWorldAABB=function(t,e,i,o){var n=this.halfExtents,n=(h[0].set(n.x,n.y,n.z),h[1].set(-n.x,n.y,n.z),h[2].set(-n.x,-n.y,n.z),h[3].set(-n.x,-n.y,-n.z),h[4].set(n.x,-n.y,-n.z),h[5].set(n.x,n.y,-n.z),h[6].set(-n.x,n.y,-n.z),h[7].set(n.x,-n.y,n.z),h[0]);e.vmult(n,n),t.vadd(n,n),o.copy(n),i.copy(n);for(var s=1;s<8;s++){var r=h[s],a=(e.vmult(r,r),t.vadd(r,r),r.x),l=r.y,r=r.z;a>o.x&&(o.x=a),o.y<l&&(o.y=l),o.z<r&&(o.z=r),a<i.x&&(i.x=a),l<i.y&&(i.y=l),r<i.z&&(i.z=r)}},dt);function dt(t){var e;return(e=at.call(this,{type:ot.types.BOX})||this).halfExtents=t,e.convexPolyhedronRepresentation=null,e.updateConvexPolyhedronRepresentation(),e.updateBoundingSphereRadius(),e}ct.calculateInertia=function(t,e,i){i.x=1/12*e*(2*t.y*2*t.y+2*t.z*2*t.z),i.y=1/12*e*(2*t.x*2*t.x+2*t.z*2*t.z),i.z=1/12*e*(2*t.y*2*t.y+2*t.x*2*t.x)};var ut,pt=new W,h=[new W,new W,new W,new W,new W,new W,new W,new W],n={AWAKE:0,SLEEPY:1,SLEEPING:2},K=(e(u,ut=i),(r=u.prototype).wakeUp=function(){var t=this.sleepState;this.sleepState=0,this.wakeUpAfterNarrowphase=!1,t===u.SLEEPING&&this.dispatchEvent(u.wakeupEvent)},r.sleep=function(){this.sleepState=u.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.wakeUpAfterNarrowphase=!1},r.sleepTick=function(t){var e,i,o;this.allowSleep&&(e=this.sleepState,i=this.velocity.lengthSquared()+this.angularVelocity.lengthSquared(),o=Math.pow(this.sleepSpeedLimit,2),e===u.AWAKE&&i<o?(this.sleepState=u.SLEEPY,this.timeLastSleepy=t,this.dispatchEvent(u.sleepyEvent)):e===u.SLEEPY&&o<i?this.wakeUp():e===u.SLEEPY&&t-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(u.sleepEvent)))},r.updateSolveMassProperties=function(){this.sleepState===u.SLEEPING||this.type===u.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},r.pointToLocalFrame=function(t,e){return void 0===e&&(e=new W),t.vsub(this.position,e),this.quaternion.conjugate().vmult(e,e),e},r.vectorToLocalFrame=function(t,e){return void 0===e&&(e=new W),this.quaternion.conjugate().vmult(t,e),e},r.pointToWorldFrame=function(t,e){return void 0===e&&(e=new W),this.quaternion.vmult(t,e),e.vadd(this.position,e),e},r.vectorToWorldFrame=function(t,e){return void 0===e&&(e=new W),this.quaternion.vmult(t,e),e},r.addShape=function(t,e,i){var o=new W,n=new s;return e&&o.copy(e),i&&n.copy(i),this.shapes.push(t),this.shapeOffsets.push(o),this.shapeOrientations.push(n),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,t.body=this},r.updateBoundingRadius=function(){for(var t=this.shapes,e=this.shapeOffsets,i=t.length,o=0,n=0;n!==i;n++){var s=t[n],r=(s.updateBoundingSphereRadius(),e[n].length()),s=s.boundingSphereRadius;o<r+s&&(o=r+s)}this.boundingRadius=o},r.computeAABB=function(){for(var t=this.shapes,e=this.shapeOffsets,i=this.shapeOrientations,o=t.length,n=mt,s=ft,r=this.quaternion,a=this.aabb,l=yt,h=0;h!==o;h++){var c=t[h];r.vmult(e[h],n),n.vadd(this.position,n),r.mult(i[h],s),c.calculateWorldAABB(n,s,l.lowerBound,l.upperBound),0===h?a.copy(l):a.extend(l)}this.aabbNeedsUpdate=!1},r.updateInertiaWorld=function(t){var e,i=this.invInertia;i.x===i.y&&i.y===i.z&&!t||(t=gt,(e=vt).setRotationFromQuaternion(this.quaternion),e.transpose(t),e.scale(i,e),e.mmult(t,this.invInertiaWorld))},r.applyForce=function(t,e){this.type===u.DYNAMIC&&(e.cross(t,e=wt),this.force.vadd(t,this.force),this.torque.vadd(e,this.torque))},r.applyLocalForce=function(t,e){var i;this.type===u.DYNAMIC&&(i=xt,this.vectorToWorldFrame(t,t=bt),this.vectorToWorldFrame(e,i),this.applyForce(t,i))},r.applyImpulse=function(t,e){var i;this.type===u.DYNAMIC&&(e=e,(i=Et).copy(t),i.scale(this.invMass,i),this.velocity.vadd(i,this.velocity),e.cross(t,i=At),this.invInertiaWorld.vmult(i,i),this.angularVelocity.vadd(i,this.angularVelocity))},r.applyLocalImpulse=function(t,e){var i;this.type===u.DYNAMIC&&(i=Ct,this.vectorToWorldFrame(t,t=St),this.vectorToWorldFrame(e,i),this.applyImpulse(t,i))},r.updateMassProperties=function(){var t=Tt,e=(this.invMass=0<this.mass?1/this.mass:0,this.inertia),i=this.fixedRotation;this.computeAABB(),t.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),ct.calculateInertia(t,this.mass,e),this.invInertia.set(0<e.x&&!i?1/e.x:0,0<e.y&&!i?1/e.y:0,0<e.z&&!i?1/e.z:0),this.updateInertiaWorld(!0)},r.getVelocityAtWorldPoint=function(t,e){var i=new W;return t.vsub(this.position,i),this.angularVelocity.cross(i,e),this.velocity.vadd(e,e),e},r.integrate=function(t,e,i){var o,n,s,r,a,l,h,c,d;this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),this.type!==u.DYNAMIC&&this.type!==u.KINEMATIC||this.sleepState===u.SLEEPING||(o=this.velocity,n=this.angularVelocity,s=this.position,a=this.force,d=this.torque,r=this.quaternion,l=this.invMass,c=this.invInertiaWorld,h=this.linearFactor,o.x+=a.x*(l=l*t)*h.x,o.y+=a.y*l*h.y,o.z+=a.z*l*h.z,a=c.elements,l=this.angularFactor,h=d.x*l.x,n.x+=t*(a[0]*h+a[1]*(c=d.y*l.y)+a[2]*(d=d.z*l.z)),n.y+=t*(a[3]*h+a[4]*c+a[5]*d),n.z+=t*(a[6]*h+a[7]*c+a[8]*d),s.x+=o.x*t,s.y+=o.y*t,s.z+=o.z*t,r.integrate(this.angularVelocity,t,this.angularFactor,r),e&&(i?r.normalizeFast():r.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld())},u);function u(t){void 0===t&&(t={}),(e=ut.call(this)||this).id=u.idCounter++,e.index=-1,e.world=null,e.preStep=null,e.postStep=null,e.vlambda=new W,e.collisionFilterGroup="number"==typeof t.collisionFilterGroup?t.collisionFilterGroup:1,e.collisionFilterMask="number"==typeof t.collisionFilterMask?t.collisionFilterMask:-1,e.collisionResponse="boolean"!=typeof t.collisionResponse||t.collisionResponse,e.position=new W,e.previousPosition=new W,e.interpolatedPosition=new W,e.initPosition=new W,t.position&&(e.position.copy(t.position),e.previousPosition.copy(t.position),e.interpolatedPosition.copy(t.position),e.initPosition.copy(t.position)),e.velocity=new W,t.velocity&&e.velocity.copy(t.velocity),e.initVelocity=new W,e.force=new W;var e,i="number"==typeof t.mass?t.mass:0;return e.mass=i,e.invMass=0<i?1/i:0,e.material=t.material||null,e.linearDamping="number"==typeof t.linearDamping?t.linearDamping:.01,e.type=i<=0?u.STATIC:u.DYNAMIC,typeof t.type==typeof u.STATIC&&(e.type=t.type),e.allowSleep=void 0===t.allowSleep||t.allowSleep,e.sleepState=0,e.sleepSpeedLimit=void 0!==t.sleepSpeedLimit?t.sleepSpeedLimit:.1,e.sleepTimeLimit=void 0!==t.sleepTimeLimit?t.sleepTimeLimit:1,e.timeLastSleepy=0,e.wakeUpAfterNarrowphase=!1,e.torque=new W,e.quaternion=new s,e.initQuaternion=new s,e.previousQuaternion=new s,e.interpolatedQuaternion=new s,t.quaternion&&(e.quaternion.copy(t.quaternion),e.initQuaternion.copy(t.quaternion),e.previousQuaternion.copy(t.quaternion),e.interpolatedQuaternion.copy(t.quaternion)),e.angularVelocity=new W,t.angularVelocity&&e.angularVelocity.copy(t.angularVelocity),e.initAngularVelocity=new W,e.shapes=[],e.shapeOffsets=[],e.shapeOrientations=[],e.inertia=new W,e.invInertia=new W,e.invInertiaWorld=new L,e.invMassSolve=0,e.invInertiaSolve=new W,e.invInertiaWorldSolve=new L,e.fixedRotation=void 0!==t.fixedRotation&&t.fixedRotation,e.angularDamping=void 0!==t.angularDamping?t.angularDamping:.01,e.linearFactor=new W(1,1,1),t.linearFactor&&e.linearFactor.copy(t.linearFactor),e.angularFactor=new W(1,1,1),t.angularFactor&&e.angularFactor.copy(t.angularFactor),e.aabb=new m,e.aabbNeedsUpdate=!0,e.boundingRadius=0,e.wlambda=new W,t.shape&&e.addShape(t.shape),e.updateMassProperties(),e}K.COLLIDE_EVENT_NAME="collide",K.DYNAMIC=1,K.STATIC=2,K.KINEMATIC=4,K.AWAKE=n.AWAKE,K.SLEEPY=n.SLEEPY,K.SLEEPING=n.SLEEPING,K.idCounter=0,K.wakeupEvent={type:"wakeup"},K.sleepyEvent={type:"sleepy"},K.sleepEvent={type:"sleep"};var mt=new W,ft=new s,yt=new m,vt=new L,gt=new L,wt=(new L,new W),bt=new W,xt=new W,Et=new W,At=new W,St=new W,Ct=new W,Tt=new W,r=((r=Pt.prototype).collisionPairs=function(t,e,i){throw new Error("collisionPairs not implemented for this BroadPhase class!")},r.needBroadphaseCollision=function(t,e){return 0!=(t.collisionFilterGroup&e.collisionFilterMask)&&0!=(e.collisionFilterGroup&t.collisionFilterMask)&&(0==(t.type&K.STATIC)&&t.sleepState!==K.SLEEPING||0==(e.type&K.STATIC)&&e.sleepState!==K.SLEEPING)},r.intersectionTest=function(t,e,i,o){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,e,i,o):this.doBoundingSphereBroadphase(t,e,i,o)},r.doBoundingSphereBroadphase=function(t,e,i,o){var n=Bt,s=(e.position.vsub(t.position,n),Math.pow(t.boundingRadius+e.boundingRadius,2));n.lengthSquared()<s&&(i.push(t),o.push(e))},r.doBoundingBoxBroadphase=function(t,e,i,o){t.aabbNeedsUpdate&&t.computeAABB(),e.aabbNeedsUpdate&&e.computeAABB(),t.aabb.overlaps(e.aabb)&&(i.push(t),o.push(e))},r.makePairsUnique=function(t,e){for(var i=Mt,o=zt,n=Rt,s=t.length,r=0;r!==s;r++)o[r]=t[r],n[r]=e[r];for(var a=e.length=t.length=0;a!==s;a++){var l=o[a].id,h=n[a].id,h=l<h?l+","+h:h+","+l;i[h]=a,i.keys.push(h)}for(var c=0;c!==i.keys.length;c++){var d=i.keys.pop(),u=i[d];t.push(o[u]),e.push(n[u]),delete i[d]}},r.setWorld=function(t){},r.aabbQuery=function(t,e,i){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]},Pt),Bt=new W,Mt=(new W,new s,new W,{keys:[]}),zt=[],Rt=[];function Pt(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}new W,r.boundingSphereCheck=function(t,e){var i=new W,t=(t.position.vsub(e.position,i),t.shapes[0]),e=e.shapes[0];return Math.pow(t.boundingSphereRadius+e.boundingSphereRadius,2)>i.lengthSquared()};e(_t,Ft=r),_t.prototype.collisionPairs=function(t,e,i){for(var D=t.numObjects(),V=t.bodies,t=this.aabbMax,o=this.aabbMin,y=this.nx,v=this.ny,g=this.nz,w=v*g,b=g,x=1,n=t.x,s=t.y,t=t.z,E=o.x,A=o.y,S=o.z,C=y/(n-E),T=v/(s-A),B=g/(t-S),r=(n-E)/y,a=(s-A)/v,l=(t-S)/g,O=.5*Math.sqrt(r*r+a*a+l*l),o=ot.types,H=o.SPHERE,q=o.PLANE,M=this.bins,z=this.binLengths,h=this.bins.length,c=0;c!==h;c++)z[c]=0;var R=Math.ceil;function _(t,e,i,o,n,s,r){var t=(t-E)*C|0,a=(e-A)*T|0,l=(i-S)*B|0,h=R((o-E)*C),c=R((n-A)*T),d=R((s-S)*B);t<0?t=0:y<=t&&(t=y-1),a<0?a=0:v<=a&&(a=v-1),l<0?l=0:g<=l&&(l=g-1),h<0?h=0:y<=h&&(h=y-1),c<0?c=0:v<=c&&(c=v-1),d<0?d=0:g<=d&&(d=g-1),a*=b,l*=x,h*=w,c*=b,d*=x;for(var u=t*=w;u<=h;u+=w)for(var p=a;p<=c;p+=b)for(var m=l;m<=d;m+=x){var f=u+p+m;M[f][z[f]++]=r}}for(var d=0;d!==D;d++){var u=V[d],p=u.shapes[0];switch(p.type){case H:var m=u.position.x,f=u.position.y,W=u.position.z,P=p.radius;_(m-P,f-P,W-P,m+P,f+P,W+P,u);break;case q:var m=p,k=(m.worldNormalNeedsUpdate&&m.computeWorldNormal(u.quaternion),m.worldNormal),f=E+.5*r-u.position.x,j=A+.5*a-u.position.y,U=S+.5*l-u.position.z,I=Nt;I.set(f,j,U);for(var G,Y=0,X=0;Y!==y;Y++,X+=w,I.y=j,I.x+=r)for(var Q=0,Z=0;Q!==v;Q++,Z+=b,I.z=U,I.y+=a)for(var K=0,J=0;K!==g;K++,J+=x,I.z+=l)I.dot(k)<O&&(M[G=X+Z+J][z[G]++]=u);break;default:u.aabbNeedsUpdate&&u.computeAABB(),_(u.aabb.lowerBound.x,u.aabb.lowerBound.y,u.aabb.lowerBound.z,u.aabb.upperBound.x,u.aabb.upperBound.y,u.aabb.upperBound.z,u)}}for(var F=0;F!==h;F++){var $=z[F];if(1<$)for(var tt=M[F],L=0;L!==$;L++)for(var et=tt[L],N=0;N!==L;N++){var it=tt[N];this.needBroadphaseCollision(et,it)&&this.intersectionTest(et,it,e,i)}}this.makePairsUnique(e,i)};var It,Ft,Lt=_t,Nt=new W,Dt=(new W,e(qt,It=r),(l=qt.prototype).collisionPairs=function(t,e,i){for(var o,n,s=t.bodies,r=s.length,a=0;a!==r;a++)for(var l=0;l!==a;l++)o=s[a],n=s[l],this.needBroadphaseCollision(o,n)&&this.intersectionTest(o,n,e,i)},l.aabbQuery=function(t,e,i){void 0===i&&(i=[]);for(var o=0;o<t.bodies.length;o++){var n=t.bodies[o];n.aabbNeedsUpdate&&n.computeAABB(),n.aabb.overlaps(e)&&i.push(n)}return i},qt),Vt=((l=Ht.prototype).reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1},l.abort=function(){this.shouldStop=!0},l.set=function(t,e,i,o,n,s,r){this.rayFromWorld.copy(t),this.rayToWorld.copy(e),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(o),this.shape=n,this.body=s,this.distance=r},Ht),H=((l=Ot.prototype).intersectWorld=function(t,e){return this.mode=e.mode||Ot.ANY,this.result=e.result||new Vt,this.skipBackfaces=!!e.skipBackfaces,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:-1,this.checkCollisionResponse=void 0===e.checkCollisionResponse||e.checkCollisionResponse,e.from&&this.from.copy(e.from),e.to&&this.to.copy(e.to),this.callback=e.callback||function(){},this.hasHit=!1,this.result.reset(),this.updateDirection(),this.getAABB(Wt),kt.length=0,t.broadphase.aabbQuery(t,Wt,kt),this.intersectBodies(kt),this.hasHit},l.intersectBody=function(t,e){e&&(this.result=e,this.updateDirection());var i=this.checkCollisionResponse;if((!i||t.collisionResponse)&&0!=(this.collisionFilterGroup&t.collisionFilterMask)&&0!=(t.collisionFilterGroup&this.collisionFilterMask))for(var o=Xt,n=Qt,s=0,r=t.shapes.length;s<r;s++){var a=t.shapes[s];if((!i||a.collisionResponse)&&(t.quaternion.mult(t.shapeOrientations[s],n),t.quaternion.vmult(t.shapeOffsets[s],o),o.vadd(t.position,o),this.intersectShape(a,n,o,t),this.result.shouldStop))break}},l.intersectBodies=function(t,e){e&&(this.result=e,this.updateDirection());for(var i=0,o=t.length;!this.result.shouldStop&&i<o;i++)this.intersectBody(t[i])},l.updateDirection=function(){this.to.vsub(this.from,this.direction),this.direction.normalize()},l.intersectShape=function(t,e,i,o){var n,s,r,a;n=this.from,s=this.direction,(r=i).vsub(n,ue),a=ue.dot(s),s.scale(a,pe),pe.vadd(n,pe),r.distanceTo(pe)>t.boundingSphereRadius||(s=this[t.type])&&s.call(this,t,e,i,o,t)},l._intersectBox=function(t,e,i,o,n){return this._intersectConvex(t.convexPolyhedronRepresentation,e,i,o,n)},l._intersectPlane=function(t,e,i,o,n){var s,r=this.from,a=this.to,l=this.direction,h=new W(0,0,1),e=(e.vmult(h,h),new W),c=(r.vsub(i,e),e.dot(h));a.vsub(i,e),0<c*e.dot(h)||r.distanceTo(a)<c||(e=h.dot(l),Math.abs(e)<this.precision)||(a=new W,c=new W,s=new W,r.vsub(i,a),i=-h.dot(a)/e,l.scale(i,c),r.vadd(c,s),this.reportIntersection(h,s,n,o,-1))},l.getAABB=function(t){var e=t.lowerBound,t=t.upperBound,i=this.to,o=this.from;e.x=Math.min(i.x,o.x),e.y=Math.min(i.y,o.y),e.z=Math.min(i.z,o.z),t.x=Math.max(i.x,o.x),t.y=Math.max(i.y,o.y),t.z=Math.max(i.z,o.z)},l._intersectHeightfield=function(t,e,i,o,n){t.data;var s=Jt;s.from.copy(this.from),s.to.copy(this.to),O.pointToLocalFrame(i,e,s.from,s.from),O.pointToLocalFrame(i,e,s.to,s.to),s.updateDirection();var r,a,l=$t,h=d=t.data.length-1,c=new m;s.getAABB(c),t.getIndexOfPosition(c.lowerBound.x,c.lowerBound.y,l,!0),a=Math.max(0,l[0]),r=Math.max(0,l[1]),t.getIndexOfPosition(c.upperBound.x,c.upperBound.y,l,!0),h=Math.min(h,l[0]+1);for(var d=Math.min(d,l[1]+1),u=a;u<h;u++)for(var p=r;p<d;p++){if(this.result.shouldStop)return;if(t.getAabbAtIndex(u,p,c),c.overlapsRay(s)){if(t.getConvexTrianglePillar(u,p,!1),O.pointToWorldFrame(i,e,t.pillarOffset,Kt),this._intersectConvex(t.pillarConvex,e,Kt,o,n,Zt),this.result.shouldStop)return;t.getConvexTrianglePillar(u,p,!0),O.pointToWorldFrame(i,e,t.pillarOffset,Kt),this._intersectConvex(t.pillarConvex,e,Kt,o,n,Zt)}}},l._intersectSphere=function(t,e,i,o,n){var s,r=this.from,a=this.to,t=t.radius,l=Math.pow(a.x-r.x,2)+Math.pow(a.y-r.y,2)+Math.pow(a.z-r.z,2),h=2*((a.x-r.x)*(r.x-i.x)+(a.y-r.y)*(r.y-i.y)+(a.z-r.z)*(r.z-i.z)),t=Math.pow(r.x-i.x,2)+Math.pow(r.y-i.y,2)+Math.pow(r.z-i.z,2)-Math.pow(t,2),t=Math.pow(h,2)-4*l*t,c=te,d=ee;t<0||(0==t?(r.lerp(a,t,c),c.vsub(i,d),d.normalize(),this.reportIntersection(d,c,n,o,-1)):(s=(-h-Math.sqrt(t))/(2*l),h=(-h+Math.sqrt(t))/(2*l),0<=s&&s<=1&&(r.lerp(a,s,c),c.vsub(i,d),d.normalize(),this.reportIntersection(d,c,n,o,-1)),this.result.shouldStop||0<=h&&h<=1&&(r.lerp(a,h,c),c.vsub(i,d),d.normalize(),this.reportIntersection(d,c,n,o,-1))))},l._intersectConvex=function(t,e,i,o,n,s){for(var r=ie,a=oe,l=s&&s.faceList||null,h=t.faces,c=t.vertices,d=t.faceNormals,u=this.direction,p=this.from,s=this.to,m=p.distanceTo(s),f=(l||h).length,y=this.result,v=0;!y.shouldStop&&v<f;v++){var g=l?l[v]:v,w=h[g],b=d[g],x=e,E=i,b=(a.copy(c[w[0]]),x.vmult(a,a),a.vadd(E,a),a.vsub(p,a),x.vmult(b,r),u.dot(r));if(!(Math.abs(b)<this.precision)){b=r.dot(a)/b;if(!(b<0)){u.scale(b,C),C.vadd(p,C),T.copy(c[w[0]]),x.vmult(T,T),E.vadd(T,T);for(var A=1;!y.shouldStop&&A<w.length-1;A++){B.copy(c[w[A]]),M.copy(c[w[A+1]]),x.vmult(B,B),x.vmult(M,M),E.vadd(B,B),E.vadd(M,M);var S=C.distanceTo(p);!Gt(C,T,B,M)&&!Gt(C,B,T,M)||m<S||this.reportIntersection(r,C,n,o,g)}}}}},l._intersectTrimesh=function(t,e,i,o,n,s){var r=ne,a=ce,l=de,h=oe,c=se,d=re,u=ae,p=he,m=le,f=(s&&s.faceList,t.indices),s=this.from,y=this.to,v=this.direction,g=(l.position.copy(i),l.quaternion.copy(e),O.vectorToLocalFrame(i,e,v,c),O.pointToLocalFrame(i,e,s,d),O.pointToLocalFrame(i,e,y,u),u.x*=t.scale.x,u.y*=t.scale.y,u.z*=t.scale.z,d.x*=t.scale.x,d.y*=t.scale.y,d.z*=t.scale.z,u.vsub(d,c),c.normalize(),d.distanceSquared(u));t.tree.rayQuery(this,l,a);for(var w=0,b=a.length;!this.result.shouldStop&&w!==b;w++){var x=a[w],E=(t.getNormal(x,r),t.getVertex(f[3*x],T),T.vsub(d,h),c.dot(r)),E=r.dot(h)/E;E<0||(c.scale(E,C),C.vadd(d,C),t.getVertex(f[3*x+1],B),t.getVertex(f[3*x+2],M),E=C.distanceSquared(d),!Gt(C,B,T,M)&&!Gt(C,T,B,M))||g<E||(O.vectorToWorldFrame(e,r,m),O.pointToWorldFrame(i,e,C,p),this.reportIntersection(m,p,n,o,x))}a.length=0},l.reportIntersection=function(t,e,i,o,n){var s=this.from,r=this.to,a=s.distanceTo(e),l=this.result;if(!(this.skipBackfaces&&0<t.dot(this.direction)))switch(l.hitFaceIndex=void 0!==n?n:-1,this.mode){case Ot.ALL:this.hasHit=!0,l.set(s,r,t,e,i,o,a),l.hasHit=!0,this.callback(l);break;case Ot.CLOSEST:(a<l.distance||!l.hasHit)&&(this.hasHit=!0,l.hasHit=!0,l.set(s,r,t,e,i,o,a));break;case Ot.ANY:this.hasHit=!0,l.hasHit=!0,l.set(s,r,t,e,i,o,a),l.shouldStop=!0}},Ot);function Ot(t,e){void 0===t&&(t=new W),void 0===e&&(e=new W),this.from=t.clone(),this.to=e.clone(),this.direction=new W,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=Ot.ANY,this.result=new Vt,this.hasHit=!1,this.callback=function(t){}}function Ht(){this.rayFromWorld=new W,this.rayToWorld=new W,this.hitNormalWorld=new W,this.hitPointWorld=new W,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}function qt(){return It.call(this)||this}function _t(t,e,i,o,n){void 0===t&&(t=new W(100,100,100)),void 0===e&&(e=new W(-100,-100,-100)),void 0===i&&(i=10),void 0===o&&(o=10),void 0===n&&(n=10),(s=Ft.call(this)||this).nx=i,s.ny=o,s.nz=n,s.aabbMin=t,s.aabbMax=e;var s,r=s.nx*s.ny*s.nz;if(r<=0)throw"GridBroadphase: Each dimension's n must be >0";s.bins=[],s.binLengths=[],s.bins.length=r,s.binLengths.length=r;for(var a=0;a<r;a++)s.bins[a]=[],s.binLengths[a]=0;return s}H.CLOSEST=1,H.ANY=2,H.ALL=4;var Wt=new m,kt=[],jt=new W,Ut=new W;function Gt(t,e,i,o){o.vsub(e,ue),i.vsub(e,jt),t.vsub(e,Ut);var n,o=ue.dot(ue),i=ue.dot(jt),t=ue.dot(Ut),e=jt.dot(jt),s=jt.dot(Ut);return 0<=(n=e*t-i*s)&&0<=(s=o*s-i*t)&&n+s<o*e-i*i}H.pointInTriangle=Gt;var Yt,Xt=new W,Qt=new s,C=(new W,new W,new W),T=new W,B=new W,M=new W,Zt=(new W,new Vt,H.prototype[ot.types.BOX]=H.prototype._intersectBox,H.prototype[ot.types.PLANE]=H.prototype._intersectPlane,{faceList:[0]}),Kt=new W,Jt=new H,$t=[],te=(H.prototype[ot.types.HEIGHTFIELD]=H.prototype._intersectHeightfield,new W),ee=new W,ie=(H.prototype[ot.types.SPHERE]=H.prototype._intersectSphere,new W),oe=(new W,new W,new W),ne=(H.prototype[ot.types.CONVEXPOLYHEDRON]=H.prototype._intersectConvex,new W),se=new W,re=new W,ae=new W,le=new W,he=new W,ce=(new m,[]),de=new O,ue=(H.prototype[ot.types.TRIMESH]=H.prototype._intersectTrimesh,new W),pe=new W,l=(e(me,Yt=r),(l=me.prototype).setWorld=function(t){for(var e=this.axisList.length=0;e<t.bodies.length;e++)this.axisList.push(t.bodies[e]);t.removeEventListener("addBody",this._addBodyHandler),t.removeEventListener("removeBody",this._removeBodyHandler),t.addEventListener("addBody",this._addBodyHandler),t.addEventListener("removeBody",this._removeBodyHandler),this.world=t,this.dirty=!0},l.collisionPairs=function(t,e,i){var o,n=this.axisList,s=n.length,r=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),o=0;o!==s;o++)for(var a=n[o],l=o+1;l<s;l++){var h=n[l];if(this.needBroadphaseCollision(a,h)){if(!me.checkBounds(a,h,r))break;this.intersectionTest(a,h,e,i)}}},l.sortList=function(){for(var t=this.axisList,e=this.axisIndex,i=t.length,o=0;o!==i;o++){var n=t[o];n.aabbNeedsUpdate&&n.computeAABB()}0===e?me.insertionSortX(t):1===e?me.insertionSortY(t):2===e&&me.insertionSortZ(t)},l.autoDetectAxis=function(){for(var t=0,e=0,i=0,o=0,n=0,s=0,r=this.axisList,a=r.length,l=1/a,h=0;h!==a;h++){var c=r[h],d=c.position.x,d=(t+=d,e+=d*d,c.position.y),d=(i+=d,o+=d*d,c.position.z);n+=d,s+=d*d}var u=e-t*t*l,p=o-i*i*l,l=s-n*n*l;this.axisIndex=p<u?l<u?0:2:l<p?1:2},l.aabbQuery=function(t,e,i){void 0===i&&(i=[]),this.dirty&&(this.sortList(),this.dirty=!1);for(var o=this.axisIndex,o=2===o?"z":1===o?"y":"x",n=this.axisList,s=(e.lowerBound[o],e.upperBound[o],0);s<n.length;s++){var r=n[s];r.aabbNeedsUpdate&&r.computeAABB(),r.aabb.overlaps(e)&&i.push(r)}return i},me);function me(t){(e=Yt.call(this)||this).axisList=[],e.world=null,e.axisIndex=0;var e,i=e.axisList;return e._addBodyHandler=function(t){i.push(t.body)},e._removeBodyHandler=function(t){t=i.indexOf(t.body);-1!==t&&i.splice(t,1)},t&&e.setWorld(t),e}function fe(){}l.insertionSortX=function(t){for(var e=1,i=t.length;e<i;e++){for(var o=t[e],n=void 0,n=e-1;0<=n&&!(t[n].aabb.lowerBound.x<=o.aabb.lowerBound.x);n--)t[n+1]=t[n];t[n+1]=o}return t},l.insertionSortY=function(t){for(var e=1,i=t.length;e<i;e++){for(var o=t[e],n=void 0,n=e-1;0<=n&&!(t[n].aabb.lowerBound.y<=o.aabb.lowerBound.y);n--)t[n+1]=t[n];t[n+1]=o}return t},l.insertionSortZ=function(t){for(var e=1,i=t.length;e<i;e++){for(var o=t[e],n=void 0,n=e-1;0<=n&&!(t[n].aabb.lowerBound.z<=o.aabb.lowerBound.z);n--)t[n+1]=t[n];t[n+1]=o}return t},l.checkBounds=function(t,e,i){0===i?(o=t.position.x,n=e.position.x):1===i?(o=t.position.y,n=e.position.y):2===i&&(o=t.position.z,n=e.position.z);var o,n,i=t.boundingRadius;return n-e.boundingRadius<o+i},fe.defaults=function(t,e){for(var i in void 0===t&&(t={}),e)i in t||(t[i]=e[i]);return t};(ye=ve.prototype).update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},ye.enable=function(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=!0},ye.disable=function(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=!1};var ye=ve;function ve(t,e,i){i=fe.defaults(i=void 0===i?{}:i,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=t,this.bodyB=e,this.id=ve.idCounter++,this.collideConnected=i.collideConnected,i.wakeUpBodies&&(t&&t.wakeUp(),e)&&e.wakeUp()}ye.idCounter=0;(c=be.prototype).multiplyElement=function(t){return t.spatial.dot(this.spatial)+t.rotational.dot(this.rotational)},c.multiplyVectors=function(t,e){return t.dot(this.spatial)+e.dot(this.rotational)};var ge=be,c=((c=we.prototype).setSpookParams=function(t,e,i){this.a=4/(i*(1+4*e)),this.b=4*e/(1+4*e),this.eps=4/(i*i*t*(1+4*e))},c.computeB=function(t,e,i){var o=this.computeGW();return-this.computeGq()*t-o*e-this.computeGiMf()*i},c.computeGq=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,o=this.bj,i=i.position,o=o.position;return t.spatial.dot(i)+e.spatial.dot(o)},c.computeGW=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,o=this.bj,n=i.velocity,s=o.velocity,o=o.angularVelocity;return t.multiplyVectors(n,i.angularVelocity)+e.multiplyVectors(s,o)},c.computeGWlambda=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,o=this.bj,n=i.vlambda,s=o.vlambda,o=o.wlambda;return t.multiplyVectors(n,i.wlambda)+e.multiplyVectors(s,o)},c.computeGiMf=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,o=this.bj,n=i.force,s=i.torque,r=o.force,a=o.torque,l=o.invMassSolve;return n.scale(i.invMassSolve,Ie),r.scale(l,Fe),i.invInertiaWorldSolve.vmult(s,Le),o.invInertiaWorldSolve.vmult(a,Ne),t.multiplyVectors(Ie,Le)+e.multiplyVectors(Fe,Ne)},c.computeGiMGt=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,o=this.bj,n=i.invMassSolve,s=o.invMassSolve,i=i.invInertiaWorldSolve,o=o.invInertiaWorldSolve,n=n+s;return i.vmult(t.rotational,De),n+=De.dot(t.rotational),o.vmult(e.rotational,De),n+De.dot(e.rotational)},c.addToWlambda=function(t){var e=this.jacobianElementA,i=this.jacobianElementB,o=this.bi,n=this.bj,s=Ve;o.vlambda.addScaledVector(o.invMassSolve*t,e.spatial,o.vlambda),n.vlambda.addScaledVector(n.invMassSolve*t,i.spatial,n.vlambda),o.invInertiaWorldSolve.vmult(e.rotational,s),o.wlambda.addScaledVector(t,s,o.wlambda),n.invInertiaWorldSolve.vmult(i.rotational,s),n.wlambda.addScaledVector(t,s,n.wlambda)},c.computeC=function(){return this.computeGiMGt()+this.eps},we);function we(t,e,i,o){void 0===i&&(i=-1e6),void 0===o&&(o=1e6),this.id=we.id++,this.minForce=i,this.maxForce=o,this.bi=t,this.bj=e,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new ge,this.jacobianElementB=new ge,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}function be(){this.spatial=new W,this.rotational=new W}c.id=0;function xe(t,e,i){i=fe.defaults(i,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=xe.idCounter++,this.materials=[t,e],this.friction=i.friction,this.restitution=i.restitution,this.contactEquationStiffness=i.contactEquationStiffness,this.contactEquationRelaxation=i.contactEquationRelaxation,this.frictionEquationStiffness=i.frictionEquationStiffness,this.frictionEquationRelaxation=i.frictionEquationRelaxation}var Ee,Ae,Se,Ce,Te,Be,Me,ze,Re,Pe,Ie=new W,Fe=new W,Le=new W,Ne=new W,De=new W,Ve=new W,Oe=(e(wi,Pe=c),(Ye=wi.prototype).computeB=function(t){var e=this.a,i=this.b,o=this.bi,n=this.bj,s=this.ri,r=this.rj,a=He,l=qe,h=o.velocity,c=o.angularVelocity,d=n.velocity,u=n.angularVelocity,p=_e,m=this.jacobianElementA,f=this.jacobianElementB,y=this.ni,m=(s.cross(y,a),r.cross(y,l),y.negate(m.spatial),a.negate(m.rotational),f.spatial.copy(y),f.rotational.copy(l),p.copy(n.position),p.vadd(r,p),p.vsub(o.position,p),p.vsub(s,p),y.dot(p)),f=this.restitution+1;return-m*e-(f*d.dot(y)-f*h.dot(y)+u.dot(l)-c.dot(a))*i-t*this.computeGiMf()},Ye.getImpactVelocityAlongNormal=function(){var t=We,e=ke,i=je,o=Ue,n=Ge;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,o),this.bi.getVelocityAtWorldPoint(i,t),this.bj.getVelocityAtWorldPoint(o,e),t.vsub(e,n),this.ni.dot(n)},wi),He=new W,qe=new W,_e=new W,We=new W,ke=new W,je=new W,Ue=new W,Ge=new W,Ye=(e(gi,Re=ye),gi.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.equationX,o=this.equationY,n=this.equationZ;t.quaternion.vmult(this.pivotA,i.ri),e.quaternion.vmult(this.pivotB,i.rj),o.ri.copy(i.ri),o.rj.copy(i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj)},gi),Xe=(e(vi,ze=c),vi.prototype.computeB=function(t){var e=this.a,i=this.b,o=this.axisA,n=this.axisB,s=Qe,r=Ze,a=this.jacobianElementA,l=this.jacobianElementB;return o.cross(n,s),n.cross(o,r),a.rotational.copy(r),l.rotational.copy(s),-(Math.cos(this.angle)-o.dot(n))*e-this.computeGW()*i-t*this.computeGiMf()},vi),Qe=new W,Ze=new W,Ke=(e(yi,Me=c),yi.prototype.computeB=function(t){var e=this.a,i=this.b,o=this.axisA,n=this.axisB,s=Je,r=$e,a=this.jacobianElementA,l=this.jacobianElementB;return o.cross(n,s),n.cross(o,r),a.rotational.copy(r),l.rotational.copy(s),-(Math.cos(this.maxAngle)-o.dot(n))*e-this.computeGW()*i-t*this.computeGiMf()},yi),Je=new W,$e=new W,ti=(e(fi,Be=Ye),fi.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.coneEquation,o=this.twistEquation;Be.prototype.update.call(this),t.vectorToWorldFrame(this.axisA,i.axisA),e.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(o.axisA,o.axisA),t.vectorToWorldFrame(o.axisA,o.axisA),this.axisB.tangents(o.axisB,o.axisB),e.vectorToWorldFrame(o.axisB,o.axisB),i.angle=this.angle,o.maxAngle=this.twistAngle},fi),ei=(new W,new W,e(mi,Te=ye),mi.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.distanceEquation,o=.5*this.distance,n=i.ni;e.position.vsub(t.position,n),n.normalize(),n.scale(o,i.ri),n.scale(-o,i.rj)},mi),ii=(e(pi,Ce=Ye),pi.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),o=this.rotationalEquation2,n=this.rotationalEquation3;Ce.prototype.update.call(this),t.vectorToWorldFrame(this.xA,i.axisA),e.vectorToWorldFrame(this.yB,i.axisB),t.vectorToWorldFrame(this.yA,o.axisA),e.vectorToWorldFrame(this.zB,o.axisB),t.vectorToWorldFrame(this.zA,n.axisA),e.vectorToWorldFrame(this.xB,n.axisB)},pi),oi=(new W,new W,e(ui,Se=c),ui.prototype.computeB=function(t){this.a;var e=this.b,i=(this.bi,this.bj,this.axisA),o=this.axisB,n=this.jacobianElementA,s=this.jacobianElementB;return n.rotational.copy(i),o.negate(s.rotational),-(this.computeGW()-this.targetVelocity)*e-t*this.computeGiMf()},ui),ni=(e(di,Ae=Ye),(d=di.prototype).enableMotor=function(){this.motorEquation.enabled=!0},d.disableMotor=function(){this.motorEquation.enabled=!1},d.setMotorSpeed=function(t){this.motorEquation.targetVelocity=t},d.setMotorMaxForce=function(t){this.motorEquation.maxForce=t,this.motorEquation.minForce=-t},d.update=function(){var t=this.bodyA,e=this.bodyB,i=this.motorEquation,o=this.rotationalEquation1,n=this.rotationalEquation2,s=si,r=ri,a=this.axisA,l=this.axisB;Ae.prototype.update.call(this),t.quaternion.vmult(a,s),e.quaternion.vmult(l,r),s.tangents(o.axisA,n.axisA),o.axisB.copy(r),n.axisB.copy(r),this.motorEquation.enabled&&(t.quaternion.vmult(this.axisA,i.axisA),e.quaternion.vmult(this.axisB,i.axisB))},di),si=new W,ri=new W,ai=(e(ci,Ee=c),ci.prototype.computeB=function(t){this.a;var e=this.b,i=(this.bi,this.bj,this.ri),o=this.rj,n=li,s=hi,r=this.t,i=(i.cross(r,n),o.cross(r,s),this.jacobianElementA),o=this.jacobianElementB;return r.negate(i.spatial),n.negate(i.rotational),o.spatial.copy(r),o.rotational.copy(s),-this.computeGW()*e-t*this.computeGiMf()},ci),li=new W,hi=new W;function ci(t,e,i){return(t=Ee.call(this,t,e,-i,i)||this).ri=new W,t.rj=new W,t.t=new W,t}function di(t,e,i){var o=void 0!==(i=void 0===i?{}:i).maxForce?i.maxForce:1e6,n=i.pivotA?i.pivotA.clone():new W,s=i.pivotB?i.pivotB.clone():new W,s=(((n=Ae.call(this,t,n,e,s,o)||this).axisA=i.axisA?i.axisA.clone():new W(1,0,0)).normalize(),(n.axisB=i.axisB?i.axisB.clone():new W(1,0,0)).normalize(),n.collideConnected=!!i.collideConnected,n.rotationalEquation1=new Ke(t,e,i)),i=n.rotationalEquation2=new Ke(t,e,i),t=n.motorEquation=new oi(t,e,o);return t.enabled=!1,n.equations.push(s,i,t),n}function ui(t,e,i){return(t=Se.call(this,t,e,-(i=void 0===i?1e6:i),i)||this).axisA=new W,t.axisB=new W,t.targetVelocity=0,t}function pi(t,e,i){var o=void 0!==(i=void 0===i?{}:i).maxForce?i.maxForce:1e6,n=new W,s=new W,r=new W,n=(t.position.vadd(e.position,r),r.scale(.5,r),e.pointToLocalFrame(r,s),t.pointToLocalFrame(r,n),(r=Ce.call(this,t,n,e,s,o)||this).xA=t.vectorToLocalFrame(W.UNIT_X),r.xB=e.vectorToLocalFrame(W.UNIT_X),r.yA=t.vectorToLocalFrame(W.UNIT_Y),r.yB=e.vectorToLocalFrame(W.UNIT_Y),r.zA=t.vectorToLocalFrame(W.UNIT_Z),r.zB=e.vectorToLocalFrame(W.UNIT_Z),r.rotationalEquation1=new Ke(t,e,i)),s=r.rotationalEquation2=new Ke(t,e,i),o=r.rotationalEquation3=new Ke(t,e,i);return r.equations.push(n,s,o),r}function mi(t,e,i,o){void 0===o&&(o=1e6),n=Te.call(this,t,e)||this,void 0===i&&(i=t.position.distanceTo(e.position)),n.distance=i;var n,i=n.distanceEquation=new Oe(t,e);return n.equations.push(i),i.minForce=-o,i.maxForce=o,n}function fi(t,e,i){var o=void 0!==(i=void 0===i?{}:i).maxForce?i.maxForce:1e6,n=i.pivotA?i.pivotA.clone():new W,s=i.pivotB?i.pivotB.clone():new W,s=((n=Be.call(this,t,n,e,s,o)||this).axisA=i.axisA?i.axisA.clone():new W,n.axisB=i.axisB?i.axisB.clone():new W,n.collideConnected=!!i.collideConnected,n.angle=void 0!==i.angle?i.angle:0,n.coneEquation=new Xe(t,e,i)),t=n.twistEquation=new Ke(t,e,i);return n.twistAngle=void 0!==i.twistAngle?i.twistAngle:0,s.maxForce=0,s.minForce=-o,t.maxForce=0,t.minForce=-o,n.equations.push(s,t),n}function yi(t,e,i){var o=void 0!==(i=void 0===i?{}:i).maxForce?i.maxForce:1e6;return(t=Me.call(this,t,e,-o,o)||this).axisA=i.axisA?i.axisA.clone():new W(1,0,0),t.axisB=i.axisB?i.axisB.clone():new W(0,1,0),t.maxAngle=Math.PI/2,t}function vi(t,e,i){var o=void 0!==(i=void 0===i?{}:i).maxForce?i.maxForce:1e6;return(t=ze.call(this,t,e,-o,o)||this).axisA=i.axisA?i.axisA.clone():new W(1,0,0),t.axisB=i.axisB?i.axisB.clone():new W(0,1,0),t.angle=void 0!==i.angle?i.angle:0,t}function gi(t,e,i,o,n){void 0===e&&(e=new W),void 0===o&&(o=new W),void 0===n&&(n=1e6),(s=Re.call(this,t,i)||this).pivotA=e.clone(),s.pivotB=o.clone();var s,e=s.equationX=new Oe(t,i),o=s.equationY=new Oe(t,i),t=s.equationZ=new Oe(t,i);return s.equations.push(e,o,t),e.minForce=o.minForce=t.minForce=-n,e.maxForce=o.maxForce=t.maxForce=n,e.ni.set(1,0,0),o.ni.set(0,1,0),t.ni.set(0,0,1),s}function wi(t,e,i){return(t=Pe.call(this,t,e,0,i=void 0===i?1e6:i)||this).restitution=0,t.ri=new W,t.rj=new W,t.ni=new W,t}function bi(t){var e="";"string"==typeof(t=void 0===t?{}:t)&&(e=t,t={}),this.name=e,this.id=bi.idCounter++,this.friction=void 0!==t.friction?t.friction:-1,this.restitution=void 0!==t.restitution?t.restitution:-1}bi.idCounter=xe.idCounter=0,(d=Zi.prototype).setWorldAnchorA=function(t){this.bodyA.pointToLocalFrame(t,this.localAnchorA)},d.setWorldAnchorB=function(t){this.bodyB.pointToLocalFrame(t,this.localAnchorB)},d.getWorldAnchorA=function(t){this.bodyA.pointToWorldFrame(this.localAnchorA,t)},d.getWorldAnchorB=function(t){this.bodyB.pointToWorldFrame(this.localAnchorB,t)},d.applyForce=function(){var t=this.stiffness,e=this.damping,i=this.restLength,o=this.bodyA,n=this.bodyB,s=xi,r=Ei,a=Ai,l=Si,h=Pi,c=Ci,d=Ti,u=Bi,p=Mi,m=zi,f=Ri,d=(this.getWorldAnchorA(c),this.getWorldAnchorB(d),c.vsub(o.position,u),d.vsub(n.position,p),d.vsub(c,s),s.length());r.copy(s),r.normalize(),n.velocity.vsub(o.velocity,a),n.angularVelocity.cross(p,h),a.vadd(h,a),o.angularVelocity.cross(u,h),a.vsub(h,a),r.scale(-t*(d-i)-e*a.dot(r),l),o.force.vsub(l,o.force),n.force.vadd(l,n.force),u.cross(l,m),p.cross(l,f),o.torque.vsub(m,o.torque),n.torque.vadd(f,n.torque)};var d=Zi,xi=new W,Ei=new W,Ai=new W,Si=new W,Ci=new W,Ti=new W,Bi=new W,Mi=new W,zi=new W,Ri=new W,Pi=new W,Ii=(Qi.prototype.updateWheel=function(t){var e,i=this.raycastResult;this.isInContact?(e=i.hitNormalWorld.dot(i.directionWorld),i.hitPointWorld.vsub(t.position,Li),t.getVelocityAtWorldPoint(Li,Fi),t=i.hitNormalWorld.dot(Fi),-.1<=e?(this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10):(this.suspensionRelativeVelocity=t*(t=-1/e),this.clippedInvContactDotSuspension=t)):(i.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,i.directionWorld.scale(-1,i.hitNormalWorld),this.clippedInvContactDotSuspension=1)},Qi),Fi=new W,Li=new W,p=((p=Xi.prototype).addWheel=function(t){var t=new Ii(t=void 0===t?{}:t),e=this.wheelInfos.length;return this.wheelInfos.push(t),e},p.setSteeringValue=function(t,e){this.wheelInfos[e].steering=t},p.applyEngineForce=function(t,e){this.wheelInfos[e].engineForce=t},p.setBrake=function(t,e){this.wheelInfos[e].brake=t},p.addToWorld=function(t){this.constraints,t.addBody(this.chassisBody);var e=this;this.preStepCallback=function(){e.updateVehicle(t.dt)},t.addEventListener("preStep",this.preStepCallback),this.world=t},p.getVehicleAxisWorld=function(t,e){e.set(0===t?1:0,1===t?1:0,2===t?1:0),this.chassisBody.vectorToWorldFrame(e,e)},p.updateVehicle=function(t){for(var e=this.wheelInfos,i=e.length,o=this.chassisBody,n=0;n<i;n++)this.updateWheelTransform(n);this.currentVehicleSpeedKmHour=3.6*o.velocity.length();var s=new W;this.getVehicleAxisWorld(this.indexForwardAxis,s),s.dot(o.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(var r=0;r<i;r++)this.castRay(e[r]);this.updateSuspension(t);for(var a=new W,l=new W,h=0;h<i;h++){var c=e[h],d=c.suspensionForce;c.maxSuspensionForce<d&&(d=c.maxSuspensionForce),c.raycastResult.hitNormalWorld.scale(d*t,a),c.raycastResult.hitPointWorld.vsub(o.position,l),o.applyImpulse(a,l)}this.updateFriction(t);for(var u=new W,p=new W,m=new W,f=0;f<i;f++){var y,v=e[f],g=(o.getVelocityAtWorldPoint(v.chassisConnectionPointWorld,m),1);1===this.indexUpAxis&&(g=-1),v.isInContact&&(this.getVehicleAxisWorld(this.indexForwardAxis,p),y=p.dot(v.raycastResult.hitNormalWorld),v.raycastResult.hitNormalWorld.scale(y,u),p.vsub(u,p),y=p.dot(m),v.deltaRotation=g*y*t/v.radius),!v.sliding&&v.isInContact||0===v.engineForce||!v.useCustomSlidingRotationalSpeed||(v.deltaRotation=(0<v.engineForce?1:-1)*v.customSlidingRotationalSpeed*t),Math.abs(v.brake)>Math.abs(v.engineForce)&&(v.deltaRotation=0),v.rotation+=v.deltaRotation,v.deltaRotation*=.99}},p.updateSuspension=function(t){for(var e=this.chassisBody.mass,i=this.wheelInfos,o=i.length,n=0;n<o;n++){var s,r,a=i[n];(!a.isInContact||(s=void 0,r=a.suspensionRestLength-a.suspensionLength,s=a.suspensionStiffness*r*a.clippedInvContactDotSuspension,s-=((r=a.suspensionRelativeVelocity)<0?a.dampingCompression:a.dampingRelaxation)*r,a.suspensionForce=s*e,a.suspensionForce<0))&&(a.suspensionForce=0)}},p.removeFromWorld=function(t){this.constraints,t.removeBody(this.chassisBody),t.removeEventListener("preStep",this.preStepCallback),this.world=null},p.castRay=function(t){var e=Oi,i=Hi,o=(this.updateWheelTransformWorld(t),this.chassisBody),n=-1,s=t.suspensionRestLength+t.radius,s=(t.directionWorld.scale(s,e),t.chassisConnectionPointWorld),e=(s.vadd(e,i),t.raycastResult),r=(e.reset(),o.collisionResponse),s=(o.collisionResponse=!1,this.world.rayTest(s,i,e),o.collisionResponse=r,e.body);return t.raycastResult.groundObject=0,s?(n=e.distance,t.raycastResult.hitNormalWorld=e.hitNormalWorld,t.isInContact=!0,i=e.distance,t.suspensionLength=i-t.radius,r=t.suspensionRestLength+t.maxSuspensionTravel,t.suspensionLength<(s=t.suspensionRestLength-t.maxSuspensionTravel)&&(t.suspensionLength=s),r<t.suspensionLength&&(t.suspensionLength=r,t.raycastResult.reset()),e=t.raycastResult.hitNormalWorld.dot(t.directionWorld),i=new W,o.getVelocityAtWorldPoint(t.raycastResult.hitPointWorld,i),s=t.raycastResult.hitNormalWorld.dot(i),-.1<=e?(t.suspensionRelativeVelocity=0,t.clippedInvContactDotSuspension=10):(t.suspensionRelativeVelocity=s*(r=-1/e),t.clippedInvContactDotSuspension=r)):(t.suspensionLength=t.suspensionRestLength+0*t.maxSuspensionTravel,t.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.raycastResult.hitNormalWorld),t.clippedInvContactDotSuspension=1),n},p.updateWheelTransformWorld=function(t){t.isInContact=!1;var e=this.chassisBody;e.pointToWorldFrame(t.chassisConnectionPointLocal,t.chassisConnectionPointWorld),e.vectorToWorldFrame(t.directionLocal,t.directionWorld),e.vectorToWorldFrame(t.axleLocal,t.axleWorld)},p.updateWheelTransform=function(t){var e=Ni,i=Di,o=Vi,t=this.wheelInfos[t],o=(this.updateWheelTransformWorld(t),t.directionLocal.scale(-1,e),i.copy(t.axleLocal),e.cross(i,o),o.normalize(),i.normalize(),t.steering),n=new s,e=(n.setFromAxisAngle(e,o),new s),o=(e.setFromAxisAngle(i,t.rotation),t.worldTransform.quaternion),i=(this.chassisBody.quaternion.mult(n,o),o.mult(e,o),o.normalize(),t.worldTransform.position);i.copy(t.directionWorld),i.scale(t.suspensionLength,i),i.vadd(t.chassisConnectionPointWorld,i)},p.getWheelTransformWorld=function(t){return this.wheelInfos[t].worldTransform},p.updateFriction=function(D){for(var V=_i,t=this.wheelInfos,e=t.length,i=this.chassisBody,o=ki,n=Wi,s=0;s<e;s++){var r=t[s];r.raycastResult.body,r.sideImpulse=0,r.forwardImpulse=0,o[s]||(o[s]=new W),n[s]||(n[s]=new W)}for(var O,a,l,h,c=0;c<e;c++){var d,u,p,m=t[c],f=m.raycastResult.body;f&&(d=n[c],this.getWheelTransformWorld(c).vectorToWorldFrame(qi[this.indexRightAxis],d),u=m.raycastResult.hitNormalWorld,p=d.dot(u),u.scale(p,V),d.vsub(V,d),d.normalize(),u.cross(d,o[c]),o[c].normalize(),m.sideImpulse=(p=i,u=m.raycastResult.hitPointWorld,f=f,O=m.raycastResult.hitPointWorld,h=l=a=void 0,1.1<(d=d).lengthSquared()?0:(a=io,l=oo,h=no,p.getVelocityAtWorldPoint(u,a),f.getVelocityAtWorldPoint(O,l),a.vsub(l,h),-.2*d.dot(h)*(1/(p.invMass+f.invMass)))),m.sideImpulse*=ji)}this.sliding=!1;for(var y,v,g,w=0;w<e;w++){var b,x,E,A,S,C,T,B,M=t[w],z=M.raycastResult.body,H=0;M.slipInfo=1,z&&(b=M.brake||0,C=i,T=z,B=M.raycastResult.hitPointWorld,y=o[w],v=b,S=A=E=x=g=void 0,g=0,x=B,E=Ui,A=Gi,S=Yi,C.getVelocityAtWorldPoint(x,E),T.getVelocityAtWorldPoint(x,A),E.vsub(A,S),H=g=(g=v<(g=-y.dot(S)*(1/(eo(C,B,y)+eo(T,B,y))))?v:g)<-v?-v:g,x=b/(H+=M.engineForce*D),M.slipInfo*=x),M.forwardImpulse=0,M.skidInfo=1,z&&(M.skidInfo=1,A=(E=M.suspensionForce*D*M.frictionSlip)*E,M.forwardImpulse=H,T=(S=.5*M.forwardImpulse)*S+(C=+M.sideImpulse)*C,M.sliding=!1,A<T)&&(this.sliding=!0,M.sliding=!0,B=E/Math.sqrt(T),M.skidInfo*=B)}if(this.sliding)for(var q=0;q<e;q++){var R=t[q];0!==R.sideImpulse&&R.skidInfo<1&&(R.forwardImpulse*=R.skidInfo,R.sideImpulse*=R.skidInfo)}for(var P=0;P<e;P++){var I,_,F,L=t[P],N=new W;L.raycastResult.hitPointWorld.vsub(i.position,N),0!==L.forwardImpulse&&(I=new W,o[P].scale(L.forwardImpulse,I),i.applyImpulse(I,N)),0!==L.sideImpulse&&(I=L.raycastResult.body,_=new W,L.raycastResult.hitPointWorld.vsub(I.position,_),F=new W,n[P].scale(L.sideImpulse,F),i.vectorToLocalFrame(N,N),N["xyz"[this.indexUpAxis]]*=L.rollInfluence,i.vectorToWorldFrame(N,N),i.applyImpulse(F,N),F.scale(-1,F),I.applyImpulse(F,_))}},Xi),Ni=(new W,new W,new W,new W),Di=new W,Vi=new W,Oi=(new H,new W,new W),Hi=new W,qi=[new W(1,0,0),new W(0,1,0),new W(0,0,1)],_i=new W,Wi=[],ki=[],ji=1,Ui=new W,Gi=new W,Yi=new W;function Xi(t){this.chassisBody=t.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==t.indexRightAxis?t.indexRightAxis:1,this.indexForwardAxis=void 0!==t.indexForwardAxis?t.indexForwardAxis:0,this.indexUpAxis=void 0!==t.indexUpAxis?t.indexUpAxis:2,this.constraints=[],this.preStepCallback=function(){},this.currentVehicleSpeedKmHour=0}function Qi(t){t=fe.defaults(t=void 0===t?{}:t,{chassisConnectionPointLocal:new W,chassisConnectionPointWorld:new W,directionLocal:new W,directionWorld:new W,axleLocal:new W,axleWorld:new W,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,slipInfo:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=t.maxSuspensionTravel,this.customSlidingRotationalSpeed=t.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=t.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=t.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=t.chassisConnectionPointWorld.clone(),this.directionLocal=t.directionLocal.clone(),this.directionWorld=t.directionWorld.clone(),this.axleLocal=t.axleLocal.clone(),this.axleWorld=t.axleWorld.clone(),this.suspensionRestLength=t.suspensionRestLength,this.suspensionMaxLength=t.suspensionMaxLength,this.radius=t.radius,this.suspensionStiffness=t.suspensionStiffness,this.dampingCompression=t.dampingCompression,this.dampingRelaxation=t.dampingRelaxation,this.frictionSlip=t.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=t.rollInfluence,this.maxSuspensionForce=t.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=t.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.slipInfo=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new Vt,this.worldTransform=new O,this.isInContact=!1}function Zi(t,e,i){this.restLength="number"==typeof(i=void 0===i?{}:i).restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=t,this.bodyB=e,this.localAnchorA=new W,this.localAnchorB=new W,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}var Ki=new W,Ji=new W,$i=new W,to=new W;function eo(t,e,i){var o=Ki,n=Ji,s=$i,r=to;return e.vsub(t.position,o),o.cross(i,n),t.invInertiaWorld.vmult(n,r),r.cross(o,s),t.invMass+i.dot(s)}var io=new W,oo=new W,no=new W;e(_o,ho=ot),(f=_o.prototype).calculateLocalInertia=function(t,e){void 0===e&&(e=new W);t=2*t*this.radius*this.radius/5;return e.x=t,e.y=t,e.z=t,e},f.volume=function(){return 4*Math.PI*Math.pow(this.radius,3)/3},f.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},f.calculateWorldAABB=function(t,e,i,o){for(var n=this.radius,s=["x","y","z"],r=0;r<s.length;r++){var a=s[r];i[a]=t[a]-n,o[a]=t[a]+n}};var so,ro,ao,lo,ho,co=_o,f=((f=qo.prototype).addWheel=function(t){e=(t=void 0===t?{}:t).body||new K({mass:1,shape:new co(1.2)}),this.wheelBodies.push(e),this.wheelForces.push(0),new W;var e,i=void 0!==t.position?t.position.clone():new W,o=new W,o=(this.chassisBody.pointToWorldFrame(i,o),e.position.set(o.x,o.y,o.z),void 0!==t.axis?t.axis.clone():new W(0,1,0)),t=(this.wheelAxes.push(o),new ni(this.chassisBody,e,{pivotA:i,axisA:o,pivotB:W.ZERO,axisB:o,collideConnected:!1}));return this.constraints.push(t),this.wheelBodies.length-1},f.setSteeringValue=function(t,e){var i=this.wheelAxes[e],o=Math.cos(t),t=Math.sin(t),n=i.x,i=i.y;this.constraints[e].axisA.set(o*n-t*i,t*n+o*i,0)},f.setMotorSpeed=function(t,e){e=this.constraints[e];e.enableMotor(),e.motorTargetVelocity=t},f.disableMotor=function(t){this.constraints[t].disableMotor()},f.setWheelForce=function(t,e){this.wheelForces[e]=t},f.applyWheelForce=function(t,e){var i=this.wheelAxes[e],e=this.wheelBodies[e],o=e.torque;i.scale(t,uo),e.vectorToWorldFrame(uo,uo),o.vadd(uo,o)},f.addToWorld=function(t){for(var e=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),o=0;o<i.length;o++)t.addBody(i[o]);for(var n=0;n<e.length;n++)t.addConstraint(e[n]);t.addEventListener("preStep",this._update.bind(this))},f._update=function(){for(var t=this.wheelForces,e=0;e<t.length;e++)this.applyWheelForce(t[e],e)},f.removeFromWorld=function(t){for(var e=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),o=0;o<i.length;o++)t.removeBody(i[o]);for(var n=0;n<e.length;n++)t.removeConstraint(e[n])},f.getWheelSpeed=function(t){var e=this.wheelAxes[t],t=this.wheelBodies[t].angularVelocity;return this.chassisBody.vectorToWorldFrame(e,po),t.dot(po)},qo),uo=new W,po=new W,mo=((mo=Ho.prototype).add=function(t){this.particles.push(t),this.neighbors.length<this.particles.length&&this.neighbors.push([])},mo.remove=function(t){t=this.particles.indexOf(t);-1!==t&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length)&&this.neighbors.pop()},mo.getNeighbors=function(t,e){for(var i=this.particles.length,o=t.id,n=this.smoothingRadius*this.smoothingRadius,s=fo,r=0;r!==i;r++){var a=this.particles[r];a.position.vsub(t.position,s),o!==a.id&&s.lengthSquared()<n&&e.push(a)}},mo.update=function(){for(var t=this.particles.length,e=yo,i=this.speedOfSound,o=this.eps,n=0;n!==t;n++){var s=this.particles[n],r=this.neighbors[n];r.length=0,this.getNeighbors(s,r),r.push(this.particles[n]);for(var a=r.length,l=0,h=0;h!==a;h++){s.position.vsub(r[h].position,e);var c=e.length(),c=this.w(c);l+=r[h].mass*c}this.densities[n]=l,this.pressures[n]=i*i*(this.densities[n]-this.density)}for(var d=vo,u=go,p=wo,m=bo,f=xo,y=0;y!==t;y++){var v=this.particles[y];d.set(0,0,0),u.set(0,0,0);for(var g=this.neighbors[y],w=g.length,b=0;b!==w;b++){var x=g[b],E=(v.position.vsub(x.position,m),m.length()),A=-x.mass*(this.pressures[y]/(this.densities[y]*this.densities[y]+o)+this.pressures[b]/(this.densities[b]*this.densities[b]+o));this.gradw(m,p),p.scale(A,p),d.vadd(p,d),x.velocity.vsub(v.velocity,f),f.scale(1/(1e-4+this.densities[y]*this.densities[b])*this.viscosity*x.mass,f),A=this.nablaw(E),f.scale(A,f),u.vadd(f,u)}u.scale(v.mass,u),d.scale(v.mass,d),v.force.vadd(u,v.force),v.force.vadd(d,v.force)}},mo.w=function(t){var e=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(e,9))*Math.pow(e*e-t*t,3)},mo.gradw=function(t,e){var i=t.length(),o=this.smoothingRadius;t.scale(945/(32*Math.PI*Math.pow(o,9))*Math.pow(o*o-i*i,2),e)},mo.nablaw=function(t){var e=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(e,9))*(e*e-t*t)*(7*t*t-3*e*e)},Ho),fo=new W,yo=new W,vo=new W,go=new W,wo=new W,bo=new W,xo=new W,Eo=(e(Oo,lo=nt),Oo),Ao=(e(Vo,ao=ot),(Ao=Vo.prototype).calculateLocalInertia=function(t,e){return(e=void 0===e?new W:e).set(0,0,0),e},Ao.volume=function(){return 0},Ao.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},Ao.calculateWorldAABB=function(t,e,i,o){i.copy(t),o.copy(t)},Vo),So=(e(Do,ro=ot),(So=Do.prototype).computeWorldNormal=function(t){var e=this.worldNormal;e.set(0,0,1),t.vmult(e,e),this.worldNormalNeedsUpdate=!1},So.calculateLocalInertia=function(t,e){return e=void 0===e?new W:e},So.volume=function(){return Number.MAX_VALUE},So.calculateWorldAABB=function(t,e,i,o){y.set(0,0,1),e.vmult(y,y);e=Number.MAX_VALUE;i.set(-e,-e,-e),o.set(e,e,e),1===y.x?o.x=t.x:-1===y.x&&(i.x=t.x),1===y.y?o.y=t.y:-1===y.y&&(i.y=t.y),1===y.z?o.z=t.z:-1===y.z&&(i.z=t.z)},So.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE},Do),y=new W,v=(e(No,so=ot),(v=No.prototype).update=function(){this._cachedPillars={}},v.updateMinValue=function(){for(var t=this.data,e=t[0][0],i=0;i!==t.length;i++)for(var o=0;o!==t[i].length;o++){var n=t[i][o];n<e&&(e=n)}this.minValue=e},v.updateMaxValue=function(){for(var t=this.data,e=t[0][0],i=0;i!==t.length;i++)for(var o=0;o!==t[i].length;o++){var n=t[i][o];e<n&&(e=n)}this.maxValue=e},v.setHeightValueAtIndex=function(t,e,i){this.data[t][e]=i,this.clearCachedConvexTrianglePillar(t,e,!1),0<t&&(this.clearCachedConvexTrianglePillar(t-1,e,!0),this.clearCachedConvexTrianglePillar(t-1,e,!1)),0<e&&(this.clearCachedConvexTrianglePillar(t,e-1,!0),this.clearCachedConvexTrianglePillar(t,e-1,!1)),0<e&&0<t&&this.clearCachedConvexTrianglePillar(t-1,e-1,!0)},v.getRectMinMax=function(t,e,i,o,n){void 0===n&&(n=[]);for(var s=this.data,r=this.minValue,a=t;a<=i;a++)for(var l=e;l<=o;l++){var h=s[a][l];r<h&&(r=h)}n[0]=this.minValue,n[1]=r},v.getIndexOfPosition=function(t,e,i,o){var n=this.elementSize,s=this.data,t=Math.floor(t/n),e=Math.floor(e/n);return i[0]=t,i[1]=e,o&&((t=t<0?0:t)>=s.length-1&&(t=s.length-1),(e=e<0?0:e)>=s[0].length-1)&&(e=s[0].length-1),!(t<0||e<0||t>=s.length-1||e>=s[0].length-1)},v.getTriangleAt=function(t,e,i,o,n,s){var r=Co,a=(this.getIndexOfPosition(t,e,r,i),r[0]),r=r[1],l=this.data,i=(i&&(a=Math.min(l.length-2,Math.max(0,a)),r=Math.min(l[0].length-2,Math.max(0,r))),this.elementSize),l=Math.pow(t/i-a,2)+Math.pow(e/i-r,2)>Math.pow(t/i-(a+1),2)+Math.pow(e/i-(r+1),2);return this.getTriangle(a,r,l,o,n,s),l},v.getNormalAt=function(t,e,i,o){var n=Ro,s=Po,r=Io,a=Fo,l=Lo;this.getTriangleAt(t,e,i,n,s,r),s.vsub(n,a),r.vsub(n,l),a.cross(l,o),o.normalize()},v.getAabbAtIndex=function(t,e,i){var o=i.lowerBound,i=i.upperBound,n=this.data,s=this.elementSize;o.set(t*s,e*s,n[t][e]),i.set((t+1)*s,(e+1)*s,n[t+1][e+1])},v.getHeightAt=function(t,e,i){var o,n,s,r,a=this.data,l=Bo,h=Mo,c=zo,d=Co,u=(this.getIndexOfPosition(t,e,d,i),d[0]),d=d[1],i=(i&&(u=Math.min(a.length-2,Math.max(0,u)),d=Math.min(a[0].length-2,Math.max(0,d))),this.getTriangleAt(t,e,i,l,h,c));return t=t,e=e,o=l.x,l=l.y,n=h.x,h=h.y,s=c.x,c=c.y,(r=To).x=((h-c)*(t-s)+(s-n)*(e-c))/((h-c)*(o-s)+(s-n)*(l-c)),r.y=((c-l)*(t-s)+(o-s)*(e-c))/((h-c)*(o-s)+(s-n)*(l-c)),r.z=1-r.x-r.y,i?a[u+1][d+1]*To.x+a[u][d+1]*To.y+a[u+1][d]*To.z:a[u][d]*To.x+a[u+1][d]*To.y+a[u][d+1]*To.z},v.getCacheConvexTrianglePillarKey=function(t,e,i){return t+"_"+e+"_"+(i?1:0)},v.getCachedConvexTrianglePillar=function(t,e,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,i)]},v.setCachedConvexTrianglePillar=function(t,e,i,o,n){this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,i)]={convex:o,offset:n}},v.clearCachedConvexTrianglePillar=function(t,e,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,i)]},v.getTriangle=function(t,e,i,o,n,s){var r=this.data,a=this.elementSize;i?(o.set((t+1)*a,(e+1)*a,r[t+1][e+1]),n.set(t*a,(e+1)*a,r[t][e+1]),s.set((t+1)*a,e*a,r[t+1][e])):(o.set(t*a,e*a,r[t][e]),n.set((t+1)*a,e*a,r[t+1][e]),s.set(t*a,(e+1)*a,r[t][e+1]))},v.getConvexTrianglePillar=function(t,e,i){var o=this.pillarConvex,n=this.pillarOffset;if(this.cacheEnabled){var s=this.getCachedConvexTrianglePillar(t,e,i);if(s)return this.pillarConvex=s.convex,void(this.pillarOffset=s.offset);o=new nt,n=new W,this.pillarConvex=o,this.pillarOffset=n}var s=this.data,r=this.elementSize,a=o.faces;o.vertices.length=6;for(var l=0;l<6;l++)o.vertices[l]||(o.vertices[l]=new W);a.length=5;for(var h=0;h<5;h++)a[h]||(a[h]=[]);var c=o.vertices,d=(Math.min(s[t][e],s[t+1][e],s[t][e+1],s[t+1][e+1])-this.minValue)/2+this.minValue;i?(n.set((t+.75)*r,(e+.75)*r,d),c[0].set(.25*r,.25*r,s[t+1][e+1]-d),c[1].set(-.75*r,.25*r,s[t][e+1]-d),c[2].set(.25*r,-.75*r,s[t+1][e]-d),c[3].set(.25*r,.25*r,-d-1),c[4].set(-.75*r,.25*r,-d-1),c[5].set(.25*r,-.75*r,-d-1),a[0][0]=0,a[0][1]=1,a[0][2]=2,a[1][0]=5,a[1][1]=4,a[1][2]=3,a[2][0]=2,a[2][1]=5,a[2][2]=3,a[2][3]=0,a[3][0]=3,a[3][1]=4,a[3][2]=1,a[3][3]=0,a[4][0]=1,a[4][1]=4,a[4][2]=5,a[4][3]=2):(n.set((t+.25)*r,(e+.25)*r,d),c[0].set(-.25*r,-.25*r,s[t][e]-d),c[1].set(.75*r,-.25*r,s[t+1][e]-d),c[2].set(-.25*r,.75*r,s[t][e+1]-d),c[3].set(-.25*r,-.25*r,-d-1),c[4].set(.75*r,-.25*r,-d-1),c[5].set(-.25*r,.75*r,-d-1),a[0][0]=0,a[0][1]=1,a[0][2]=2,a[1][0]=5,a[1][1]=4,a[1][2]=3,a[2][0]=0,a[2][1]=2,a[2][2]=5,a[2][3]=3,a[3][0]=1,a[3][1]=0,a[3][2]=3,a[3][3]=4,a[4][0]=4,a[4][1]=5,a[4][2]=2,a[4][3]=1),o.computeNormals(),o.computeEdges(),o.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(t,e,i,o,n)},v.calculateLocalInertia=function(t,e){return(e=void 0===e?new W:e).set(0,0,0),e},v.volume=function(){return Number.MAX_VALUE},v.calculateWorldAABB=function(t,e,i,o){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),o.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},v.updateBoundingSphereRadius=function(){var t=this.data,e=this.elementSize;this.boundingSphereRadius=new W(t.length*e,t[0].length*e,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).length()},v.setHeightsFromImage=function(t,e){var i=e.x,o=e.z,n=e.y,e=document.createElement("canvas"),e=(e.width=t.width,e.height=t.height,e.getContext("2d")),s=(e.drawImage(t,0,0),e.getImageData(0,0,t.width,t.height)),r=this.data;r.length=0,this.elementSize=Math.abs(i)/s.width;for(var a=0;a<s.height;a++){for(var l=[],h=0;h<s.width;h++){var c=(s.data[4*(a*s.height+h)]+s.data[4*(a*s.height+h)+1]+s.data[4*(a*s.height+h)+2])/4/255*o;i<0?l.push(c):l.unshift(c)}n<0?r.unshift(l):r.push(l)}this.updateMaxValue(),this.updateMinValue(),this.update()},No),Co=[],To=new W,Bo=new W,Mo=new W,zo=new W,Ro=new W,Po=new W,Io=new W,Fo=new W,Lo=new W;function No(t,e){var i;return e=fe.defaults(e=void 0===e?{}:e,{maxValue:null,minValue:null,elementSize:1}),(i=so.call(this,{type:ot.types.HEIGHTFIELD})||this).data=t,i.maxValue=e.maxValue,i.minValue=e.minValue,i.elementSize=e.elementSize,null===e.minValue&&i.updateMinValue(),null===e.maxValue&&i.updateMaxValue(),i.cacheEnabled=!0,i.pillarConvex=new nt,i.pillarOffset=new W,i.updateBoundingSphereRadius(),i._cachedPillars={},i}function Do(){var t;return(t=ro.call(this,{type:ot.types.PLANE})||this).worldNormal=new W,t.worldNormalNeedsUpdate=!0,t.boundingSphereRadius=Number.MAX_VALUE,t}function Vo(){return ao.call(this,{type:ot.types.PARTICLE})||this}function Oo(t,e,i,o){var n=o,s=[],r=[],a=[],l=[],h=[],c=Math.cos,d=Math.sin;s.push(new W(e*c(0),e*d(0),.5*-i)),l.push(0),s.push(new W(t*c(0),t*d(0),.5*i)),h.push(1);for(var u=0;u<n;u++){var p=2*Math.PI/n*(u+1),m=2*Math.PI/n*(u+.5);u<n-1?(s.push(new W(e*c(p),e*d(p),.5*-i)),l.push(2*u+2),s.push(new W(t*c(p),t*d(p),.5*i)),h.push(2*u+3),a.push([2*u+2,2*u+3,2*u+1,2*u])):a.push([0,1,2*u+1,2*u]),(n%2==1||u<n/2)&&r.push(new W(c(m),d(m),0))}a.push(h),r.push(new W(0,0,1));for(var f=[],y=0;y<l.length;y++)f.push(l[l.length-y-1]);return a.push(f),lo.call(this,{vertices:s,faces:a,axes:r})||this}function Ho(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}function qo(t){void 0===t&&(t={}),this.wheelBodies=[],this.coordinateSystem=void 0!==t.coordinateSystem?t.coordinateSystem.clone():new W(1,2,3),t.chassisBody?this.chassisBody=t.chassisBody:this.chassisBody=new K({mass:1,shape:new ct(new W(5,2,.5))}),this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}function _o(t){var e;if((e=ho.call(this,{type:ot.types.SPHERE})||this).radius=void 0!==t?t:1,e.radius<0)throw new Error("The sphere radius cannot be negative.");return e.updateBoundingSphereRadius(),e}(w=g.prototype).reset=function(){this.children.length=this.data.length=0},w.insert=function(t,e,i){void 0===i&&(i=0);var o=this.data;if(!this.aabb.contains(t))return!1;var n=this.children;if(i<(this.maxDepth||this.root.maxDepth)){var s=!1;n.length||(this.subdivide(),s=!0);for(var r=0;8!==r;r++)if(n[r].insert(t,e,i+1))return!0;s&&(n.length=0)}return o.push(e),!0},w.subdivide=function(){var t=this.aabb,e=t.lowerBound,t=t.upperBound,i=this.children;i.push(new g({aabb:new m({lowerBound:new W(0,0,0)})}),new g({aabb:new m({lowerBound:new W(1,0,0)})}),new g({aabb:new m({lowerBound:new W(1,1,0)})}),new g({aabb:new m({lowerBound:new W(1,1,1)})}),new g({aabb:new m({lowerBound:new W(0,1,1)})}),new g({aabb:new m({lowerBound:new W(0,0,1)})}),new g({aabb:new m({lowerBound:new W(1,0,1)})}),new g({aabb:new m({lowerBound:new W(0,1,0)})})),t.vsub(e,Uo),Uo.scale(.5,Uo);for(var o=this.root||this,n=0;8!==n;n++){var s=i[n],r=(s.root=o,s.aabb.lowerBound);r.x*=Uo.x,r.y*=Uo.y,r.z*=Uo.z,r.vadd(e,r),r.vadd(Uo,s.aabb.upperBound)}},w.aabbQuery=function(t,e){this.data,this.children;for(var i=[this];i.length;){var o=i.pop();o.aabb.overlaps(t)&&Array.prototype.push.apply(e,o.data),Array.prototype.push.apply(i,o.children)}return e},w.rayQuery=function(t,e,i){return t.getAABB(Go),Go.toLocalFrame(e,Go),this.aabbQuery(Go,i),i},w.removeEmptyNodes=function(){for(var t=this.children.length-1;0<=t;t--)this.children[t].removeEmptyNodes(),this.children[t].children.length||this.children[t].data.length||this.children.splice(t,1)},e(en,ko=g);var Wo,ko,jo=en,Uo=new W,Go=new m,Yo=(e(tn,Wo=ot),(w=tn.prototype).updateTree=function(){var t=this.tree,e=(t.reset(),t.aabb.copy(this.aabb),this.scale);t.aabb.lowerBound.x*=1/e.x,t.aabb.lowerBound.y*=1/e.y,t.aabb.lowerBound.z*=1/e.z,t.aabb.upperBound.x*=1/e.x,t.aabb.upperBound.y*=1/e.y,t.aabb.upperBound.z*=1/e.z;for(var i=new m,o=new W,n=new W,s=new W,r=[o,n,s],a=0;a<this.indices.length/3;a++){var l=3*a;this._getUnscaledVertex(this.indices[l],o),this._getUnscaledVertex(this.indices[1+l],n),this._getUnscaledVertex(this.indices[2+l],s),i.setFromPoints(r),t.insert(i,a)}t.removeEmptyNodes()},w.getTrianglesInAABB=function(t,e){Qo.copy(t);var t=this.scale,i=t.x,o=t.y,t=t.z,n=Qo.lowerBound,s=Qo.upperBound;return n.x/=i,n.y/=o,n.z/=t,s.x/=i,s.y/=o,s.z/=t,this.tree.aabbQuery(Qo,e)},w.setScale=function(t){var e=this.scale.x===this.scale.y&&this.scale.y===this.scale.z,i=t.x===t.y&&t.y===t.z;e&&i||this.updateNormals(),this.scale.copy(t),this.updateAABB(),this.updateBoundingSphereRadius()},w.updateNormals=function(){for(var t=Xo,e=this.normals,i=0;i<this.indices.length/3;i++){var o=3*i,n=this.indices[o],s=this.indices[1+o],r=this.indices[2+o];this.getVertex(n,sn),this.getVertex(s,rn),this.getVertex(r,an),tn.computeNormal(rn,sn,an,t),e[o]=t.x,e[1+o]=t.y,e[2+o]=t.z}},w.updateEdges=function(){for(var i={},t=function(t,e){i[t<e?t+"_"+e:e+"_"+t]=!0},e=0;e<this.indices.length/3;e++){var o=3*e,n=this.indices[o],s=this.indices[1+o],o=this.indices[2+o];t(n,s),t(s,o),t(o,n)}var r=Object.keys(i);this.edges=new Int16Array(2*r.length);for(var a=0;a<r.length;a++){var l=r[a].split("_");this.edges[2*a]=parseInt(l[0],10),this.edges[2*a+1]=parseInt(l[1],10)}},w.getEdgeVertex=function(t,e,i){t=this.edges[2*t+(e?1:0)];this.getVertex(t,i)},w.getEdgeVector=function(t,e){var i=Zo,o=Ko;this.getEdgeVertex(t,0,i),this.getEdgeVertex(t,1,o),o.vsub(i,e)},w.getVertex=function(t,e){var i=this.scale;return this._getUnscaledVertex(t,e),e.x*=i.x,e.y*=i.y,e.z*=i.z,e},w._getUnscaledVertex=function(t,e){var t=3*t,i=this.vertices;return e.set(i[t],i[1+t],i[2+t])},w.getWorldVertex=function(t,e,i,o){return this.getVertex(t,o),O.pointToWorldFrame(e,i,o,o),o},w.getTriangleVertices=function(t,e,i,o){t*=3;this.getVertex(this.indices[t],e),this.getVertex(this.indices[1+t],i),this.getVertex(this.indices[2+t],o)},w.getNormal=function(t,e){t*=3;return e.set(this.normals[t],this.normals[1+t],this.normals[2+t])},w.calculateLocalInertia=function(t,e){this.computeLocalAABB(ln);var i=ln.upperBound.x-ln.lowerBound.x,o=ln.upperBound.y-ln.lowerBound.y,n=ln.upperBound.z-ln.lowerBound.z;return e.set(1/12*t*(2*o*2*o+2*n*2*n),1/12*t*(2*i*2*i+2*n*2*n),1/12*t*(2*o*2*o+2*i*2*i))},w.computeLocalAABB=function(t){var e=t.lowerBound,i=t.upperBound,o=this.vertices.length,n=(this.vertices,hn);this.getVertex(0,n),e.copy(n),i.copy(n);for(var s=0;s!==o;s++)this.getVertex(s,n),n.x<e.x?e.x=n.x:n.x>i.x&&(i.x=n.x),n.y<e.y?e.y=n.y:n.y>i.y&&(i.y=n.y),n.z<e.z?e.z=n.z:n.z>i.z&&(i.z=n.z)},w.updateAABB=function(){this.computeLocalAABB(this.aabb)},w.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,i=new W,o=0,n=e.length/3;o!==n;o++){this.getVertex(o,i);var s=i.lengthSquared();t<s&&(t=s)}this.boundingSphereRadius=Math.sqrt(t)},w.calculateWorldAABB=function(t,e,i,o){var n=cn,s=dn;n.position=t,n.quaternion=e,this.aabb.toWorldFrame(n,s),i.copy(s.lowerBound),o.copy(s.upperBound)},w.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},tn),Xo=new W,Qo=new m,Zo=new W,Ko=new W,Jo=new W,$o=new W;function tn(t,e){var i;return(i=Wo.call(this,{type:ot.types.TRIMESH})||this).vertices=new Float32Array(t),i.indices=new Int16Array(e),i.normals=new Float32Array(e.length),i.aabb=new m,i.edges=null,i.scale=new W(1,1,1),i.tree=new jo,i.updateEdges(),i.updateNormals(),i.updateAABB(),i.updateBoundingSphereRadius(),i.updateTree(),i}function en(t,e){return void 0===e&&(e={}),(t=ko.call(this,{root:null,aabb:t})||this).maxDepth=void 0!==e.maxDepth?e.maxDepth:8,t}function g(t){this.root=(t=void 0===t?{}:t).root||null,this.aabb=t.aabb?t.aabb.clone():new m,this.data=[],this.children=[]}Yo.computeNormal=function(t,e,i,o){e.vsub(t,$o),i.vsub(e,Jo),Jo.cross($o,o),o.isZero()||o.normalize()};var on,nn,sn=new W,rn=new W,an=new W,ln=new m,hn=new W,cn=new O,dn=new m,w=(Yo.createTorus=function(t,e,i,o,n){void 0===t&&(t=1),void 0===e&&(e=.5),void 0===i&&(i=8),void 0===o&&(o=6),void 0===n&&(n=2*Math.PI);for(var s=[],r=[],a=0;a<=i;a++)for(var l=0;l<=o;l++){var h=l/o*n,c=a/i*Math.PI*2,d=(t+e*Math.cos(c))*Math.cos(h),h=(t+e*Math.cos(c))*Math.sin(h),c=e*Math.sin(c);s.push(d,h,c)}for(var u=1;u<=i;u++)for(var p=1;p<=o;p++){var m=(o+1)*(u-1)+p-1,f=(o+1)*(u-1)+p,y=(o+1)*u+p;r.push((o+1)*u+p-1,m,y),r.push(m,f,y)}return new Yo(s,r)},(w=An.prototype).solve=function(t,e){return 0},w.addEquation=function(t){t.enabled&&this.equations.push(t)},w.removeEquation=function(t){var e=this.equations,t=e.indexOf(t);-1!==t&&e.splice(t,1)},w.removeAllEquations=function(){this.equations.length=0},An),un=(e(En,nn=w),En.prototype.solve=function(t,e){var i,o=0,n=this.iterations,s=this.tolerance*this.tolerance,r=this.equations,a=r.length,l=e.bodies,h=l.length,c=t;if(0!==a)for(var d=0;d!==h;d++)l[d].updateSolveMassProperties();var u=mn,p=fn,m=pn;u.length=a,p.length=a,m.length=a;for(var f=0;f!==a;f++){var y=r[f];m[f]=0,p[f]=y.computeB(c),u[f]=1/y.computeC()}if(0!==a){for(var v=0;v!==h;v++){var g=l[v],w=g.vlambda,g=g.wlambda;w.set(0,0,0),g.set(0,0,0)}for(o=0;o!==n;o++){for(var b=0,x=0;x!==a;x++){var E=r[x],A=p[x],S=u[x];(i=m[x])+(S=S*(A-E.computeGWlambda()-E.eps*i))<E.minForce?S=E.minForce-i:i+S>E.maxForce&&(S=E.maxForce-i),m[x]+=S,b+=0<S?S:-S,E.addToWlambda(S)}if(b*b<s)break}for(var C=0;C!==h;C++){var T=l[C],B=T.velocity,M=T.angularVelocity;T.vlambda.vmul(T.linearFactor,T.vlambda),B.vadd(T.vlambda,B),T.wlambda.vmul(T.angularFactor,T.wlambda),M.vadd(T.wlambda,M)}for(var z=r.length,R=1/c;z--;)r[z].multiplier=m[z]*R}return o},En),pn=[],mn=[],fn=[],yn=(e(xn,on=w),(yn=xn.prototype).createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},yn.solve=function(t,e){for(var i,o=vn,n=this.nodePool,s=e.bodies,r=this.equations,a=r.length,l=s.length,h=this.subsolver;n.length<l;)n.push(this.createNode());o.length=l;for(var c=0;c<l;c++)o[c]=n[c];for(var d=0;d!==l;d++){var u=o[d];u.body=s[d],u.children.length=0,u.eqs.length=0,u.visited=!1}for(var p=0;p!==a;p++){var m=r[p],f=s.indexOf(m.bi),y=s.indexOf(m.bj),f=o[f],y=o[y];f.children.push(y),f.eqs.push(m),y.children.push(f),y.eqs.push(m)}var v=0,g=gn;h.tolerance=this.tolerance,h.iterations=this.iterations;for(var w=wn;i=Sn(o);){g.length=0,w.bodies.length=0,C=S=A=E=x=b=void 0;var b=i,x=Tn,E=w.bodies,A=g;for(Cn.push(b),b.visited=!0,x(b,E,A);Cn.length;)for(var S=Cn.pop(),C=void 0;C=Sn(S.children);)C.visited=!0,x(C,E,A),Cn.push(C);for(var T=g.length,g=g.sort(Bn),B=0;B!==T;B++)h.addEquation(g[B]);h.solve(t,w),h.removeAllEquations(),v++}return v},xn),vn=[],gn=[],wn={bodies:[]},bn=K.STATIC;function xn(t){var e;for((e=on.call(this)||this).iterations=10,e.tolerance=1e-7,e.subsolver=t,e.nodes=[],e.nodePool=[];e.nodePool.length<128;)e.nodePool.push(e.createNode());return e}function En(){var t;return(t=nn.call(this)||this).iterations=10,t.tolerance=1e-7,t}function An(){this.equations=[]}function Sn(t){for(var e=t.length,i=0;i!==e;i++){var o=t[i];if(!(o.visited||o.body.type&bn))return o}return!1}var Cn=[];function Tn(t,e,i){e.push(t.body);for(var o=t.eqs.length,n=0;n!==o;n++){var s=t.eqs[n];i.includes(s)||i.push(s)}}function Bn(t,e){return e.id-t.id}(zn=qn.prototype).release=function(){for(var t=arguments.length,e=0;e!==t;e++)this.objects.push(e<0||arguments.length<=e?void 0:arguments[e]);return this},zn.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},zn.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")},zn.resize=function(t){for(var e=this.objects;e.length>t;)e.pop();for(;e.length<t;)e.push(this.constructObject());return this};var Mn,zn=qn,Rn=(e(Hn,Mn=zn),Hn.prototype.constructObject=function(){return new W},Hn),b={sphereSphere:ot.types.SPHERE,spherePlane:ot.types.SPHERE|ot.types.PLANE,boxBox:ot.types.BOX|ot.types.BOX,sphereBox:ot.types.SPHERE|ot.types.BOX,planeBox:ot.types.PLANE|ot.types.BOX,convexConvex:ot.types.CONVEXPOLYHEDRON,sphereConvex:ot.types.SPHERE|ot.types.CONVEXPOLYHEDRON,planeConvex:ot.types.PLANE|ot.types.CONVEXPOLYHEDRON,boxConvex:ot.types.BOX|ot.types.CONVEXPOLYHEDRON,sphereHeightfield:ot.types.SPHERE|ot.types.HEIGHTFIELD,boxHeightfield:ot.types.BOX|ot.types.HEIGHTFIELD,convexHeightfield:ot.types.CONVEXPOLYHEDRON|ot.types.HEIGHTFIELD,sphereParticle:ot.types.PARTICLE|ot.types.SPHERE,planeParticle:ot.types.PLANE|ot.types.PARTICLE,boxParticle:ot.types.BOX|ot.types.PARTICLE,convexParticle:ot.types.PARTICLE|ot.types.CONVEXPOLYHEDRON,sphereTrimesh:ot.types.SPHERE|ot.types.TRIMESH,planeTrimesh:ot.types.PLANE|ot.types.TRIMESH},x=((E=On.prototype).createContactEquation=function(t,e,i,o,n,s){this.contactPointPool.length?((r=this.contactPointPool.pop()).bi=t,r.bj=e):r=new Oe(t,e),r.enabled=t.collisionResponse&&e.collisionResponse&&i.collisionResponse&&o.collisionResponse;var r,a=this.currentContactMaterial,a=(r.restitution=a.restitution,r.setSpookParams(a.contactEquationStiffness,a.contactEquationRelaxation,this.world.dt),i.material||t.material),t=o.material||e.material;return a&&t&&0<=a.restitution&&0<=t.restitution&&(r.restitution=a.restitution*t.restitution),r.si=n||i,r.sj=s||o,r},E.createFrictionEquationsFromContact=function(t,e){var i,o=t.bi,n=t.bj,s=this.world,r=this.currentContactMaterial,a=r.friction,l=t.si.material||o.material,h=t.sj.material||n.material;return 0<(a=l&&h&&0<=l.friction&&0<=h.friction?l.friction*h.friction:a)&&(l=a*s.gravity.length(),0<(h=o.invMass+n.invMass)&&(h=1/h),i=(a=this.frictionEquationPool).length?a.pop():new ai(o,n,l*h),a=a.length?a.pop():new ai(o,n,l*h),i.bi=a.bi=o,i.bj=a.bj=n,i.minForce=a.minForce=-l*h,i.maxForce=a.maxForce=l*h,i.ri.copy(t.ri),i.rj.copy(t.rj),a.ri.copy(t.ri),a.rj.copy(t.rj),t.ni.tangents(i.t,a.t),i.setSpookParams(r.frictionEquationStiffness,r.frictionEquationRelaxation,s.dt),a.setSpookParams(r.frictionEquationStiffness,r.frictionEquationRelaxation,s.dt),i.enabled=a.enabled=t.enabled,e.push(i,a),!0)},E.createFrictionFromAverage=function(t){var e=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(e,this.frictionResult)&&1!==t){var i=this.frictionResult[this.frictionResult.length-2],o=this.frictionResult[this.frictionResult.length-1];Pn.setZero(),In.setZero(),Fn.setZero();for(var n=e.bi,s=(e.bj,0);s!==t;s++)(e=this.result[this.result.length-1-s]).bi!==n?(Pn.vadd(e.ni,Pn),In.vadd(e.ri,In),Fn.vadd(e.rj,Fn)):(Pn.vsub(e.ni,Pn),In.vadd(e.rj,In),Fn.vadd(e.ri,Fn));var r=1/t;In.scale(r,i.ri),Fn.scale(r,i.rj),o.ri.copy(i.ri),o.rj.copy(i.rj),Pn.normalize(),Pn.tangents(i.t,o.t)}},E.getContacts=function(t,e,i,o,n,s,r){this.contactPointPool=n,this.frictionEquationPool=r,this.result=o,this.frictionResult=s;for(var a=Dn,l=Vn,h=Ln,c=Nn,d=0,u=t.length;d!==u;d++){var p=t[d],m=e[d],f=null;p.material&&m.material&&(f=i.getContactMaterial(p.material,m.material)||null);for(var y=p.type&K.KINEMATIC&&m.type&K.STATIC||p.type&K.STATIC&&m.type&K.KINEMATIC||p.type&K.KINEMATIC&&m.type&K.KINEMATIC,v=0;v<p.shapes.length;v++){p.quaternion.mult(p.shapeOrientations[v],a),p.quaternion.vmult(p.shapeOffsets[v],h),h.vadd(p.position,h);for(var g=p.shapes[v],w=0;w<m.shapes.length;w++){m.quaternion.mult(m.shapeOrientations[w],l),m.quaternion.vmult(m.shapeOffsets[w],c),c.vadd(m.position,c);var b,x=m.shapes[w];g.collisionFilterMask&x.collisionFilterGroup&&x.collisionFilterMask&g.collisionFilterGroup&&!(h.distanceTo(c)>g.boundingSphereRadius+x.boundingSphereRadius)&&(b=null,g.material&&x.material&&(b=i.getContactMaterial(g.material,x.material)||null),this.currentContactMaterial=b||f||i.defaultContactMaterial,b=this[g.type|x.type])&&(g.type<x.type?b.call(this,g,x,h,c,a,l,p,m,g,x,y):b.call(this,x,g,c,h,l,a,m,p,g,x,y))&&y&&(i.shapeOverlapKeeper.set(g.id,x.id),i.bodyOverlapKeeper.set(p.id,m.id))}}}},E.sphereSphere=function(t,e,i,o,n,s,r,a,l,h,c){if(c)return i.distanceSquared(o)<Math.pow(t.radius+e.radius,2);c=this.createContactEquation(r,a,t,e,l,h);o.vsub(i,c.ni),c.ni.normalize(),c.ri.copy(c.ni),c.rj.copy(c.ni),c.ri.scale(t.radius,c.ri),c.rj.scale(-e.radius,c.rj),c.ri.vadd(i,c.ri),c.ri.vsub(r.position,c.ri),c.rj.vadd(o,c.rj),c.rj.vsub(a.position,c.rj),this.result.push(c),this.createFrictionEquationsFromContact(c,this.frictionResult)},E.spherePlane=function(t,e,i,o,n,s,r,a,l,h,c){e=this.createContactEquation(r,a,t,e,l,h);if(e.ni.set(0,0,1),s.vmult(e.ni,e.ni),e.ni.negate(e.ni),e.ni.normalize(),e.ni.scale(t.radius,e.ri),i.vsub(o,ss),e.ni.scale(e.ni.dot(ss),rs),ss.vsub(rs,e.rj),-ss.dot(e.ni)<=t.radius){if(c)return!0;l=e.ri,h=e.rj;l.vadd(i,l),l.vsub(r.position,l),h.vadd(o,h),h.vsub(a.position,h),this.result.push(e),this.createFrictionEquationsFromContact(e,this.frictionResult)}},E.boxBox=function(t,e,i,o,n,s,r,a,l,h,c){return t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e.convexPolyhedronRepresentation,i,o,n,s,r,a,t,e,c)},E.sphereBox=function(t,e,i,o,D,n,s,r,a,l,h){var c=this.v3pool,d=ms;i.vsub(o,cs),e.getSideNormals(d,n);for(var u=t.radius,p=!1,m=ys,f=vs,y=gs,V=null,O=0,H=0,q=0,v=null,g=0,_=d.length;g!==_&&!1===p;g++){var w=ds,b=(w.copy(d[g]),w.length()),W=(w.normalize(),cs.dot(w));if(W<b+u&&0<W){var x=us,E=ps,A=(x.copy(d[(g+1)%3]),E.copy(d[(g+2)%3]),x.length()),k=E.length(),j=(x.normalize(),E.normalize(),cs.dot(x)),U=cs.dot(E);if(j<A&&-A<j&&U<k&&-k<U){A=Math.abs(W-b-u);if((null===v||A<v)&&(v=A,H=j,q=U,V=b,m.copy(w),f.copy(x),y.copy(E),O++,h))return!0}}}O&&(p=!0,n=this.createContactEquation(s,r,t,e,a,l),m.scale(-u,n.ri),n.ni.copy(m),n.ni.negate(n.ni),m.scale(V,m),f.scale(H,f),m.vadd(f,m),y.scale(q,y),m.vadd(y,n.rj),n.ri.vadd(i,n.ri),n.ri.vsub(s.position,n.ri),n.rj.vadd(o,n.rj),n.rj.vsub(r.position,n.rj),this.result.push(n),this.createFrictionEquationsFromContact(n,this.frictionResult));for(var S=c.get(),C=fs,G=0;2!==G&&!p;G++)for(var Y=0;2!==Y&&!p;Y++)for(var X=0;2!==X&&!p;X++)if(S.set(0,0,0),G?S.vadd(d[0],S):S.vsub(d[0],S),Y?S.vadd(d[1],S):S.vsub(d[1],S),X?S.vadd(d[2],S):S.vsub(d[2],S),o.vadd(S,C),C.vsub(i,C),C.lengthSquared()<u*u){if(h)return!0;p=!0;var T=this.createContactEquation(s,r,t,e,a,l);T.ri.copy(C),T.ri.normalize(),T.ni.copy(T.ri),T.ri.scale(u,T.ri),T.rj.copy(S),T.ri.vadd(i,T.ri),T.ri.vsub(s.position,T.ri),T.rj.vadd(o,T.rj),T.rj.vsub(r.position,T.rj),this.result.push(T),this.createFrictionEquationsFromContact(T,this.frictionResult)}c.release(S);for(var S=null,B=c.get(),M=c.get(),z=c.get(),R=c.get(),P=c.get(),Q=d.length,I=0;I!==Q&&!p;I++)for(var F=0;F!==Q&&!p;F++)if(I%3!=F%3){d[F].cross(d[I],B),B.normalize(),d[I].vadd(d[F],M),z.copy(i),z.vsub(M,z),z.vsub(o,z);var L=z.dot(B);B.scale(L,R);for(var N=0;N===I%3||N===F%3;)N++;P.copy(i),P.vsub(R,P),P.vsub(M,P),P.vsub(o,P);var L=Math.abs(L),Z=P.length();if(L<d[N].length()&&Z<u){if(h)return!0;p=!0;L=this.createContactEquation(s,r,t,e,a,l);M.vadd(R,L.rj),L.rj.copy(L.rj),P.negate(L.ni),L.ni.normalize(),L.ri.copy(L.rj),L.ri.vadd(o,L.ri),L.ri.vsub(i,L.ri),L.ri.normalize(),L.ri.scale(u,L.ri),L.ri.vadd(i,L.ri),L.ri.vsub(s.position,L.ri),L.rj.vadd(o,L.rj),L.rj.vsub(r.position,L.rj),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult)}}c.release(B,M,z,R,P)},E.planeBox=function(t,e,i,o,n,s,r,a,l,h,c){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,e.convexPolyhedronRepresentation.id=e.id,this.planeConvex(t,e.convexPolyhedronRepresentation,i,o,n,s,r,a,t,e,c)},E.convexConvex=function(t,e,i,o,n,s,r,a,l,h,c,d,u){var p=Fs;if(!(i.distanceTo(o)>t.boundingSphereRadius+e.boundingSphereRadius)&&t.findSeparatingAxis(e,i,n,o,s,p,d,u)){var m=[],f=Ls;t.clipAgainstHull(i,n,e,o,s,p,-100,100,m);for(var y=0,v=0;v!==m.length;v++){if(c)return!0;var g=this.createContactEquation(r,a,t,e,l,h),w=g.ri,b=g.rj;p.negate(g.ni),m[v].normal.negate(f),f.scale(m[v].depth,f),m[v].point.vadd(f,w),b.copy(m[v].point),w.vsub(i,w),b.vsub(o,b),w.vadd(i,w),w.vsub(r.position,w),b.vadd(o,b),b.vsub(a.position,b),this.result.push(g),y++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(g,this.frictionResult)}this.enableFrictionReduction&&y&&this.createFrictionFromAverage(y)}},E.sphereConvex=function(t,e,i,o,D,n,s,r,a,l,h){var c=this.v3pool;i.vsub(o,ws);for(var V=e.faceNormals,O=e.faces,d=e.vertices,u=t.radius,p=!1,m=0;m!==d.length;m++){var f,y=d[m],v=As,y=(n.vmult(y,v),o.vadd(v,v),Es);if(v.vsub(i,y),y.lengthSquared()<u*u)return!!h||(p=!0,(f=this.createContactEquation(s,r,t,e,a,l)).ri.copy(y),f.ri.normalize(),f.ni.copy(f.ri),f.ri.scale(u,f.ri),v.vsub(o,f.rj),f.ri.vadd(i,f.ri),f.ri.vsub(s.position,f.ri),f.rj.vadd(o,f.rj),f.rj.vsub(r.position,f.rj),this.result.push(f),void this.createFrictionEquationsFromContact(f,this.frictionResult))}for(var g=0,H=O.length;g!==H&&!1===p;g++){var w=V[g],b=O[g],x=Ss,w=(n.vmult(w,x),Cs),E=(n.vmult(d[b[0]],w),w.vadd(o,w),Ts),A=(x.scale(-u,E),i.vadd(E,E),Bs),E=(E.vsub(w,A),A.dot(x)),A=Ms;if(i.vsub(w,A),E<0&&0<A.dot(x)){for(var S=[],C=0,q=b.length;C!==q;C++){var T=c.get();n.vmult(d[b[C]],T),o.vadd(T,T),S.push(T)}if(((t,e,i)=>{for(var o=null,n=t.length,s=0;s!==n;s++){var r=t[s],a=as,l=(t[(s+1)%n].vsub(r,a),ls),a=(a.cross(e,l),hs),r=(i.vsub(r,a),l.dot(a));if(!(null===o||0<r&&!0===o||r<=0&&!1===o))return;null===o&&(o=0<r)}return 1})(S,x,i)){if(h)return!0;p=!0;w=this.createContactEquation(s,r,t,e,a,l),A=(x.scale(-u,w.ri),x.negate(w.ni),c.get()),E=(x.scale(-E,A),c.get());x.scale(-u,E),i.vsub(o,w.rj),w.rj.vadd(E,w.rj),w.rj.vadd(A,w.rj),w.rj.vadd(o,w.rj),w.rj.vsub(r.position,w.rj),w.ri.vadd(i,w.ri),w.ri.vsub(s.position,w.ri),c.release(A),c.release(E),this.result.push(w),this.createFrictionEquationsFromContact(w,this.frictionResult);for(var B=0,_=S.length;B!==_;B++)c.release(S[B]);return}for(var M=0;M!==b.length;M++){var z=c.get(),R=c.get(),P=(n.vmult(d[b[(M+1)%b.length]],z),n.vmult(d[b[(M+2)%b.length]],R),o.vadd(z,z),o.vadd(R,R),bs),I=(R.vsub(z,P),xs),F=(P.unit(I),c.get()),L=c.get(),N=(i.vsub(z,L),L.dot(I)),I=(I.scale(N,F),F.vadd(z,F),c.get());if(F.vsub(i,I),0<N&&N*N<P.lengthSquared()&&I.lengthSquared()<u*u){if(h)return!0;N=this.createContactEquation(s,r,t,e,a,l);F.vsub(o,N.rj),F.vsub(i,N.ni),N.ni.normalize(),N.ni.scale(u,N.ri),N.rj.vadd(o,N.rj),N.rj.vsub(r.position,N.rj),N.ri.vadd(i,N.ri),N.ri.vsub(s.position,N.ri),this.result.push(N),this.createFrictionEquationsFromContact(N,this.frictionResult);for(var W=0,k=S.length;W!==k;W++)c.release(S[W]);return c.release(z),c.release(R),c.release(F),c.release(I),void c.release(L)}c.release(z),c.release(R),c.release(F),c.release(I),c.release(L)}for(var j=0,U=S.length;j!==U;j++)c.release(S[j])}}},E.planeConvex=function(t,e,i,o,n,s,r,a,l,h,c){var d=zs,u=Rs;u.set(0,0,1),n.vmult(u,u);for(var p=0,m=Ps,f=0;f!==e.vertices.length;f++)if(d.copy(e.vertices[f]),s.vmult(d,d),o.vadd(d,d),d.vsub(i,m),u.dot(m)<=0){if(c)return!0;var y=this.createContactEquation(r,a,t,e,l,h),v=Is;u.scale(u.dot(m),v),d.vsub(v,v),v.vsub(i,y.ri),y.ni.copy(u),d.vsub(o,y.rj),y.ri.vadd(i,y.ri),y.ri.vsub(r.position,y.ri),y.rj.vadd(o,y.rj),y.rj.vsub(a.position,y.rj),this.result.push(y),p++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(y,this.frictionResult)}this.enableFrictionReduction&&p&&this.createFrictionFromAverage(p)},E.boxConvex=function(t,e,i,o,n,s,r,a,l,h,c){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e,i,o,n,s,r,a,t,e,c)},E.sphereHeightfield=function(t,e,i,o,n,s,r,a,l,h,c){var d=e.data,u=t.radius,p=e.elementSize,m=Xs,f=Ys,y=(O.pointToLocalFrame(o,s,i,f),Math.floor((f.x-u)/p)-1),v=Math.ceil((f.x+u)/p)+1,g=Math.floor((f.y-u)/p)-1,w=Math.ceil((f.y+u)/p)+1;if(!(v<0||w<0||y>d.length||g>d[0].length)){(y=y<0?0:y)>=d.length&&(y=d.length-1),(v=v<0?0:v)>=d.length&&(v=d.length-1),(w=w<0?0:w)>=d[0].length&&(w=d[0].length-1),(g=g<0?0:g)>=d[0].length&&(g=d[0].length-1);p=[],d=(e.getRectMinMax(y,g,v,w,p),p[0]);if(!(f.z-u>p[1]||f.z+u<d))for(var b=this.result,x=y;x<v;x++)for(var E=g;E<w;E++){var A=b.length,S=!1;if(e.getConvexTrianglePillar(x,E,!1),O.pointToWorldFrame(o,s,e.pillarOffset,m),i.distanceTo(m)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(S=this.sphereConvex(t,e.pillarConvex,i,m,n,s,r,a,t,e,c)),c&&S)return!0;if(e.getConvexTrianglePillar(x,E,!0),O.pointToWorldFrame(o,s,e.pillarOffset,m),i.distanceTo(m)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(S=this.sphereConvex(t,e.pillarConvex,i,m,n,s,r,a,t,e,c)),c&&S)return!0;if(2<b.length-A)return}}},E.boxHeightfield=function(t,e,i,o,n,s,r,a,l,h,c){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexHeightfield(t.convexPolyhedronRepresentation,e,i,o,n,s,r,a,t,e,c)},E.convexHeightfield=function(t,e,i,o,n,s,r,a,l,h,c){var d=e.data,u=e.elementSize,p=t.boundingSphereRadius,m=Us,f=Gs,y=js,v=(O.pointToLocalFrame(o,s,i,y),Math.floor((y.x-p)/u)-1),g=Math.ceil((y.x+p)/u)+1,w=Math.floor((y.y-p)/u)-1,b=Math.ceil((y.y+p)/u)+1;if(!(g<0||b<0||v>d.length||w>d[0].length)){(v=v<0?0:v)>=d.length&&(v=d.length-1),(g=g<0?0:g)>=d.length&&(g=d.length-1),(b=b<0?0:b)>=d[0].length&&(b=d[0].length-1),(w=w<0?0:w)>=d[0].length&&(w=d[0].length-1);u=[],d=(e.getRectMinMax(v,w,g,b,u),u[0]);if(!(y.z-p>u[1]||y.z+p<d))for(var x=v;x<g;x++)for(var E=w;E<b;E++){var A=!1;if(e.getConvexTrianglePillar(x,E,!1),O.pointToWorldFrame(o,s,e.pillarOffset,m),i.distanceTo(m)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(A=this.convexConvex(t,e.pillarConvex,i,m,n,s,r,a,null,null,c,f,null)),c&&A)return!0;if(e.getConvexTrianglePillar(x,E,!0),O.pointToWorldFrame(o,s,e.pillarOffset,m),i.distanceTo(m)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(A=this.convexConvex(t,e.pillarConvex,i,m,n,s,r,a,null,null,c,f,null)),c&&A)return!0}}},E.sphereParticle=function(t,e,i,o,n,s,r,a,l,h,c){var d=Os;if(d.set(0,0,1),o.vsub(i,d),d.lengthSquared()<=t.radius*t.radius){if(c)return!0;o=this.createContactEquation(a,r,e,t,l,h);d.normalize(),o.rj.copy(d),o.rj.scale(t.radius,o.rj),o.ni.copy(d),o.ni.negate(o.ni),o.ri.set(0,0,0),this.result.push(o),this.createFrictionEquationsFromContact(o,this.frictionResult)}},E.planeParticle=function(t,e,i,o,n,s,r,a,l,h,c){var d=Ns,u=(d.set(0,0,1),r.quaternion.vmult(d,d),Ds);if(o.vsub(r.position,u),d.dot(u)<=0){if(c)return!0;u=this.createContactEquation(a,r,e,t,l,h),c=(u.ni.copy(d),u.ni.negate(u.ni),u.ri.set(0,0,0),Vs);d.scale(d.dot(o),c),o.vsub(c,c),u.rj.copy(c),this.result.push(u),this.createFrictionEquationsFromContact(u,this.frictionResult)}},E.boxParticle=function(t,e,i,o,n,s,r,a,l,h,c){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexParticle(t.convexPolyhedronRepresentation,e,i,o,n,s,r,a,t,e,c)},E.convexParticle=function(t,e,i,o,n,s,r,a,l,h,c){var d=-1,u=_s,p=ks,m=null,f=qs;if(f.copy(o),f.vsub(i,f),n.conjugate(Hs),Hs.vmult(f,f),t.pointIsInside(f)){t.worldVerticesNeedsUpdate&&t.computeWorldVertices(i,n),t.worldFaceNormalsNeedsUpdate&&t.computeWorldFaceNormals(n);for(var y=0,v=t.faces.length;y!==v;y++){var g=[t.worldVertices[t.faces[y][0]]],w=t.worldFaceNormals[y],g=(o.vsub(g[0],Ws),-w.dot(Ws));if(null===m||Math.abs(g)<Math.abs(m)){if(c)return!0;m=g,d=y,u.copy(w)}}-1!==d?(f=this.createContactEquation(a,r,e,t,l,h),u.scale(m,p),p.vadd(o,p),p.vsub(i,p),f.rj.copy(p),u.negate(f.ni),f.ri.set(0,0,0),n=f.ri,e=f.rj,n.vadd(o,n),n.vsub(a.position,n),e.vadd(i,e),e.vsub(r.position,e),this.result.push(f),this.createFrictionEquationsFromContact(f,this.frictionResult)):console.warn("Point found inside convex, but did not find penetrating face!")}},E.sphereTrimesh=function(t,e,i,o,D,n,s,r,a,l,h){var c=Xn,d=Qn,u=Zn,p=Kn,m=Jn,f=$n,y=os,v=Yn,g=Un,w=ns,b=(O.pointToLocalFrame(o,n,i,m),t.radius);y.lowerBound.set(m.x-b,m.y-b,m.z-b),y.upperBound.set(m.x+b,m.y+b,m.z+b),e.getTrianglesInAABB(y,w);for(var x=Gn,E=t.radius*t.radius,A=0;A<w.length;A++)for(var S=0;S<3;S++)if(e.getVertex(e.indices[3*w[A]+S],x),x.vsub(m,g),g.lengthSquared()<=E){if(v.copy(x),O.pointToWorldFrame(o,n,v,x),x.vsub(i,g),h)return!0;var C=this.createContactEquation(s,r,t,e,a,l);C.ni.copy(g),C.ni.normalize(),C.ri.copy(C.ni),C.ri.scale(t.radius,C.ri),C.ri.vadd(i,C.ri),C.ri.vsub(s.position,C.ri),C.rj.copy(x),C.rj.vsub(r.position,C.rj),this.result.push(C),this.createFrictionEquationsFromContact(C,this.frictionResult)}for(var T=0;T<w.length;T++)for(var B=0;B<3;B++){e.getVertex(e.indices[3*w[T]+B],c),e.getVertex(e.indices[3*w[T]+(B+1)%3],d),d.vsub(c,u),m.vsub(d,f);var M=f.dot(u),z=(m.vsub(c,f),f.dot(u));if(0<z&&M<0&&(m.vsub(c,f),p.copy(u),p.normalize(),z=f.dot(p),p.scale(z,f),f.vadd(c,f),f.distanceTo(m)<t.radius)){if(h)return!0;M=this.createContactEquation(s,r,t,e,a,l);f.vsub(m,M.ni),M.ni.normalize(),M.ni.scale(t.radius,M.ri),M.ri.vadd(i,M.ri),M.ri.vsub(s.position,M.ri),O.pointToWorldFrame(o,n,f,f),f.vsub(r.position,M.rj),O.vectorToWorldFrame(n,M.ni,M.ni),O.vectorToWorldFrame(n,M.ri,M.ri),this.result.push(M),this.createFrictionEquationsFromContact(M,this.frictionResult)}}for(var R=ts,P=es,I=is,F=jn,L=0,V=w.length;L!==V;L++){e.getTriangleVertices(w[L],R,P,I),e.getNormal(w[L],F),m.vsub(R,f);var N=f.dot(F);if(F.scale(N,f),m.vsub(f,f),N=f.distanceTo(m),H.pointInTriangle(f,R,P,I)&&N<t.radius){if(h)return!0;N=this.createContactEquation(s,r,t,e,a,l);f.vsub(m,N.ni),N.ni.normalize(),N.ni.scale(t.radius,N.ri),N.ri.vadd(i,N.ri),N.ri.vsub(s.position,N.ri),O.pointToWorldFrame(o,n,f,f),f.vsub(r.position,N.rj),O.vectorToWorldFrame(n,N.ni,N.ni),O.vectorToWorldFrame(n,N.ri,N.ri),this.result.push(N),this.createFrictionEquationsFromContact(N,this.frictionResult)}}w.length=0},E.planeTrimesh=function(t,e,i,o,n,s,r,a,l,h,c){var d=new W,u=_n;u.set(0,0,1),n.vmult(u,u);for(var p=0;p<e.vertices.length/3;p++){e.getVertex(p,d);var m=new W,m=(m.copy(d),O.pointToWorldFrame(o,s,m,d),Wn);if(d.vsub(i,m),u.dot(m)<=0){if(c)return!0;var f=this.createContactEquation(r,a,t,e,l,h),y=(f.ni.copy(u),kn);u.scale(m.dot(u),y),d.vsub(y,y),f.ri.copy(y),f.ri.vsub(r.position,f.ri),f.rj.copy(d),f.rj.vsub(a.position,f.rj),this.result.push(f),this.createFrictionEquationsFromContact(f,this.frictionResult)}}},On),Pn=new W,In=new W,Fn=new W,Ln=new W,Nn=new W,Dn=new s,Vn=new s;function On(t){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new Rn,this.world=t,this.currentContactMaterial=t.defaultContactMaterial,this.enableFrictionReduction=!1}function Hn(){var t;return(t=Mn.call(this)||this).type=W,t}function qn(){this.objects=[],this.type=Object}x.prototype[b.boxBox]=x.prototype.boxBox,x.prototype[b.boxConvex]=x.prototype.boxConvex,x.prototype[b.boxParticle]=x.prototype.boxParticle,x.prototype[b.sphereSphere]=x.prototype.sphereSphere;var _n=new W,Wn=new W,kn=new W,jn=(x.prototype[b.planeTrimesh]=x.prototype.planeTrimesh,new W),Un=new W,Gn=(new W,new W),Yn=new W,Xn=new W,Qn=new W,Zn=new W,Kn=new W,Jn=new W,$n=new W,ts=new W,es=new W,is=new W,os=new m,ns=[],ss=(x.prototype[b.sphereTrimesh]=x.prototype.sphereTrimesh,new W),rs=new W,as=(x.prototype[b.spherePlane]=x.prototype.spherePlane,new W),ls=new W,hs=new W;var cs=new W,ds=new W,us=new W,ps=new W,ms=[new W,new W,new W,new W,new W,new W],fs=new W,ys=new W,vs=new W,gs=new W,ws=(x.prototype[b.sphereBox]=x.prototype.sphereBox,new W),bs=new W,xs=new W,Es=new W,As=new W,Ss=new W,Cs=new W,Ts=new W,Bs=new W,Ms=new W,zs=(x.prototype[b.sphereConvex]=x.prototype.sphereConvex,new W,new W,x.prototype[b.planeBox]=x.prototype.planeBox,new W),Rs=new W,Ps=new W,Is=new W,Fs=(x.prototype[b.planeConvex]=x.prototype.planeConvex,new W),Ls=new W,Ns=(x.prototype[b.convexConvex]=x.prototype.convexConvex,new W),Ds=new W,Vs=new W,Os=(x.prototype[b.planeParticle]=x.prototype.planeParticle,new W),Hs=(x.prototype[b.sphereParticle]=x.prototype.sphereParticle,new s),qs=new W,_s=(new W,new W),Ws=new W,ks=new W,js=(x.prototype[b.convexParticle]=x.prototype.convexParticle,x.prototype[b.boxHeightfield]=x.prototype.boxHeightfield,new W),Us=new W,Gs=[0],Ys=(x.prototype[b.convexHeightfield]=x.prototype.convexHeightfield,new W),Xs=new W,Qs=(x.prototype[b.sphereHeightfield]=x.prototype.sphereHeightfield,(E=Zs.prototype).getKey=function(t,e){var i;return e<t&&(i=e,e=t,t=i),t<<16|e},E.set=function(t,e){for(var i=this.getKey(t,e),o=this.current,n=0;i>o[n];)n++;if(i!==o[n]){for(var s=o.length-1;n<=s;s--)o[s+1]=o[s];o[n]=i}},E.tick=function(){var t=this.current;this.current=this.previous,this.previous=t,this.current.length=0},E.getDiff=function(t,e){for(var i=this.current,o=this.previous,n=i.length,s=o.length,r=0,a=0;a<n;a++){for(var l=i[a];l>o[r];)r++;l!==o[r]&&Ks(t,l)}for(var r=0,h=0;h<s;h++){for(var c=o[h];c>i[r];)r++;i[r]!==c&&Ks(e,c)}},Zs);function Zs(){this.current=[],this.previous=[]}function Ks(t,e){t.push((4294901760&e)>>16,65535&e)}(E=or.prototype).get=function(t,e){var i;return e<t&&(i=e,e=t,t=i),this.data[t+"-"+e]},E.set=function(t,e,i){e<t&&(o=e,e=t,t=o);var o=t+"-"+e;this.get(t,e)||this.data.keys.push(o),this.data[o]=i},E.reset=function(){for(var t=this.data,e=t.keys;0<e.length;)delete t[e.pop()]};var Js,$s,tr=or,E=(e(ir,Js=i),(E=ir.prototype).getContactMaterial=function(t,e){return this.contactMaterialTable.get(t.id,e.id)},E.numObjects=function(){return this.bodies.length},E.collisionMatrixTick=function(){var t=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=t,this.collisionMatrix.reset(),this.bodyOverlapKeeper.tick(),this.shapeOverlapKeeper.tick()},E.addConstraint=function(t){this.constraints.push(t)},E.removeConstraint=function(t){t=this.constraints.indexOf(t);-1!==t&&this.constraints.splice(t,1)},E.rayTest=function(t,e,i){i instanceof Vt?this.raycastClosest(t,e,{skipBackfaces:!0},i):this.raycastAll(t,e,{skipBackfaces:!0},i)},E.raycastAll=function(t,e,i,o){return(i=void 0===i?{}:i).mode=H.ALL,i.from=t,i.to=e,i.callback=o,er.intersectWorld(this,i)},E.raycastAny=function(t,e,i,o){return(i=void 0===i?{}:i).mode=H.ANY,i.from=t,i.to=e,i.result=o,er.intersectWorld(this,i)},E.raycastClosest=function(t,e,i,o){return(i=void 0===i?{}:i).mode=H.CLOSEST,i.from=t,i.to=e,i.result=o,er.intersectWorld(this,i)},E.addBody=function(t){this.bodies.includes(t)||(t.index=this.bodies.length,this.bodies.push(t),t.world=this,t.initPosition.copy(t.position),t.initVelocity.copy(t.velocity),t.timeLastSleepy=this.time,t instanceof K&&(t.initAngularVelocity.copy(t.angularVelocity),t.initQuaternion.copy(t.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=t,this.idToBodyMap[t.id]=t,this.dispatchEvent(this.addBodyEvent))},E.removeBody=function(t){t.world=null;var e=this.bodies.length-1,i=this.bodies,o=i.indexOf(t);if(-1!==o){i.splice(o,1);for(var n=0;n!==i.length;n++)i[n].index=n;this.collisionMatrix.setNumObjects(e),this.removeBodyEvent.body=t,delete this.idToBodyMap[t.id],this.dispatchEvent(this.removeBodyEvent)}},E.getBodyById=function(t){return this.idToBodyMap[t]},E.getShapeById=function(t){for(var e=this.bodies,i=0,o=e.length;i<o;i++)for(var n=e[i].shapes,s=0,r=n.length;s<r;s++){var a=n[s];if(a.id===t)return a}},E.addMaterial=function(t){this.materials.push(t)},E.addContactMaterial=function(t){this.contactmaterials.push(t),this.contactMaterialTable.set(t.materials[0].id,t.materials[1].id,t)},E.step=function(t,e,i){if(void 0===i&&(i=10),0===(e=void 0===e?0:e))this.internalStep(t),this.time+=t;else{this.accumulator+=e;for(var o=0;this.accumulator>=t&&o<i;)this.internalStep(t),this.accumulator-=t,o++;for(var n=this.accumulator%t/t,s=0;s!==this.bodies.length;s++){var r=this.bodies[s];r.previousPosition.lerp(r.position,n,r.interpolatedPosition),r.previousQuaternion.slerp(r.quaternion,n,r.interpolatedQuaternion),r.previousQuaternion.normalize()}this.time+=e}},E.internalStep=function(t){this.dt=t;var e=this.contacts,i=dr,o=ur,n=this.numObjects(),s=this.bodies,r=this.solver,a=this.gravity,l=this.doProfiling,h=this.profile,c=K.DYNAMIC,d=-1/0,u=this.constraints,p=cr,D=(a.length(),a.x),V=a.y,O=a.z,m=0;for(l&&(d=performance.now()),m=0;m!==n;m++){var f,y=s[m];y.type===c&&(f=y.force,y=y.mass,f.x+=y*D,f.y+=y*V,f.z+=y*O)}for(var v=0,H=this.subsystems.length;v!==H;v++)this.subsystems[v].update();l&&(d=performance.now()),i.length=0,o.length=0,this.broadphase.collisionPairs(this,i,o),l&&(h.broadphase=performance.now()-d);for(var g=u.length,m=0;m!==g;m++){var w=u[m];if(!w.collideConnected)for(var b=i.length-1;0<=b;--b)(w.bodyA===i[b]&&w.bodyB===o[b]||w.bodyB===i[b]&&w.bodyA===o[b])&&(i.splice(b,1),o.splice(b,1))}this.collisionMatrixTick(),l&&(d=performance.now());var x=hr,q=e.length;for(m=0;m!==q;m++)x.push(e[m]);e.length=0;var _=this.frictionEquations.length;for(m=0;m!==_;m++)p.push(this.frictionEquations[m]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(i,o,this,e,x,this.frictionEquations,p),l&&(h.narrowphase=performance.now()-d),l&&(d=performance.now()),m=0;m<this.frictionEquations.length;m++)r.addEquation(this.frictionEquations[m]);for(var W=e.length,E=0;E!==W;E++){var A=e[E],S=A.bi,C=A.bj,k=A.si,j=A.sj;(S.material&&C.material&&this.getContactMaterial(S.material,C.material)||this.defaultContactMaterial).friction,S.material&&C.material&&(0<=S.material.friction&&0<=C.material.friction&&(S.material.friction,C.material.friction),0<=S.material.restitution)&&0<=C.material.restitution&&(A.restitution=S.material.restitution*C.material.restitution),r.addEquation(A),!S.allowSleep||S.type!==K.DYNAMIC||S.sleepState!==K.SLEEPING||C.sleepState!==K.AWAKE||C.type===K.STATIC||C.velocity.lengthSquared()+C.angularVelocity.lengthSquared()>=2*Math.pow(C.sleepSpeedLimit,2)&&(S.wakeUpAfterNarrowphase=!0),C.allowSleep&&C.type===K.DYNAMIC&&C.sleepState===K.SLEEPING&&S.sleepState===K.AWAKE&&S.type!==K.STATIC&&S.velocity.lengthSquared()+S.angularVelocity.lengthSquared()>=2*Math.pow(S.sleepSpeedLimit,2)&&(C.wakeUpAfterNarrowphase=!0),this.collisionMatrix.set(S,C,!0),this.collisionMatrixPrevious.get(S,C)||(lr.body=C,lr.contact=A,S.dispatchEvent(lr),lr.body=S,C.dispatchEvent(lr)),this.bodyOverlapKeeper.set(S.id,C.id),this.shapeOverlapKeeper.set(k.id,j.id)}for(this.emitContactEvents(),l&&(h.makeContactConstraints=performance.now()-d,d=performance.now()),m=0;m!==n;m++){var T=s[m];T.wakeUpAfterNarrowphase&&(T.wakeUp(),T.wakeUpAfterNarrowphase=!1)}for(g=u.length,m=0;m!==g;m++){var B=u[m];B.update();for(var M=0,U=B.equations.length;M!==U;M++){var G=B.equations[M];r.addEquation(G)}}r.solve(t,this),l&&(h.solve=performance.now()-d),r.removeAllEquations();var z=Math.pow;for(m=0;m!==n;m++){var R,P,I=s[m];I.type&c&&(R=z(1-I.linearDamping,t),(P=I.velocity).scale(R,P),R=I.angularVelocity)&&(P=z(1-I.angularDamping,t),R.scale(P,R))}for(this.dispatchEvent(ar),m=0;m!==n;m++){var F=s[m];F.preStep&&F.preStep.call(F)}l&&(d=performance.now());var Y=this.stepnumber%(this.quatNormalizeSkip+1)==0,X=this.quatNormalizeFast;for(m=0;m!==n;m++)s[m].integrate(t,Y,X);for(this.clearForces(),this.broadphase.dirty=!0,l&&(h.integrate=performance.now()-d),this.time+=t,this.stepnumber+=1,this.dispatchEvent(rr),m=0;m!==n;m++){var L=s[m],Q=L.postStep;Q&&Q.call(L)}var N=!0;if(this.allowSleep)for(N=!1,m=0;m!==n;m++){var Z=s[m];Z.sleepTick(this.time),Z.sleepState!==K.SLEEPING&&(N=!0)}this.hasActiveBodies=N},E.clearForces=function(){for(var t=this.bodies,e=t.length,i=0;i!==e;i++){var o=t[i];o.force,o.force.set(0,0,0),o.torque.set(0,0,0)}},ir),er=(new m,new H);function ir(t){var e;return void 0===t&&(t={}),(e=Js.call(this)||this).dt=-1,e.allowSleep=!!t.allowSleep,e.contacts=[],e.frictionEquations=[],e.quatNormalizeSkip=void 0!==t.quatNormalizeSkip?t.quatNormalizeSkip:0,e.quatNormalizeFast=void 0!==t.quatNormalizeFast&&t.quatNormalizeFast,e.time=0,e.stepnumber=0,e.default_dt=1/60,e.nextId=0,e.gravity=new W,t.gravity&&e.gravity.copy(t.gravity),e.broadphase=void 0!==t.broadphase?t.broadphase:new Dt,e.bodies=[],e.hasActiveBodies=!1,e.solver=void 0!==t.solver?t.solver:new un,e.constraints=[],e.narrowphase=new x(X(e)),e.collisionMatrix=new U,e.collisionMatrixPrevious=new U,e.bodyOverlapKeeper=new Qs,e.shapeOverlapKeeper=new Qs,e.materials=[],e.contactmaterials=[],e.contactMaterialTable=new tr,e.defaultMaterial=new bi("default"),e.defaultContactMaterial=new xe(e.defaultMaterial,e.defaultMaterial,{friction:.3,restitution:0}),e.doProfiling=!1,e.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},e.accumulator=0,e.subsystems=[],e.addBodyEvent={type:"addBody",body:null},e.removeBodyEvent={type:"removeBody",body:null},e.idToBodyMap={},e.broadphase.setWorld(X(e)),e}function or(){this.data={keys:[]}}(performance="undefined"==typeof performance?{}:performance).now||($s=Date.now(),performance.timing&&performance.timing.navigationStart&&($s=performance.timing.navigationStart),performance.now=function(){return Date.now()-$s}),new W;var A,S,nr,sr,z,R,rr={type:"postStep"},ar={type:"preStep"},lr={type:K.COLLIDE_EVENT_NAME,body:null,contact:null},hr=[],cr=[],dr=[],ur=[];E.prototype.emitContactEvents=(A=[],S=[],nr={type:"beginContact",bodyA:null,bodyB:null},sr={type:"endContact",bodyA:null,bodyB:null},z={type:"beginShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},R={type:"endShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},function(){var t=this.hasAnyEventListener("beginContact"),e=this.hasAnyEventListener("endContact");if((t||e)&&this.bodyOverlapKeeper.getDiff(A,S),t){for(var i=0,o=A.length;i<o;i+=2)nr.bodyA=this.getBodyById(A[i]),nr.bodyB=this.getBodyById(A[i+1]),this.dispatchEvent(nr);nr.bodyA=nr.bodyB=null}if(e){for(var n=0,s=S.length;n<s;n+=2)sr.bodyA=this.getBodyById(S[n]),sr.bodyB=this.getBodyById(S[n+1]),this.dispatchEvent(sr);sr.bodyA=sr.bodyB=null}A.length=S.length=0;t=this.hasAnyEventListener("beginShapeContact"),e=this.hasAnyEventListener("endShapeContact");if((t||e)&&this.shapeOverlapKeeper.getDiff(A,S),t){for(var r=0,a=A.length;r<a;r+=2){var l=this.getShapeById(A[r]),h=this.getShapeById(A[r+1]);z.shapeA=l,z.shapeB=h,z.bodyA=l.body,z.bodyB=h.body,this.dispatchEvent(z)}z.bodyA=z.bodyB=z.shapeA=z.shapeB=null}if(e){for(var c=0,d=S.length;c<d;c+=2){var u=this.getShapeById(S[c]),p=this.getShapeById(S[c+1]);R.shapeA=u,R.shapeB=p,R.bodyA=u.body,R.bodyB=p.body,this.dispatchEvent(R)}R.bodyA=R.bodyB=R.shapeA=R.shapeB=null}}),t.AABB=m,t.ArrayCollisionMatrix=U,t.BODY_SLEEP_STATES=n,t.BODY_TYPES={DYNAMIC:1,STATIC:2,KINEMATIC:4},t.Body=K,t.Box=ct,t.Broadphase=r,t.COLLISION_TYPES=b,t.ConeTwistConstraint=ti,t.Constraint=ye,t.ContactEquation=Oe,t.ContactMaterial=xe,t.ConvexPolyhedron=nt,t.Cylinder=Eo,t.DistanceConstraint=ei,t.Equation=c,t.EventTarget=i,t.FrictionEquation=ai,t.GSSolver=un,t.GridBroadphase=Lt,t.Heightfield=v,t.HingeConstraint=ni,t.JacobianElement=ge,t.LockConstraint=ii,t.Mat3=L,t.Material=bi,t.NaiveBroadphase=Dt,t.Narrowphase=x,t.ObjectCollisionMatrix=F,t.Particle=Ao,t.Plane=So,t.PointToPointConstraint=Ye,t.Pool=zn,t.Quaternion=s,t.RAY_MODES={CLOSEST:1,ANY:2,ALL:4},t.Ray=H,t.RaycastResult=Vt,t.RaycastVehicle=p,t.RigidVehicle=f,t.RotationalEquation=Ke,t.RotationalMotorEquation=oi,t.SAPBroadphase=l,t.SHAPE_TYPES=o,t.SPHSystem=mo,t.Shape=ot,t.Solver=w,t.Sphere=co,t.SplitSolver=yn,t.Spring=d,t.Transform=O,t.Trimesh=Yo,t.Vec3=W,t.Vec3Pool=Rn,t.World=E},{}],5:[function(t,e,i){let E=i.TYPE={BOX:"box",CYLINDER:"cylinder",SPHERE:"sphere",CAPSULE:"capsule",CONE:"cone",HULL:"hull",HACD:"hacd",VHACD:"vhacd",MESH:"mesh",HEIGHTFIELD:"heightfield"},A=i.FIT={ALL:"all",MANUAL:"manual"},a=(i.HEIGHTFIELD_DATA_TYPE={short:"short",float:"float"},THREE.Object3D.prototype.hasOwnProperty("updateMatrices"));function S(t){t.fit=t.hasOwnProperty("fit")?t.fit:A.ALL,t.type=t.type||E.HULL,t.minHalfExtent=t.hasOwnProperty("minHalfExtent")?t.minHalfExtent:0,t.maxHalfExtent=t.hasOwnProperty("maxHalfExtent")?t.maxHalfExtent:Number.POSITIVE_INFINITY,t.cylinderAxis=t.cylinderAxis||"y",t.margin=t.hasOwnProperty("margin")?t.margin:.01,t.includeInvisible=!!t.hasOwnProperty("includeInvisible")&&t.includeInvisible,t.offset||(t.offset=new THREE.Vector3),t.orientation||(t.orientation=new THREE.Quaternion)}i.createCollisionShapes=function(t,e){switch(e.type){case E.BOX:return[this.createBoxShape(t,e)];case E.CYLINDER:return[this.createCylinderShape(t,e)];case E.CAPSULE:return[this.createCapsuleShape(t,e)];case E.CONE:return[this.createConeShape(t,e)];case E.SPHERE:return[this.createSphereShape(t,e)];case E.HULL:return[this.createHullShape(t,e)];case E.HACD:return this.createHACDShapes(t,e);case E.VHACD:return this.createVHACDShapes(t,e);case E.MESH:return[this.createTriMeshShape(t,e)];case E.HEIGHTFIELD:return[this.createHeightfieldTerrainShape(t,e)];default:return console.warn(e.type+" is not currently supported"),[]}},i.createBoxShape=function(t,e){e.type=E.BOX,S(e),e.fit===A.ALL&&(e.halfExtents=r(t,M(t,e),e.minHalfExtent,e.maxHalfExtent));var i=new Ammo.btVector3(e.halfExtents.x,e.halfExtents.y,e.halfExtents.z),o=new Ammo.btBoxShape(i);return Ammo.destroy(i),C(o,e,B(t,e)),o},i.createCylinderShape=function(t,e){e.type=E.CYLINDER,S(e),e.fit===A.ALL&&(e.halfExtents=r(t,M(t,e),e.minHalfExtent,e.maxHalfExtent));let i=new Ammo.btVector3(e.halfExtents.x,e.halfExtents.y,e.halfExtents.z),o=(()=>{switch(e.cylinderAxis){case"y":return new Ammo.btCylinderShape(i);case"x":return new Ammo.btCylinderShapeX(i);case"z":return new Ammo.btCylinderShapeZ(i)}return null})();return Ammo.destroy(i),C(o,e,B(t,e)),o},i.createCapsuleShape=function(t,e){e.type=E.CAPSULE,S(e),e.fit===A.ALL&&(e.halfExtents=r(t,M(t,e),e.minHalfExtent,e.maxHalfExtent));let{x:i,y:o,z:n}=e.halfExtents,s=(()=>{switch(e.cylinderAxis){case"y":return new Ammo.btCapsuleShape(Math.max(i,n),2*o);case"x":return new Ammo.btCapsuleShapeX(Math.max(o,n),2*i);case"z":return new Ammo.btCapsuleShapeZ(Math.max(i,o),2*n)}return null})();return C(s,e,B(t,e)),s},i.createConeShape=function(t,e){e.type=E.CONE,S(e),e.fit===A.ALL&&(e.halfExtents=r(t,M(t,e),e.minHalfExtent,e.maxHalfExtent));let{x:i,y:o,z:n}=e.halfExtents,s=(()=>{switch(e.cylinderAxis){case"y":return new Ammo.btConeShape(Math.max(i,n),2*o);case"x":return new Ammo.btConeShapeX(Math.max(o,n),2*i);case"z":return new Ammo.btConeShapeZ(Math.max(i,o),2*n)}return null})();return C(s,e,B(t,e)),s},i.createSphereShape=function(t,e){e.type=E.SPHERE,S(e),i=e.fit!==A.MANUAL||isNaN(e.sphereRadius)?o(t,e,M(t,e)):e.sphereRadius;var i=new Ammo.btSphereShape(i);return C(i,e,B(t,e)),i},i.createHullShape=(()=>{let h=new THREE.Vector3,c=new THREE.Vector3;return function(t,e){if(e.type=E.HULL,S(e),e.fit===A.MANUAL)return console.warn("cannot use fit: manual with type: hull"),null;let i=M(t,e),o=new Ammo.btVector3,n=new Ammo.btConvexHullShape,s=(n.setMargin(e.margin),c.addVectors(i.max,i.min).multiplyScalar(.5),0);T(t,e,t=>{s+=t.attributes.position.array.length/3});var r=e.hullMaxVertices||1e5;s>r&&console.warn(`too many vertices for hull shape; sampling ~${r} from ~${s} vertices`);let a=Math.min(1,r/s),l=(T(t,e,(t,e)=>{var i=t.attributes.position.array;for(let t=0;t<i.length;t+=3)Math.random()<=a&&(h.set(i[t],i[t+1],i[t+2]).applyMatrix4(e).sub(c),o.setValue(h.x,h.y,h.z),n.addPoint(o,t===i.length-3))}),n);return 100<=n.getNumVertices()&&((r=new Ammo.btShapeHull(n)).buildHull(e.margin),Ammo.destroy(n),l=new Ammo.btConvexHullShape(Ammo.getPointer(r.getVertexPointer()),r.numVertices()),Ammo.destroy(r)),Ammo.destroy(o),C(l,e,B(t,e)),l}})(),i.createHACDShapes=(()=>{let b=new THREE.Vector3,x=new THREE.Vector3;return function(t,i){if(i.type=E.HACD,S(i),i.fit===A.MANUAL)return console.warn("cannot use fit: manual with type: hacd"),[];if(!Ammo.hasOwnProperty("HACD"))return console.warn("HACD unavailable in included build of Ammo.js. Visit https://github.com/mozillareality/ammo.js for the latest version."),[];var e=M(t),o=B(t,i);let n=0,s=0;x.addVectors(e.max,e.min).multiplyScalar(.5),T(t,i,t=>{n+=t.attributes.position.array.length/3,s+=t.index?t.index.array.length/3:t.attributes.position.array.length/9});var r=new Ammo.HACD,e=(i.hasOwnProperty("compacityWeight")&&r.SetCompacityWeight(i.compacityWeight),i.hasOwnProperty("volumeWeight")&&r.SetVolumeWeight(i.volumeWeight),i.hasOwnProperty("nClusters")&&r.SetNClusters(i.nClusters),i.hasOwnProperty("nVerticesPerCH")&&r.SetNVerticesPerCH(i.nVerticesPerCH),i.hasOwnProperty("concavity")&&r.SetConcavity(i.concavity),Ammo._malloc(3*n*8)),a=Ammo._malloc(3*s*4);r.SetPoints(e),r.SetTriangles(a),r.SetNPoints(n),r.SetNTriangles(s);let l=e/8,h=a/4;T(t,i,(t,e)=>{var i=t.attributes.position.array,o=t.index?t.index.array:null;for(let t=0;t<i.length;t+=3)b.set(i[t+0],i[t+1],i[t+2]).applyMatrix4(e).sub(x),Ammo.HEAPF64[l+t+0]=b.x,Ammo.HEAPF64[l+t+1]=b.y,Ammo.HEAPF64[l+t+2]=b.z;if(o)for(let t=0;t<o.length;t++)Ammo.HEAP32[h+t]=o[t];else for(let t=0;t<i.length/3;t++)Ammo.HEAP32[h+t]=t}),r.Compute(),Ammo._free(e),Ammo._free(a);var c=r.GetNClusters(),d=[];for(let t=0;t<c;t++){var u=new Ammo.btConvexHullShape,p=(u.setMargin(i.margin),r.GetNPointsCH(t)),m=r.GetNTrianglesCH(t),f=Ammo._malloc(3*p*8),m=Ammo._malloc(3*m*4);r.GetCH(t,f,m);let e=f/8;for(let t=0;t<p;t++){var y=new Ammo.btVector3,v=Ammo.HEAPF64[e+3*t],g=Ammo.HEAPF64[e+3*t+1],w=Ammo.HEAPF64[e+3*t+2];y.setValue(v,g,w),u.addPoint(y,t===p-1),Ammo.destroy(y)}C(u,i,o),d.push(u)}return d}})(),i.createVHACDShapes=(()=>{let b=new THREE.Vector3,x=new THREE.Vector3;return function(t,e){if(e.type=E.VHACD,S(e),e.fit===A.MANUAL)return console.warn("cannot use fit: manual with type: vhacd"),[];if(!Ammo.hasOwnProperty("VHACD"))return console.warn("VHACD unavailable in included build of Ammo.js. Visit https://github.com/mozillareality/ammo.js for the latest version."),[];var i=M(t,e),o=B(t,e);let n=0,s=0;x.addVectors(i.max,i.min).multiplyScalar(.5),T(t,e,t=>{n+=t.attributes.position.count,s+=t.index?t.index.count/3:t.attributes.position.count/3});var r=new Ammo.VHACD,i=new Ammo.Parameters,a=(e.hasOwnProperty("resolution")&&i.set_m_resolution(e.resolution),e.hasOwnProperty("depth")&&i.set_m_depth(e.depth),e.hasOwnProperty("concavity")&&i.set_m_concavity(e.concavity),e.hasOwnProperty("planeDownsampling")&&i.set_m_planeDownsampling(e.planeDownsampling),e.hasOwnProperty("convexhullDownsampling")&&i.set_m_convexhullDownsampling(e.convexhullDownsampling),e.hasOwnProperty("alpha")&&i.set_m_alpha(e.alpha),e.hasOwnProperty("beta")&&i.set_m_beta(e.beta),e.hasOwnProperty("gamma")&&i.set_m_gamma(e.gamma),e.hasOwnProperty("pca")&&i.set_m_pca(e.pca),e.hasOwnProperty("mode")&&i.set_m_mode(e.mode),e.hasOwnProperty("maxNumVerticesPerCH")&&i.set_m_maxNumVerticesPerCH(e.maxNumVerticesPerCH),e.hasOwnProperty("minVolumePerCH")&&i.set_m_minVolumePerCH(e.minVolumePerCH),e.hasOwnProperty("convexhullApproximation")&&i.set_m_convexhullApproximation(e.convexhullApproximation),e.hasOwnProperty("oclAcceleration")&&i.set_m_oclAcceleration(e.oclAcceleration),Ammo._malloc(3*n*8)),l=Ammo._malloc(3*s*4);let h=a/8,c=l/4;T(t,e,(t,e)=>{var i=t.attributes.position.array,o=t.index?t.index.array:null;for(let t=0;t<i.length;t+=3)b.set(i[t+0],i[t+1],i[t+2]).applyMatrix4(e).sub(x),Ammo.HEAPF64[h+0]=b.x,Ammo.HEAPF64[h+1]=b.y,Ammo.HEAPF64[h+2]=b.z,h+=3;if(o)for(let t=0;t<o.length;t++)Ammo.HEAP32[c]=o[t],c++;else for(let t=0;t<i.length/3;t++)Ammo.HEAP32[c]=t,c++}),r.Compute(a,3,n,l,3,s,i),Ammo._free(a),Ammo._free(l);var d=r.GetNConvexHulls(),u=[],p=new Ammo.ConvexHull;for(let t=0;t<d;t++){r.GetConvexHull(t,p);var m=p.get_m_nPoints(),f=(p.get_m_points(),new Ammo.btConvexHullShape);f.setMargin(e.margin);for(let t=0;t<m;t++){var y=new Ammo.btVector3,v=p.get_m_points(3*t+0),g=p.get_m_points(3*t+1),w=p.get_m_points(3*t+2);y.setValue(v,g,w),f.addPoint(y,t===m-1),Ammo.destroy(y)}C(f,e,o),u.push(f)}return Ammo.destroy(p),Ammo.destroy(r),u}})(),i.createTriMeshShape=(()=>{let d=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector3;return function(t,e){if(e.type=E.MESH,S(e),e.fit===A.MANUAL)return console.warn("cannot use fit: manual with type: mesh"),null;let i=B(t,e),a=new Ammo.btVector3,l=new Ammo.btVector3,h=new Ammo.btVector3,c=new Ammo.btTriangleMesh(!0,!1);T(t,e,(e,i)=>{var o=e.attributes.position.array;if(e.index)for(let t=0;t<e.index.count;t+=3){var n=3*e.index.array[t],s=3*e.index.array[t+1],r=3*e.index.array[t+2];d.set(o[n],o[1+n],o[2+n]).applyMatrix4(i),u.set(o[s],o[1+s],o[2+s]).applyMatrix4(i),p.set(o[r],o[1+r],o[2+r]).applyMatrix4(i),a.setValue(d.x,d.y,d.z),l.setValue(u.x,u.y,u.z),h.setValue(p.x,p.y,p.z),c.addTriangle(a,l,h,!1)}else for(let t=0;t<o.length;t+=9)d.set(o[t+0],o[t+1],o[t+2]).applyMatrix4(i),u.set(o[t+3],o[t+4],o[t+5]).applyMatrix4(i),p.set(o[t+6],o[t+7],o[t+8]).applyMatrix4(i),a.setValue(d.x,d.y,d.z),l.setValue(u.x,u.y,u.z),h.setValue(p.x,p.y,p.z),c.addTriangle(a,l,h,!1)});t=new Ammo.btVector3(i.x,i.y,i.z),c.setScaling(t),Ammo.destroy(t),t=new Ammo.btBvhTriangleMeshShape(c,!0,!0);return t.resources=[c],Ammo.destroy(a),Ammo.destroy(l),Ammo.destroy(h),C(t,e),t}})(),i.createHeightfieldTerrainShape=function(t,e){if(S(e),e.fit===A.ALL)return console.warn("cannot use fit: all with type: heightfield"),null;var i=e.heightfieldDistance||1,o=e.heightfieldData||[],n=e.heightScale||0,s=e.hasOwnProperty("upAxis")?e.upAxis:1,r="short"!==e.heightDataType?Ammo.PHY_FLOAT:Ammo.PHY_SHORT,a=!e.hasOwnProperty("flipQuadEdges")||e.flipQuadEdges,l=o.length,h=0<l?o[0].length:0,c=Ammo._malloc(l*h*4),d=c/4;let u=Number.POSITIVE_INFINITY,p=Number.NEGATIVE_INFINITY,m=0;for(let e=0;e<l;e++)for(let t=0;t<h;t++){var f=o[e][t];Ammo.HEAPF32[d+m]=f,m++,u=Math.min(u,f),p=Math.max(p,f)}n=new Ammo.btHeightfieldTerrainShape(h,l,c,n,u,p,s,r,a),s=new Ammo.btVector3(i,1,i);return n.setLocalScaling(s),Ammo.destroy(s),n.heightfieldData=c,C(n,e),n};let C=function(e,t,i){e.type=t.type,e.setMargin(t.margin),e.destroy=()=>{for(var t of e.resources||[])Ammo.destroy(t);e.heightfieldData&&Ammo._free(e.heightfieldData),Ammo.destroy(e)};var o=new Ammo.btTransform,n=new Ammo.btQuaternion;o.setIdentity(),o.getOrigin().setValue(t.offset.x,t.offset.y,t.offset.z),n.setValue(t.orientation.x,t.orientation.y,t.orientation.z,t.orientation.w),o.setRotation(n),Ammo.destroy(n),i&&(t=new Ammo.btVector3(i.x,i.y,i.z),e.setLocalScaling(t),Ammo.destroy(t)),e.localTransform=o},T=(()=>{let n=new THREE.Matrix4,s=new THREE.Matrix4,r=new THREE.BufferGeometry;return function(e,i,o){s.copy(e.matrixWorld).invert(),e.traverse(t=>{!t.isMesh||THREE.Sky&&t.__proto__==THREE.Sky.prototype||!(i.includeInvisible||t.el&&t.el.object3D.visible||t.visible)||(t===e?n.identity():(a&&t.updateMatrices(),n.multiplyMatrices(s,t.matrixWorld)),o(t.geometry.isBufferGeometry?t.geometry:r.fromGeometry(t.geometry),n))})}})(),B=function(t,e){var i=new THREE.Vector3(1,1,1);return e.fit===A.ALL&&i.setFromMatrixScale(t.matrixWorld),i},o=(()=>{let c=new THREE.Vector3,o=new THREE.Vector3;return function(t,e,i){let r=0,{x:a,y:l,z:h}=i.getCenter(o);return T(t,e,(t,e)=>{var i=t.attributes.position.array;for(let t=0;t<i.length;t+=3){c.set(i[t],i[t+1],i[t+2]).applyMatrix4(e);var o=a-c.x,n=l-c.y,s=h-c.z;r=Math.max(r,o*o+n*n+s*s)}}),Math.sqrt(r)}})(),r=function(t,e,i,o){return(new THREE.Vector3).subVectors(e.max,e.min).multiplyScalar(.5).clampScalar(i,o)},M=(()=>{let h=new THREE.Vector3;return function(t,e){var i=new THREE.Box3;let o=1/0,n=1/0,s=1/0,r=-1/0,a=-1/0,l=-1/0;return i.min.set(0,0,0),i.max.set(0,0,0),T(t,e,(t,e)=>{var i=t.attributes.position.array;for(let t=0;t<i.length;t+=3)h.set(i[t],i[t+1],i[t+2]).applyMatrix4(e),h.x<o&&(o=h.x),h.y<n&&(n=h.y),h.z<s&&(s=h.z),h.x>r&&(r=h.x),h.y>a&&(a=h.y),h.z>l&&(l=h.z)}),i.min.set(o,n,s),i.max.set(r,a,l),i}})()},{}],6:[function(l,t,h){!function(t){function e(t,e){var i,o,n,s,r,a;if((e=e||{}).type===S.BOX)return B(t);if(e.type===S.CYLINDER)return o=t,s=["x","y","z"],r=e.cylinderAxis||"y",s=s.splice(s.indexOf(r),1)&&s,o=(new x.Box3).setFromObject(o),isFinite(o.min.lengthSq())?(n=o.max[r]-o.min[r],o=.5*Math.max(o.max[s[0]]-o.min[s[0]],o.max[s[1]]-o.min[s[1]]),(s=new b.Cylinder(o,o,n,12))._type=b.Shape.types.CYLINDER,s.radiusTop=o,s.radiusBottom=o,s.height=n,s.numSegments=12,s.orientation=new b.Quaternion,s.orientation.setFromEuler("y"===r?A:0,"z"===r?A:0,0,"XYZ").normalize(),s):null;if(e.type===S.SPHERE)return o=t,(n=e).sphereRadius?new b.Sphere(n.sphereRadius):(n=M(o))?(n.computeBoundingSphere(),new b.Sphere(n.boundingSphere.radius)):null;if(e.type===S.HULL){var l=M(t);if(!l||!l.vertices.length)return null;for(var h=0;h<l.vertices.length;h++)l.vertices[h].x+=1e-4*(Math.random()-.5),l.vertices[h].y+=1e-4*(Math.random()-.5),l.vertices[h].z+=1e-4*(Math.random()-.5);for(var c=(new E).setFromObject(new x.Mesh(l)).faces,d=[],u=[],h=0;h<c.length;h++){var p=c[h],m=p.edge;do{var f=m.head().point}while(d.push(new b.Vec3(f.x,f.y,f.z)),u.push(new b.Vec3(p.normal.x,p.normal.y,p.normal.z)),(m=m.next)!==p.edge)}return new b.ConvexPolyhedron({vertices:d,normals:u})}if(e.type===S.MESH)return(i=M(t))&&(r=z(i)).length?(s=Object.keys(r).map(Number),new b.Trimesh(r,s)):null;if(e.type)throw new Error('[CANNON.threeToCannon] Invalid type "%s".',e.type);if(!(i=M(t)))return null;switch((i.metadata||i).type){case"BoxGeometry":case"BoxBufferGeometry":return T(i);case"CylinderGeometry":case"CylinderBufferGeometry":return y=((y=i).metadata||y).parameters,(a=new b.Cylinder(y.radiusTop,y.radiusBottom,y.height,y.radialSegments))._type=b.Shape.types.CYLINDER,a.radiusTop=y.radiusTop,a.radiusBottom=y.radiusBottom,a.height=y.height,a.numSegments=y.radialSegments,a.orientation=new b.Quaternion,a.orientation.setFromEuler(x.Math.degToRad(-90),0,0,"XYZ").normalize(),a;case"PlaneGeometry":case"PlaneBufferGeometry":var y=i;return y.computeBoundingBox(),y=y.boundingBox,new b.Box(new b.Vec3((y.max.x-y.min.x)/2||.1,(y.max.y-y.min.y)/2||.1,(y.max.z-y.min.z)/2||.1));case"SphereGeometry":case"SphereBufferGeometry":return a=i,new b.Sphere((a.metadata||a).parameters.radius);case"TubeGeometry":case"Geometry":case"BufferGeometry":return B(t);default:return console.warn('Unrecognized geometry: "%s". Using bounding box as shape.',i.type),T(i)}}var v,g,w,o,i,b=l("cannon-es"),x="undefined"!=typeof window?window.THREE:void 0!==t?t.THREE:null,E=(i=new x.Vector3,Object.assign(n.prototype,{setFromPoints:function(t){!0!==Array.isArray(t)&&console.error("THREE.ConvexHull: Points parameter is not an array."),t.length<4&&console.error("THREE.ConvexHull: The algorithm needs at least four points."),this.makeEmpty();for(var e=0,i=t.length;e<i;e++)this.vertices.push(new r(t[e]));return this.compute(),this},setFromObject:function(t){var a=[];return t.updateMatrixWorld(!0),t.traverse(function(t){var e,i=t.geometry;if(void 0!==i)if(i.isGeometry)for(var o=i.vertices,n=0,s=o.length;n<s;n++)(e=o[n].clone()).applyMatrix4(t.matrixWorld),a.push(e);else if(i.isBufferGeometry){var r=i.attributes.position;if(void 0!==r)for(n=0,s=r.count;n<s;n++)(e=new x.Vector3).fromBufferAttribute(r,n).applyMatrix4(t.matrixWorld),a.push(e)}}),this.setFromPoints(a)},containsPoint:function(t){for(var e=this.faces,i=0,o=e.length;i<o;i++)if(e[i].distanceToPoint(t)>this.tolerance)return!1;return!0},intersectRay:function(t,e){for(var i=this.faces,o=-1/0,n=1/0,s=0,r=i.length;s<r;s++){var a=i[s],l=a.distanceToPoint(t.origin),a=a.normal.dot(t.direction);if(0<l&&0<=a)return null;l=0!==a?-l/a:0;if(!(l<=0)&&(0<a?n=Math.min(l,n):o=Math.max(l,o),n<o))return null}return t.at(-1/0!==o?o:n,e),e},intersectsRay:function(t){return null!==this.intersectRay(t,i)},makeEmpty:function(){return this.faces=[],this.vertices=[],this},addVertexToFace:function(t,e){return null===(t.face=e).outside?this.assigned.append(t):this.assigned.insertBefore(e.outside,t),e.outside=t,this},removeVertexFromFace:function(t,e){return t===e.outside&&(e.outside=null!==t.next&&t.next.face===e?t.next:null),this.assigned.remove(t),this},removeAllVerticesFromFace:function(t){if(null!==t.outside){for(var e=t.outside,i=t.outside;null!==i.next&&i.next.face===t;)i=i.next;return this.assigned.removeSubList(e,i),e.prev=i.next=null,t.outside=null,e}},deleteFaceVertices:function(t,e){t=this.removeAllVerticesFromFace(t);if(void 0!==t)if(void 0===e)this.unassigned.appendChain(t);else{var i=t;do{var o=i.next}while(e.distanceToPoint(i.point)>this.tolerance?this.addVertexToFace(i,e):this.unassigned.append(i),null!==(i=o))}return this},resolveUnassignedPoints:function(t){if(!1===this.unassigned.isEmpty()){var e=this.unassigned.first();do{for(var i=e.next,o=this.tolerance,n=null,s=0;s<t.length;s++){var r=t[s];if(0===r.mark){var a=r.distanceToPoint(e.point);if(o<a&&(o=a,n=r),o>1e3*this.tolerance)break}}}while(null!==n&&this.addVertexToFace(e,n),null!==(e=i))}return this},computeExtremes:function(){for(var t,e=new x.Vector3,i=new x.Vector3,o=[],n=[],s=0;s<3;s++)o[s]=n[s]=this.vertices[0];for(e.copy(this.vertices[0].point),i.copy(this.vertices[0].point),s=0,t=this.vertices.length;s<t;s++){for(var r=this.vertices[s],a=r.point,l=0;l<3;l++)a.getComponent(l)<e.getComponent(l)&&(e.setComponent(l,a.getComponent(l)),o[l]=r);for(l=0;l<3;l++)a.getComponent(l)>i.getComponent(l)&&(i.setComponent(l,a.getComponent(l)),n[l]=r)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(e.x),Math.abs(i.x))+Math.max(Math.abs(e.y),Math.abs(i.y))+Math.max(Math.abs(e.z),Math.abs(i.z))),{min:o,max:n}},computeInitialHull:function(){void 0===v&&(v=new x.Line3,g=new x.Plane,w=new x.Vector3);for(var t,e,i,o,n,s,r,a=this.vertices,l=this.computeExtremes(),h=l.min,c=l.max,d=0,u=0,p=0;p<3;p++)(r=c[p].point.getComponent(p)-h[p].point.getComponent(p))>d&&(d=r,u=p);for(d=0,v.set((e=h[u]).point,(i=c[u]).point),p=0,s=this.vertices.length;p<s;p++)(t=a[p])!==e&&t!==i&&(v.closestPointToPoint(t.point,!0,w),(r=w.distanceToSquared(t.point))>d)&&(d=r,o=t);for(d=-1,g.setFromCoplanarPoints(e.point,i.point,o.point),p=0,s=this.vertices.length;p<s;p++)(t=a[p])!==e&&t!==i&&t!==o&&(r=Math.abs(g.distanceToPoint(t.point)))>d&&(d=r,n=t);var m=[];if(g.distanceToPoint(n.point)<0)for(m.push(C.create(e,i,o),C.create(n,i,e),C.create(n,o,i),C.create(n,e,o)),p=0;p<3;p++)y=(p+1)%3,m[p+1].getEdge(2).setTwin(m[0].getEdge(y)),m[p+1].getEdge(1).setTwin(m[y+1].getEdge(0));else for(m.push(C.create(e,o,i),C.create(n,e,i),C.create(n,i,o),C.create(n,o,e)),p=0;p<3;p++)y=(p+1)%3,m[p+1].getEdge(2).setTwin(m[0].getEdge((3-p)%3)),m[p+1].getEdge(0).setTwin(m[y+1].getEdge(1));for(p=0;p<4;p++)this.faces.push(m[p]);for(p=0,s=a.length;p<s;p++)if((t=a[p])!==e&&t!==i&&t!==o&&t!==n){for(var d=this.tolerance,f=null,y=0;y<4;y++)(r=this.faces[y].distanceToPoint(t.point))>d&&(d=r,f=this.faces[y]);null!==f&&this.addVertexToFace(t,f)}return this},reindexFaces:function(){for(var t=[],e=0;e<this.faces.length;e++){var i=this.faces[e];0===i.mark&&t.push(i)}return this.faces=t,this},nextVertexToAdd:function(){if(!1===this.assigned.isEmpty()){var t,e=0,i=this.assigned.first().face,o=i.outside;do{var n=i.distanceToPoint(o.point)}while(e<n&&(e=n,t=o),null!==(o=o.next)&&o.face===i);return t}},computeHorizon:function(t,e,i,o){var n;this.deleteFaceVertices(i),i.mark=1,n=null===e?e=i.getEdge(0):e.next;do{var s=n.twin,r=s.face}while(0===r.mark&&(r.distanceToPoint(t)>this.tolerance?this.computeHorizon(t,s,r,o):o.push(n)),(n=n.next)!==e);return this},addAdjoiningFace:function(t,e){t=C.create(t,e.tail(),e.head());return this.faces.push(t),t.getEdge(-1).setTwin(e.twin),t.getEdge(0)},addNewFaces:function(t,e){this.newFaces=[];for(var i=null,o=null,n=0;n<e.length;n++){var s=this.addAdjoiningFace(t,e[n]);null===i?i=s:s.next.setTwin(o),this.newFaces.push(s.face),o=s}return i.next.setTwin(o),this},addVertexToHull:function(t){var e=[];return this.unassigned.clear(),this.removeVertexFromFace(t,t.face),this.computeHorizon(t.point,null,t.face,e),this.addNewFaces(t,e),this.resolveUnassignedPoints(this.newFaces),this},cleanup:function(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this},compute:function(){var t;for(this.computeInitialHull();void 0!==(t=this.nextVertexToAdd());)this.addVertexToHull(t);return this.reindexFaces(),this.cleanup(),this}}),Object.assign(C,{create:function(t,e,i){var o=new C,t=new s(t,o),e=new s(e,o),i=new s(i,o);return((t.next=i.prev=e).next=t.prev=i).next=e.prev=t,o.edge=t,o.compute()}}),Object.assign(C.prototype,{getEdge:function(t){for(var e=this.edge;0<t;)e=e.next,t--;for(;t<0;)e=e.prev,t++;return e},compute:function(){void 0===o&&(o=new x.Triangle);var t=this.edge.tail(),e=this.edge.head(),i=this.edge.next.head();return o.set(t.point,e.point,i.point),o.getNormal(this.normal),o.getMidpoint(this.midpoint),this.area=o.getArea(),this.constant=this.normal.dot(this.midpoint),this},distanceToPoint:function(t){return this.normal.dot(t)-this.constant}}),Object.assign(s.prototype,{head:function(){return this.vertex},tail:function(){return this.prev?this.prev.vertex:null},length:function(){var t=this.head(),e=this.tail();return null!==e?e.point.distanceTo(t.point):-1},lengthSquared:function(){var t=this.head(),e=this.tail();return null!==e?e.point.distanceToSquared(t.point):-1},setTwin:function(t){return(this.twin=t).twin=this}}),Object.assign(a.prototype,{first:function(){return this.head},last:function(){return this.tail},clear:function(){return this.head=this.tail=null,this},insertBefore:function(t,e){return e.prev=t.prev,e.next=t,null===e.prev?this.head=e:e.prev.next=e,t.prev=e,this},insertAfter:function(t,e){return e.prev=t,e.next=t.next,null===e.next?this.tail=e:e.next.prev=e,t.next=e,this},append:function(t){return null===this.head?this.head=t:this.tail.next=t,t.prev=this.tail,t.next=null,this.tail=t,this},appendChain:function(t){for(null===this.head?this.head=t:this.tail.next=t,t.prev=this.tail;null!==t.next;)t=t.next;return this.tail=t,this},remove:function(t){return null===t.prev?this.head=t.next:t.prev.next=t.next,null===t.next?this.tail=t.prev:t.next.prev=t.prev,this},removeSubList:function(t,e){return null===t.prev?this.head=e.next:t.prev.next=e.next,null===e.next?this.tail=t.prev:e.next.prev=t.prev,this},isEmpty:function(){return null===this.head}}),n),A=Math.PI/2,S={BOX:"Box",CYLINDER:"Cylinder",SPHERE:"Sphere",HULL:"ConvexPolyhedron",MESH:"Trimesh"};function n(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new a,this.unassigned=new a,this.vertices=[]}function C(){this.normal=new x.Vector3,this.midpoint=new x.Vector3,this.area=0,this.constant=0,this.outside=null,this.mark=0,this.edge=null}function s(t,e){this.vertex=t,this.prev=null,this.next=null,this.twin=null,this.face=e}function r(t){this.point=t,this.prev=null,this.next=null,this.face=null}function a(){this.head=null,this.tail=null}function T(t){if(!z(t).length)return null;t.computeBoundingBox();t=t.boundingBox;return new b.Box(new b.Vec3((t.max.x-t.min.x)/2,(t.max.y-t.min.y)/2,(t.max.z-t.min.z)/2))}function B(t){var e,t=t.clone(),i=(t.quaternion.set(0,0,0,1),t.updateMatrixWorld(),(new x.Box3).setFromObject(t));return isFinite(i.min.lengthSq())?(e=new b.Box(new b.Vec3((i.max.x-i.min.x)/2,(i.max.y-i.min.y)/2,(i.max.z-i.min.z)/2)),(i=i.translate(t.position.negate()).getCenter(new x.Vector3)).lengthSq()&&(e.offset=i),e):null}function M(t){i=[],t.traverse(function(t){"Mesh"===t.type&&i.push(t)});var e,i,o,n,s,r=i,a=new x.Geometry,l=new x.Geometry;if(0===r.length)return null;if(1===r.length)return h=new x.Vector3,o=new x.Quaternion,n=new x.Vector3,r[0].geometry.isBufferGeometry?r[0].geometry.attributes.position&&2<r[0].geometry.attributes.position.itemSize&&a.fromBufferGeometry(r[0].geometry):a=r[0].geometry.clone(),a.metadata=r[0].geometry.metadata,r[0].updateMatrixWorld(),r[0].matrixWorld.decompose(h,o,n),a.scale(n.x,n.y,n.z);for(;e=r.pop();)e.updateMatrixWorld(),e.geometry.isBufferGeometry?e.geometry.attributes.position&&2<e.geometry.attributes.position.itemSize&&((s=new x.Geometry).fromBufferGeometry(e.geometry),l.merge(s,e.matrixWorld),s.dispose()):l.merge(e.geometry,e.matrixWorld);var h=new x.Matrix4;return h.scale(t.scale),l.applyMatrix(h),l}function z(t){return((t=t.attributes?t:(new x.BufferGeometry).fromGeometry(t)).attributes.position||{}).array||[]}e.Type=S,h.threeToCannon=e}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"cannon-es":4}],7:[function(t,e,i){var u=arguments[3],p=arguments[4],m=arguments[5],f=JSON.stringify;e.exports=function(t,e){for(var i=Object.keys(m),o=0,n=i.length;o<n;o++){var s=i[o],r=m[s].exports;if(r===t||r&&r.default===t){a=s;break}}if(!a){for(var a=Math.floor(Math.pow(16,8)*Math.random()).toString(16),l={},o=0,n=i.length;o<n;o++)l[s=i[o]]=s;p[a]=[Function(["require","module","exports"],"("+t+")(self)"),l]}var h=Math.floor(Math.pow(16,8)*Math.random()).toString(16),c={},d=(c[a]=a,p[h]=[Function(["require"],"var f = require("+f(a)+");(f.default ? f.default : f)(self);"),c],{}),c=(!function t(e){for(var i in d[e]=!0,p[e][1]){i=p[e][1][i];d[i]||t(i)}}(h),"("+u+")({"+Object.keys(d).map(function(t){return f(t)+":["+p[t][0]+","+f(p[t][1])+"]"}).join(",")+"},{},["+f(h)+"])"),h=window.URL||window.webkitURL||window.mozURL||window.msURL,c=new Blob([c],{type:"text/javascript"});return e&&e.bare?c:(e=h.createObjectURL(c),(h=new Worker(e)).objectURL=e,h)}},{}],8:[function(t,e,i){let c=t("../constants").CONSTRAINT;e.exports=AFRAME.registerComponent("ammo-constraint",{multiple:!0,schema:{type:{default:c.LOCK,oneOf:[c.LOCK,c.FIXED,c.SPRING,c.SLIDER,c.HINGE,c.CONE_TWIST,c.POINT_TO_POINT]},target:{type:"selector"},pivot:{type:"vec3"},targetPivot:{type:"vec3"},axis:{type:"vec3",default:{x:0,y:0,z:1}},targetAxis:{type:"vec3",default:{x:0,y:0,z:1}}},init:function(){this.system=this.el.sceneEl.systems.physics,this.constraint=null},remove:function(){this.constraint&&(this.system.removeConstraint(this.constraint),this.constraint=null)},update:function(){var t=this.el,e=this.data;this.remove(),t.body&&e.target.body?(this.constraint=this.createConstraint(),this.system.addConstraint(this.constraint)):(t.body?e.target:t).addEventListener("body-loaded",this.update.bind(this,{}),{once:!0})},createConstraint:function(){let t;var e=this.data,i=this.el.body,o=e.target.body,n=i.getCenterOfMassTransform().invert().op_mul(o.getWorldTransform()),s=new Ammo.btTransform;switch(s.setIdentity(),e.type){case c.LOCK:t=new Ammo.btGeneric6DofConstraint(i,o,n,s,!0);var r=new Ammo.btVector3(0,0,0);t.setLinearLowerLimit(r),t.setLinearUpperLimit(r),t.setAngularLowerLimit(r),t.setAngularUpperLimit(r),Ammo.destroy(r);break;case c.FIXED:n.setRotation(i.getWorldTransform().getRotation()),s.setRotation(o.getWorldTransform().getRotation()),t=new Ammo.btFixedConstraint(i,o,n,s);break;case c.SPRING:t=new Ammo.btGeneric6DofSpringConstraint(i,o,n,s,!0);break;case c.SLIDER:(t=new Ammo.btSliderConstraint(i,o,n,s,!0)).setLowerLinLimit(-1),t.setUpperLinLimit(1);break;case c.HINGE:var r=new Ammo.btVector3(e.pivot.x,e.pivot.y,e.pivot.z),a=new Ammo.btVector3(e.targetPivot.x,e.targetPivot.y,e.targetPivot.z),l=new Ammo.btVector3(e.axis.x,e.axis.y,e.axis.z),h=new Ammo.btVector3(e.targetAxis.x,e.targetAxis.y,e.targetAxis.z);t=new Ammo.btHingeConstraint(i,o,r,a,l,h,!0),Ammo.destroy(r),Ammo.destroy(a),Ammo.destroy(l),Ammo.destroy(h);break;case c.CONE_TWIST:r=new Ammo.btTransform,a=(r.setIdentity(),r.getOrigin().setValue(e.pivot.x,e.pivot.y,e.pivot.z),new Ammo.btTransform);a.setIdentity(),a.getOrigin().setValue(e.targetPivot.x,e.targetPivot.y,e.targetPivot.z),t=new Ammo.btConeTwistConstraint(i,o,r,a),Ammo.destroy(r),Ammo.destroy(a);break;case c.POINT_TO_POINT:l=new Ammo.btVector3(e.pivot.x,e.pivot.y,e.pivot.z),h=new Ammo.btVector3(e.targetPivot.x,e.targetPivot.y,e.targetPivot.z);t=new Ammo.btPoint2PointConstraint(i,o,l,h),Ammo.destroy(l),Ammo.destroy(h);break;default:throw new Error("[constraint] Unexpected type: "+e.type)}return Ammo.destroy(n),Ammo.destroy(s),t}})},{"../constants":19}],9:[function(t,e,i){t("ammo-debug-drawer");let o=t("three-to-ammo"),n=t("../../constants"),s=n.ACTIVATION_STATE,r=n.COLLISION_FLAG,l=n.SHAPE,h=n.TYPE,a=[s.ACTIVE_TAG,s.ISLAND_SLEEPING,s.WANTS_DEACTIVATION,s.DISABLE_DEACTIVATION,s.DISABLE_SIMULATION];function c(t,e,i){return Math.abs(e.x-i.x)<t&&Math.abs(e.y-i.y)<t&&Math.abs(e.z-i.z)<t}function d(t,e,i){return Math.abs(e.x()-i.x())<t&&Math.abs(e.y()-i.y())<t&&Math.abs(e.z()-i.z())<t}t={schema:{loadedEvent:{default:""},mass:{default:1},gravity:{type:"vec3",default:{x:0,y:-9.8,z:0}},linearDamping:{default:.01},angularDamping:{default:.01},linearSleepingThreshold:{default:1.6},angularSleepingThreshold:{default:2.5},angularFactor:{type:"vec3",default:{x:1,y:1,z:1}},activationState:{default:s.ACTIVE_TAG,oneOf:a},type:{default:"dynamic",oneOf:[h.STATIC,h.DYNAMIC,h.KINEMATIC]},emitCollisionEvents:{default:!1},disableCollision:{default:!1},collisionFilterGroup:{default:1},collisionFilterMask:{default:1},scaleAutoUpdate:{default:!0}},init:function(){this.system=this.el.sceneEl.systems.physics,this.shapeComponents=[],""===this.data.loadedEvent?this.loadedEventFired=!0:this.el.addEventListener(this.data.loadedEvent,()=>{this.loadedEventFired=!0},{once:!0}),this.system.initialized&&this.loadedEventFired&&this.initBody()},initBody:(()=>{let o=new THREE.Vector3,n=new THREE.Quaternion;return new THREE.Box3,function(){var t=this.el,e=this.data,i=(this.localScaling=new Ammo.btVector3,this.el.object3D),i=(i.getWorldPosition(o),i.getWorldQuaternion(n),this.prevScale=new THREE.Vector3(1,1,1),this.prevNumChildShapes=0,this.msTransform=new Ammo.btTransform,this.msTransform.setIdentity(),this.rotation=new Ammo.btQuaternion(n.x,n.y,n.z,n.w),this.msTransform.getOrigin().setValue(o.x,o.y,o.z),this.msTransform.setRotation(this.rotation),this.motionState=new Ammo.btDefaultMotionState(this.msTransform),this.localInertia=new Ammo.btVector3(0,0,0),this.compoundShape=new Ammo.btCompoundShape(!0),this.rbInfo=new Ammo.btRigidBodyConstructionInfo(e.mass,this.motionState,this.compoundShape,this.localInertia),this.body=new Ammo.btRigidBody(this.rbInfo),this.body.setActivationState(a.indexOf(e.activationState)+1),this.body.setSleepingThresholds(e.linearSleepingThreshold,e.angularSleepingThreshold),this.body.setDamping(e.linearDamping,e.angularDamping),new Ammo.btVector3(e.angularFactor.x,e.angularFactor.y,e.angularFactor.z)),i=(this.body.setAngularFactor(i),Ammo.destroy(i),new Ammo.btVector3(e.gravity.x,e.gravity.y,e.gravity.z));d(.001,i,this.system.driver.physicsWorld.getGravity())||(this.body.setGravity(i),this.body.setFlags(1)),Ammo.destroy(i),this.updateCollisionFlags(),this.el.body=this.body,this.body.el=t,this.isLoaded=!0,this.el.emit("body-loaded",{body:this.el.body}),this._addToSystem()}})(),tick:function(){this.system.initialized&&!this.isLoaded&&this.loadedEventFired&&this.initBody()},_updateShapes:(()=>{let a=[l.HULL,l.HACD,l.VHACD];return function(){let t=!1;var e=this.el.object3D;if(this.data.scaleAutoUpdate&&this.prevScale&&!c(.001,e.scale,this.prevScale)&&(this.prevScale.copy(e.scale),t=!0,this.localScaling.setValue(this.prevScale.x,this.prevScale.y,this.prevScale.z),this.compoundShape.setLocalScaling(this.localScaling)),this.shapeComponentsChanged){this.shapeComponentsChanged=!1,t=!0;for(let t=0;t<this.shapeComponents.length;t++){var i=this.shapeComponents[t],o=(0===i.getShapes().length&&this._createCollisionShape(i),i.getShapes());for(let t=0;t<o.length;t++){var n=o[t];n.added||(this.compoundShape.addChildShape(n.localTransform,n),n.added=!0)}}this.data.type===h.DYNAMIC&&this.updateMass(),this.system.driver.updateBody(this.body)}if(this.system.debug&&(t||!this.polyHedralFeaturesInitialized)){for(let t=0;t<this.shapeComponents.length;t++){var s=this.shapeComponents[t].getShapes();for(let t=0;t<s.length;t++){var r=s[t];-1!==a.indexOf(r.type)&&r.initializePolyhedralFeatures(0)}}this.polyHedralFeaturesInitialized=!0}}})(),_createCollisionShape:function(t){var e=t.data,e=o.createCollisionShapes(t.getMesh(),e);t.addShapes(e)},play:function(){this.isLoaded&&this._addToSystem()},_addToSystem:function(){this.addedToSystem||(this.system.addBody(this.body,this.data.collisionFilterGroup,this.data.collisionFilterMask),this.data.emitCollisionEvents&&this.system.driver.addEventListener(this.body),this.system.addComponent(this),this.addedToSystem=!0)},pause:function(){this.addedToSystem&&(this.system.removeComponent(this),this.system.removeBody(this.body),this.addedToSystem=!1)},update:function(t){var e,i;this.isLoaded&&(this.hasUpdated?(e=this.data,t.type===e.type&&t.disableCollision===e.disableCollision||this.updateCollisionFlags(),t.activationState!==e.activationState&&(this.body.forceActivationState(a.indexOf(e.activationState)+1),e.activationState===s.ACTIVE_TAG)&&this.body.activate(!0),t.collisionFilterGroup===e.collisionFilterGroup&&t.collisionFilterMask===e.collisionFilterMask||((i=this.body.getBroadphaseProxy()).set_m_collisionFilterGroup(e.collisionFilterGroup),i.set_m_collisionFilterMask(e.collisionFilterMask),this.system.driver.broadphase.getOverlappingPairCache().removeOverlappingPairsContainingProxy(i,this.system.driver.dispatcher)),t.linearDamping==e.linearDamping&&t.angularDamping==e.angularDamping||this.body.setDamping(e.linearDamping,e.angularDamping),c(.001,t.gravity,e.gravity)||(d(.001,i=new Ammo.btVector3(e.gravity.x,e.gravity.y,e.gravity.z),this.system.driver.physicsWorld.getGravity())?this.body.setFlags(0):this.body.setFlags(1),this.body.setGravity(i),Ammo.destroy(i)),t.linearSleepingThreshold==e.linearSleepingThreshold&&t.angularSleepingThreshold==e.angularSleepingThreshold||this.body.setSleepingThresholds(e.linearSleepingThreshold,e.angularSleepingThreshold),c(.001,t.angularFactor,e.angularFactor)||(i=new Ammo.btVector3(e.angularFactor.x,e.angularFactor.y,e.angularFactor.z),this.body.setAngularFactor(i),Ammo.destroy(i))):this.hasUpdated=!0)},remove:function(){this.triMesh&&Ammo.destroy(this.triMesh),this.localScaling&&Ammo.destroy(this.localScaling),this.compoundShape&&Ammo.destroy(this.compoundShape),this.body&&(Ammo.destroy(this.body),delete this.body),Ammo.destroy(this.rbInfo),Ammo.destroy(this.msTransform),Ammo.destroy(this.motionState),Ammo.destroy(this.localInertia),Ammo.destroy(this.rotation)},beforeStep:function(){this._updateShapes(),this.data.type!==h.DYNAMIC&&this.syncToPhysics()},step:function(){this.data.type===h.DYNAMIC&&this.syncFromPhysics()},syncToPhysics:(()=>{let i=new THREE.Quaternion,o=new THREE.Vector3,n=new THREE.Vector3,s=new THREE.Vector3;return function(){var t=this.el,e=t.parentEl;this.body&&(this.motionState.getWorldTransform(this.msTransform),e.isScene?(o.copy(t.object3D.position),i.copy(t.object3D.quaternion)):(t.object3D.getWorldPosition(o),t.object3D.getWorldQuaternion(i)),e=this.msTransform.getOrigin(),s.set(e.x(),e.y(),e.z()),t=this.msTransform.getRotation(),n.set(t.x(),t.y(),t.z(),t.w()),c(.001,o,s)&&(e=i,t=n,Math.abs(e.x-t.x)<.001&&Math.abs(e.y-t.y)<.001&&Math.abs(e.z-t.z)<.001&&Math.abs(e.w-t.w)<.001||Math.abs(e.x+t.x)<.001&&Math.abs(e.y+t.y)<.001&&Math.abs(e.z+t.z)<.001&&Math.abs(e.w+t.w)<.001)||(this.body.isActive()||this.body.activate(!0),this.msTransform.getOrigin().setValue(o.x,o.y,o.z),this.rotation.setValue(i.x,i.y,i.z,i.w),this.msTransform.setRotation(this.rotation),this.motionState.setWorldTransform(this.msTransform),this.data.type===h.STATIC&&this.body.setCenterOfMassTransform(this.msTransform)))}})(),syncFromPhysics:(()=>{let n=new THREE.Vector3,s=new THREE.Quaternion,r=new THREE.Quaternion;return function(){this.motionState.getWorldTransform(this.msTransform);var t=this.msTransform.getOrigin(),e=this.msTransform.getRotation(),i=this.el,o=i.parentEl;this.body&&o&&(o.isScene?(i.object3D.position.set(t.x(),t.y(),t.z()),i.object3D.quaternion.set(e.x(),e.y(),e.z(),e.w())):(s.set(e.x(),e.y(),e.z(),e.w()),o.object3D.getWorldQuaternion(r),s.multiply(r.invert()),i.object3D.quaternion.copy(s),n.set(t.x(),t.y(),t.z()),o.object3D.worldToLocal(n),i.object3D.position.copy(n)))}})(),addShapeComponent:function(t){t.data.type!==l.MESH||this.data.type===h.STATIC?(this.shapeComponents.push(t),this.shapeComponentsChanged=!0):console.warn("non-static mesh colliders not supported")},removeShapeComponent:function(t){var e=this.shapeComponents.indexOf(t);if(this.compoundShape&&-1!==e&&this.body){for(var i=t.getShapes(),o=0;o<i.length;o++)this.compoundShape.removeChildShape(i[o]);this.shapeComponentsChanged=!0,this.shapeComponents.splice(e,1)}},updateMass:function(){var t=this.body.getCollisionShape(),e=this.data.type===h.DYNAMIC?this.data.mass:0;t.calculateLocalInertia(e,this.localInertia),this.body.setMassProps(e,this.localInertia),this.body.updateInertiaTensor()},updateCollisionFlags:function(){let t=this.data.disableCollision?4:0;switch(this.data.type){case h.STATIC:t|=r.STATIC_OBJECT;break;case h.KINEMATIC:t|=r.KINEMATIC_OBJECT;break;default:this.body.applyGravity()}this.body.setCollisionFlags(t),this.updateMass(),this.system.driver.updateBody(this.body)},getVelocity:function(){return this.body.getLinearVelocity()}};e.exports.definition=t,e.exports.Component=AFRAME.registerComponent("ammo-body",t)},{"../../constants":19,"ammo-debug-drawer":3,"three-to-ammo":5}],10:[function(t,e,i){var s=t("cannon-es"),n=t("three-to-cannon").threeToCannon;t("../../../lib/CANNON-shape2mesh");var o,r,a,l,h,t={dependencies:["velocity"],schema:{mass:{default:5,if:{type:"dynamic"}},linearDamping:{default:.01,if:{type:"dynamic"}},angularDamping:{default:.01,if:{type:"dynamic"}},shape:{default:"auto",oneOf:["auto","box","cylinder","sphere","hull","mesh","none"]},cylinderAxis:{default:"y",oneOf:["x","y","z"]},sphereRadius:{default:NaN},type:{default:"dynamic",oneOf:["static","dynamic"]}},init:function(){this.system=this.el.sceneEl.systems.physics,this.el.sceneEl.hasLoaded?this.initBody():this.el.sceneEl.addEventListener("loaded",this.initBody.bind(this))},initBody:function(){var t=this.el,e=this.data,i=this.el.object3D,o=i.position,i=i.quaternion;if(this.body=new s.Body({mass:"static"!==e.type&&e.mass||0,material:this.system.getMaterial("defaultMaterial"),position:new s.Vec3(o.x,o.y,o.z),quaternion:new s.Quaternion(i.x,i.y,i.z,i.w),linearDamping:e.linearDamping,angularDamping:e.angularDamping,type:"dynamic"===e.type?s.Body.DYNAMIC:s.Body.STATIC}),this.el.object3D.updateMatrixWorld(!0),"none"!==e.shape){o="auto"===e.shape?void 0:AFRAME.utils.extend({},this.data,{type:n.Type[e.shape.toUpperCase()]}),i=n(this.el.object3D,o);if(!i)return void t.addEventListener("object3dset",this.initBody.bind(this));this.body.addShape(i,i.offset,i.orientation),this.system.debug&&(this.shouldUpdateWireframe=!0),this.isLoaded=!0}this.el.body=this.body,this.body.el=t,this.isPlaying&&this._play(),this.isLoaded&&this.el.emit("body-loaded",{body:this.el.body})},addShape:function(t,e,i){"none"===this.data.shape?t?this.body?(this.body.addShape(t,e,i),this.system.debug&&(this.shouldUpdateWireframe=!0),this.shouldUpdateBody=!0):console.warn("shape cannot be added before body is loaded"):console.warn("shape cannot be null"):console.warn("shape can only be added if shape property is none")},tick:function(){this.shouldUpdateBody&&(this.isLoaded=!0,this._play(),this.el.emit("body-loaded",{body:this.el.body}),this.shouldUpdateBody=!1),this.shouldUpdateWireframe&&(this.createWireframe(this.body),this.shouldUpdateWireframe=!1)},play:function(){this.isLoaded&&this._play()},_play:function(){this.syncToPhysics(),this.el.emit("body-played",{body:this.el.body}),this.system.addComponent(this),this.system.addBody(this.body),this.wireframe&&this.el.sceneEl.object3D.add(this.wireframe)},pause:function(){this.isLoaded&&this._pause()},_pause:function(){this.system.removeComponent(this),this.body&&this.system.removeBody(this.body),this.wireframe&&this.el.sceneEl.object3D.remove(this.wireframe)},update:function(t){var e;this.body&&(e=this.data,null!=t.type&&e.type!=t.type&&(this.body.type="dynamic"===e.type?s.Body.DYNAMIC:s.Body.STATIC),this.body.mass=e.mass||0,"dynamic"===e.type&&(this.body.linearDamping=e.linearDamping,this.body.angularDamping=e.angularDamping),e.mass!==t.mass&&this.body.updateMassProperties(),this.body.updateProperties)&&this.body.updateProperties()},remove:function(){this.body&&(delete this.body.el,delete this.body),delete this.el.body,delete this.wireframe},beforeStep:function(){0===this.body.mass&&this.syncToPhysics()},step:function(){0!==this.body.mass&&this.syncFromPhysics()},createWireframe:function(t){var e;this.wireframe&&(this.el.sceneEl.object3D.remove(this.wireframe),delete this.wireframe),this.wireframe=new THREE.Object3D,this.el.sceneEl.object3D.add(this.wireframe);for(var i=new THREE.Quaternion,o=0;o<this.body.shapes.length;o++){e=this.body.shapeOffsets[o],i.copy(this.body.shapeOrientations[o]);var n=s.shape2mesh(this.body).children[o],n=new THREE.LineSegments(new THREE.EdgesGeometry(n.geometry),new THREE.LineBasicMaterial({color:16711680}));e&&n.position.copy(e),i&&n.quaternion.copy(i),this.wireframe.add(n)}this.syncWireframe()},syncWireframe:function(){var t,e=this.wireframe;this.wireframe&&(e.quaternion.copy(this.body.quaternion),e.orientation&&e.quaternion.multiply(e.orientation),e.position.copy(this.body.position),e.offset&&(t=e.offset.clone().applyQuaternion(e.quaternion),e.position.add(t)),e.updateMatrix())},syncToPhysics:(o=new THREE.Quaternion,r=new THREE.Vector3,function(){var t=this.el,e=t.parentEl,i=this.body;i&&(t.components.velocity&&i.velocity.copy(t.getAttribute("velocity")),e.isScene?(i.quaternion.copy(t.object3D.quaternion),i.position.copy(t.object3D.position)):(t.object3D.getWorldQuaternion(o),i.quaternion.copy(o),t.object3D.getWorldPosition(r),i.position.copy(r)),this.body.updateProperties&&this.body.updateProperties(),this.wireframe)&&this.syncWireframe()}),syncFromPhysics:(a=new THREE.Vector3,l=new THREE.Quaternion,h=new THREE.Quaternion,function(){var t=this.el,e=t.parentEl,i=this.body;i&&e&&(e.isScene?(t.object3D.quaternion.copy(i.quaternion),t.object3D.position.copy(i.position)):(l.copy(i.quaternion),e.object3D.getWorldQuaternion(h),l.premultiply(h.invert()),t.object3D.quaternion.copy(l),a.copy(i.position),e.object3D.worldToLocal(a),t.object3D.position.copy(a)),this.wireframe)&&this.syncWireframe()})};e.exports.definition=t,e.exports.Component=AFRAME.registerComponent("body",t)},{"../../../lib/CANNON-shape2mesh":2,"cannon-es":4,"three-to-cannon":6}],11:[function(t,e,i){t=t("./body"),t=AFRAME.utils.extend({},t.definition);e.exports=AFRAME.registerComponent("dynamic-body",t)},{"./body":10}],12:[function(t,e,i){var t=t("./body"),o=AFRAME.utils.extend({},t.definition);o.schema=AFRAME.utils.extend({},t.definition.schema,{type:{default:"static",oneOf:["static","dynamic"]},mass:{default:0}}),e.exports=AFRAME.registerComponent("static-body",o)},{"./body":10}],13:[function(t,e,i){var r=t("cannon-es");e.exports=AFRAME.registerComponent("constraint",{multiple:!0,schema:{type:{default:"lock",oneOf:["coneTwist","distance","hinge","lock","pointToPoint"]},target:{type:"selector"},maxForce:{default:1e6,min:0},collideConnected:{default:!0},wakeUpBodies:{default:!0},distance:{default:0,min:0},pivot:{type:"vec3"},targetPivot:{type:"vec3"},axis:{type:"vec3",default:{x:0,y:0,z:1}},targetAxis:{type:"vec3",default:{x:0,y:0,z:1}}},init:function(){this.system=this.el.sceneEl.systems.physics,this.constraint=null},remove:function(){this.constraint&&(this.system.removeConstraint(this.constraint),this.constraint=null)},update:function(){var t=this.el,e=this.data;this.remove(),t.body&&e.target.body?(this.constraint=this.createConstraint(),this.system.addConstraint(this.constraint)):(t.body?e.target:t).addEventListener("body-loaded",this.update.bind(this,{}))},createConstraint:function(){var t,e=this.data,i=new r.Vec3(e.pivot.x,e.pivot.y,e.pivot.z),o=new r.Vec3(e.targetPivot.x,e.targetPivot.y,e.targetPivot.z),n=new r.Vec3(e.axis.x,e.axis.y,e.axis.z),s=new r.Vec3(e.targetAxis.x,e.targetAxis.y,e.targetAxis.z);switch(e.type){case"lock":(t=new r.LockConstraint(this.el.body,e.target.body,{maxForce:e.maxForce})).type="LockConstraint";break;case"distance":(t=new r.DistanceConstraint(this.el.body,e.target.body,e.distance,e.maxForce)).type="DistanceConstraint";break;case"hinge":(t=new r.HingeConstraint(this.el.body,e.target.body,{pivotA:i,pivotB:o,axisA:n,axisB:s,maxForce:e.maxForce})).type="HingeConstraint";break;case"coneTwist":(t=new r.ConeTwistConstraint(this.el.body,e.target.body,{pivotA:i,pivotB:o,axisA:n,axisB:s,maxForce:e.maxForce})).type="ConeTwistConstraint";break;case"pointToPoint":(t=new r.PointToPointConstraint(this.el.body,i,e.target.body,o,e.maxForce)).type="PointToPointConstraint";break;default:throw new Error("[constraint] Unexpected type: "+e.type)}return t.collideConnected=e.collideConnected,t}})},{"cannon-es":4}],14:[function(t,e,i){e.exports={velocity:t("./velocity"),registerAll:function(t){this._registered||((t=t||window.AFRAME).components.velocity||t.registerComponent("velocity",this.velocity),this._registered=!0)}}},{"./velocity":15}],15:[function(t,e,i){e.exports=AFRAME.registerComponent("velocity",{schema:{type:"vec3"},init:function(){this.system=this.el.sceneEl.systems.physics,this.system&&this.system.addComponent(this)},remove:function(){this.system&&this.system.removeComponent(this)},tick:function(t,e){!e||this.system||this.afterStep(t,e)},afterStep:function(t,e){var i,o,n;e&&(i=this.el.sceneEl.systems.physics||{data:{maxInterval:1/60}},o=this.el.getAttribute("velocity")||{x:0,y:0,z:0},n=this.el.object3D.position||{x:0,y:0,z:0},e=Math.min(e,1e3*i.data.maxInterval),this.el.object3D.position.set(n.x+o.x*e/1e3,n.y+o.y*e/1e3,n.z+o.z*e/1e3))}})},{}],16:[function(t,e,i){t("three-to-ammo");let o=t("../../constants"),n=o.SHAPE,s=o.FIT,r={schema:{type:{default:n.HULL,oneOf:[n.BOX,n.CYLINDER,n.SPHERE,n.CAPSULE,n.CONE,n.HULL,n.HACD,n.VHACD,n.MESH,n.HEIGHTFIELD]},fit:{default:s.ALL,oneOf:[s.ALL,s.MANUAL]},halfExtents:{type:"vec3",default:{x:1,y:1,z:1}},minHalfExtent:{default:0},maxHalfExtent:{default:Number.POSITIVE_INFINITY},sphereRadius:{default:NaN},cylinderAxis:{default:"y",oneOf:["x","y","z"]},margin:{default:.01},offset:{type:"vec3",default:{x:0,y:0,z:0}},orientation:{type:"vec4",default:{x:0,y:0,z:0,w:1}},heightfieldData:{default:[]},heightfieldDistance:{default:1},includeInvisible:{default:!1}},multiple:!0,init:function(){this.system=this.el.sceneEl.systems.physics,this.collisionShapes=[];let t=this.el;for(this.body=t.components["ammo-body"]||null;!this.body&&t.parentNode!=this.el.sceneEl;)(t=t.parentNode).components["ammo-body"]&&(this.body=t.components["ammo-body"]);if(this.body){if(this.data.fit!==s.MANUAL){if(!this.el.object3DMap.mesh)return void console.error("Cannot use FIT.ALL without object3DMap.mesh");this.mesh=this.el.object3DMap.mesh}this.body.addShapeComponent(this)}else console.warn("body not found")},getMesh:function(){return this.mesh||null},addShapes:function(t){this.collisionShapes=t},getShapes:function(){return this.collisionShapes},remove:function(){if(this.body)for(this.body.removeShapeComponent(this);0<this.collisionShapes.length;){var t=this.collisionShapes.pop();t.destroy(),Ammo.destroy(t.localTransform)}}};e.exports.definition=r,e.exports.Component=AFRAME.registerComponent("ammo-shape",r)},{"../../constants":19,"three-to-ammo":5}],17:[function(t,e,i){var a=t("cannon-es"),t={schema:{shape:{default:"box",oneOf:["box","sphere","cylinder"]},offset:{type:"vec3",default:{x:0,y:0,z:0}},orientation:{type:"vec4",default:{x:0,y:0,z:0,w:1}},radius:{type:"number",default:1,if:{shape:["sphere"]}},halfExtents:{type:"vec3",default:{x:.5,y:.5,z:.5},if:{shape:["box"]}},radiusTop:{type:"number",default:1,if:{shape:["cylinder"]}},radiusBottom:{type:"number",default:1,if:{shape:["cylinder"]}},height:{type:"number",default:1,if:{shape:["cylinder"]}},numSegments:{type:"int",default:8,if:{shape:["cylinder"]}}},multiple:!0,init:function(){this.el.sceneEl.hasLoaded?this.initShape():this.el.sceneEl.addEventListener("loaded",this.initShape.bind(this))},initShape:function(){this.bodyEl=this.el;for(var t=this._findType(this.bodyEl),e=this.data;!t&&this.bodyEl.parentNode!=this.el.sceneEl;)this.bodyEl=this.bodyEl.parentNode,t=this._findType(this.bodyEl);if(t){var i,o,n=new THREE.Vector3;switch(this.bodyEl.object3D.getWorldScale(n),e.hasOwnProperty("offset")&&(i=new a.Vec3(e.offset.x*n.x,e.offset.y*n.y,e.offset.z*n.z)),e.hasOwnProperty("orientation")&&(o=new a.Quaternion).copy(e.orientation),e.shape){case"sphere":r=new a.Sphere(e.radius*n.x);break;case"box":var s=new a.Vec3(e.halfExtents.x*n.x,e.halfExtents.y*n.y,e.halfExtents.z*n.z),r=new a.Box(s);break;case"cylinder":r=new a.Cylinder(e.radiusTop*n.x,e.radiusBottom*n.x,e.height*n.y,e.numSegments);s=new a.Quaternion;s.setFromEuler(90*THREE.Math.DEG2RAD,0,0,"XYZ").normalize(),o.mult(s,o);break;default:return void console.warn(e.shape+" shape not supported")}this.bodyEl.body?this.bodyEl.components[t].addShape(r,i,o):this.bodyEl.addEventListener("body-loaded",function(){this.bodyEl.components[t].addShape(r,i,o)},{once:!0})}else console.warn("body not found")},_findType:function(t){return t.hasAttribute("body")?"body":t.hasAttribute("dynamic-body")?"dynamic-body":t.hasAttribute("static-body")?"static-body":null},remove:function(){this.bodyEl.parentNode&&console.warn("removing shape component not currently supported")}};e.exports.definition=t,e.exports.Component=AFRAME.registerComponent("shape",t)},{"cannon-es":4}],18:[function(t,e,i){var o=t("cannon-es");e.exports=AFRAME.registerComponent("spring",{multiple:!0,schema:{target:{type:"selector"},restLength:{default:1,min:0},stiffness:{default:100,min:0},damping:{default:1,min:0},localAnchorA:{type:"vec3",default:{x:0,y:0,z:0}},localAnchorB:{type:"vec3",default:{x:0,y:0,z:0}}},init:function(){this.system=this.el.sceneEl.systems.physics,this.system.addComponent(this),this.isActive=!0,this.spring=null},update:function(t){var e=this.el,i=this.data;i.target?e.body&&i.target.body?(this.createSpring(),this.updateSpring(t)):(e.body?i.target:e).addEventListener("body-loaded",this.update.bind(this,{})):console.warn("Spring: invalid target specified.")},updateSpring:function(e){var i,o;this.spring?(i=this.data,o=this.spring,Object.keys(i).forEach(function(t){i[t]!==e[t]&&("target"===t?o.bodyB=i.target.body:o[t]=i[t])})):console.warn("Spring: Component attempted to change spring before its created. No changes made.")},createSpring:function(){this.spring||(this.spring=new o.Spring(this.el.body))},step:function(t,e){return this.spring&&this.isActive?this.spring.applyForce():void 0},play:function(){this.isActive=!0},pause:function(){this.isActive=!1},remove:function(){this.spring&&delete this.spring,this.spring=null}})},{"cannon-es":4}],19:[function(t,e,i){e.exports={GRAVITY:-9.8,MAX_INTERVAL:4/60,ITERATIONS:10,CONTACT_MATERIAL:{friction:.01,restitution:.3,contactEquationStiffness:1e8,contactEquationRelaxation:3,frictionEquationStiffness:1e8,frictionEquationRegularization:3},ACTIVATION_STATE:{ACTIVE_TAG:"active",ISLAND_SLEEPING:"islandSleeping",WANTS_DEACTIVATION:"wantsDeactivation",DISABLE_DEACTIVATION:"disableDeactivation",DISABLE_SIMULATION:"disableSimulation"},COLLISION_FLAG:{STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32,DISABLE_SPU_COLLISION_PROCESSING:64},TYPE:{STATIC:"static",DYNAMIC:"dynamic",KINEMATIC:"kinematic"},SHAPE:{BOX:"box",CYLINDER:"cylinder",SPHERE:"sphere",CAPSULE:"capsule",CONE:"cone",HULL:"hull",HACD:"hacd",VHACD:"vhacd",MESH:"mesh",HEIGHTFIELD:"heightfield"},FIT:{ALL:"all",MANUAL:"manual"},CONSTRAINT:{LOCK:"lock",FIXED:"fixed",SPRING:"spring",SLIDER:"slider",HINGE:"hinge",CONE_TWIST:"coneTwist",POINT_TO_POINT:"pointToPoint"}}},{}],20:[function(t,e,i){t=t("./driver");function o(){this.collisionConfiguration=null,this.dispatcher=null,this.broadphase=null,this.solver=null,this.physicsWorld=null,this.debugDrawer=null,this.els=new Map,this.eventListeners=[],this.collisions=new Map,this.collisionKeys=[],this.currentCollisions=new Map}"undefined"!=typeof window&&(window.AmmoModule=window.Ammo,window.Ammo=null),o.prototype=new t,(e.exports=o.prototype.constructor=o).prototype.init=function(i){return new Promise(e=>{AmmoModule().then(t=>{Ammo=t,this.epsilon=i.epsilon||1e-5,this.debugDrawMode=i.debugDrawMode||THREE.AmmoDebugConstants.NoDebug,this.maxSubSteps=i.maxSubSteps||4,this.fixedTimeStep=i.fixedTimeStep||1/60,this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.broadphase=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.physicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.broadphase,this.solver,this.collisionConfiguration),this.physicsWorld.setForceUpdateAllAabbs(!1),this.physicsWorld.setGravity(new Ammo.btVector3(0,i.hasOwnProperty("gravity")?i.gravity:-9.8,0)),this.physicsWorld.getSolverInfo().set_m_numIterations(i.solverIterations),e()})})},o.prototype.addBody=function(t,e,i){this.physicsWorld.addRigidBody(t,e,i),this.els.set(Ammo.getPointer(t),t.el)},o.prototype.removeBody=function(t){this.physicsWorld.removeRigidBody(t),this.removeEventListener(t);t=Ammo.getPointer(t);this.els.delete(t),this.collisions.delete(t),this.collisionKeys.splice(this.collisionKeys.indexOf(t),1),this.currentCollisions.delete(t)},o.prototype.updateBody=function(t){this.els.has(Ammo.getPointer(t))&&this.physicsWorld.updateSingleAabb(t)},o.prototype.step=function(t){this.physicsWorld.stepSimulation(t,this.maxSubSteps,this.fixedTimeStep);var e=this.dispatcher.getNumManifolds();for(let t=0;t<e;t++){var i=this.dispatcher.getManifoldByIndexInternal(t),o=i.getNumContacts(),n=Ammo.getPointer(i.getBody0()),s=Ammo.getPointer(i.getBody1());let e=!1;for(let t=0;t<o;t++)if(i.getContactPoint(t).getDistance()<=this.epsilon){e=!0;break}e&&(this.collisions.has(n)||(this.collisions.set(n,[]),this.collisionKeys.push(n)),-1===this.collisions.get(n).indexOf(s)&&(this.collisions.get(n).push(s),-1!==this.eventListeners.indexOf(n)&&this.els.get(n).emit("collidestart",{targetEl:this.els.get(s)}),-1!==this.eventListeners.indexOf(s))&&this.els.get(s).emit("collidestart",{targetEl:this.els.get(n)}),this.currentCollisions.has(n)||this.currentCollisions.set(n,new Set),this.currentCollisions.get(n).add(s))}for(let t=0;t<this.collisionKeys.length;t++){var r=this.collisionKeys[t],a=this.collisions.get(r);for(let t=a.length-1;0<=t;t--){var l=a[t];this.currentCollisions.get(r).has(l)||(-1!==this.eventListeners.indexOf(r)&&this.els.get(r).emit("collideend",{targetEl:this.els.get(l)}),-1!==this.eventListeners.indexOf(l)&&this.els.get(l).emit("collideend",{targetEl:this.els.get(r)}),a.splice(t,1))}this.currentCollisions.get(r).clear()}this.debugDrawer&&this.debugDrawer.update()},o.prototype.addConstraint=function(t){this.physicsWorld.addConstraint(t,!1)},o.prototype.removeConstraint=function(t){this.physicsWorld.removeConstraint(t)},o.prototype.addEventListener=function(t){this.eventListeners.push(Ammo.getPointer(t))},o.prototype.removeEventListener=function(t){t=Ammo.getPointer(t);-1!==this.eventListeners.indexOf(t)&&this.eventListeners.splice(this.eventListeners.indexOf(t),1)},o.prototype.destroy=function(){Ammo.destroy(this.collisionConfiguration),Ammo.destroy(this.dispatcher),Ammo.destroy(this.broadphase),Ammo.destroy(this.solver),Ammo.destroy(this.physicsWorld),Ammo.destroy(this.debugDrawer)},o.prototype.getDebugDrawer=function(t,e){return this.debugDrawer||((e=e||{}).debugDrawMode=e.debugDrawMode||this.debugDrawMode,this.debugDrawer=new THREE.AmmoDebugDrawer(t,this.physicsWorld,e)),this.debugDrawer}},{"./driver":21}],21:[function(t,e,i){function o(){}function n(){throw new Error("Method not implemented.")}(e.exports=o).prototype.init=n,o.prototype.step=n,o.prototype.destroy=n,o.prototype.addBody=n,o.prototype.removeBody=n,o.prototype.applyBodyMethod=n,o.prototype.updateBodyProperties=n,o.prototype.addMaterial=n,o.prototype.addContactMaterial=n,o.prototype.addConstraint=n,o.prototype.removeConstraint=n,o.prototype.getContacts=n},{}],22:[function(t,e,i){e.exports={INIT:"init",STEP:"step",ADD_BODY:"add-body",REMOVE_BODY:"remove-body",APPLY_BODY_METHOD:"apply-body-method",UPDATE_BODY_PROPERTIES:"update-body-properties",ADD_MATERIAL:"add-material",ADD_CONTACT_MATERIAL:"add-contact-material",ADD_CONSTRAINT:"add-constraint",REMOVE_CONSTRAINT:"remove-constraint",COLLIDE:"collide"}},{}],23:[function(t,e,i){var o=t("cannon-es"),t=t("./driver");function n(){this.world=null,this.materials={},this.contactMaterial=null}n.prototype=new t,(e.exports=n.prototype.constructor=n).prototype.init=function(t){var e=new o.World;e.quatNormalizeSkip=t.quatNormalizeSkip,e.quatNormalizeFast=t.quatNormalizeFast,e.solver.iterations=t.solverIterations,e.gravity.set(0,t.gravity,0),e.broadphase=new o.NaiveBroadphase,this.world=e},n.prototype.step=function(t){this.world.step(t)},n.prototype.destroy=function(){delete this.world,delete this.contactMaterial,this.materials={}},n.prototype.addBody=function(t){this.world.addBody(t)},n.prototype.removeBody=function(t){this.world.removeBody(t)},n.prototype.applyBodyMethod=function(t,e,i){t["__"+e].apply(t,i)},n.prototype.updateBodyProperties=function(){},n.prototype.getMaterial=function(t){return this.materials[t]},n.prototype.addMaterial=function(t){this.materials[t.name]=new o.Material(t),this.materials[t.name].name=t.name},n.prototype.addContactMaterial=function(t,e,i){t=this.materials[t],e=this.materials[e];this.contactMaterial=new o.ContactMaterial(t,e,i),this.world.addContactMaterial(this.contactMaterial)},n.prototype.addConstraint=function(t){t.type||(t instanceof o.LockConstraint?t.type="LockConstraint":t instanceof o.DistanceConstraint?t.type="DistanceConstraint":t instanceof o.HingeConstraint?t.type="HingeConstraint":t instanceof o.ConeTwistConstraint?t.type="ConeTwistConstraint":t instanceof o.PointToPointConstraint&&(t.type="PointToPointConstraint")),this.world.addConstraint(t)},n.prototype.removeConstraint=function(t){this.world.removeConstraint(t)},n.prototype.getContacts=function(){return this.world.contacts}},{"./driver":21,"cannon-es":4}],24:[function(t,e,i){t=t("./driver");function o(){throw new Error("[NetworkDriver] Driver not implemented.")}o.prototype=new t,e.exports=o.prototype.constructor=o},{"./driver":21}],25:[function(t,e,i){function o(){this.listeners=[]}e.exports=function(t){var e=new o,i=new o;return e.setTarget(i),i.setTarget(e),t(e),i},o.prototype.setTarget=function(t){this.target=t},o.prototype.addEventListener=function(t,e){this.listeners.push(e)},o.prototype.dispatchEvent=function(t,e){for(var i=0;i<this.listeners.length;i++)this.listeners[i](e)},o.prototype.postMessage=function(t){this.target.dispatchEvent("message",{data:t})}},{}],26:[function(t,e,i){var o=t("webworkify"),n=t("./webworkify-debug"),s=t("./driver"),a=t("./event"),r=t("./worker"),l=t("../utils/protocol"),h=l.ID;function c(t){this.fps=t.fps,this.engine=t.engine,this.interpolate=t.interpolate,this.interpBufferSize=t.interpolationBufferSize,this.debug=t.debug,this.bodies={},this.contacts=[],this.frameDelay=1e3*this.interpBufferSize/this.fps,this.frameBuffer=[],this.worker=(this.debug?n:o)(r),this.worker.addEventListener("message",this._onMessage.bind(this))}c.prototype=new s,(e.exports=c.prototype.constructor=c).prototype.init=function(t){this.worker.postMessage({type:a.INIT,worldConfig:t,fps:this.fps,engine:this.engine})},c.prototype.step=function(){if(this.interpolate){for(var t=this.frameBuffer[0],e=this.frameBuffer[1],i=performance.now();t&&e&&i-t.timestamp>this.frameDelay;)this.frameBuffer.shift(),t=this.frameBuffer[0],e=this.frameBuffer[1];if(t&&e){var o,n=((i-t.timestamp)/this.frameDelay-(1-1/this.interpBufferSize))*this.interpBufferSize;for(o in t.bodies)t.bodies.hasOwnProperty(o)&&e.bodies.hasOwnProperty(o)&&l.deserializeInterpBodyUpdate(t.bodies[o],e.bodies[o],this.bodies[o],n)}}},c.prototype.destroy=function(){this.worker.terminate(),delete this.worker},c.prototype._onMessage=function(t){if(t.data.type===a.STEP){var e=t.data.bodies;if(this.contacts=t.data.contacts,this.interpolate)this.frameBuffer.push({timestamp:performance.now(),bodies:e});else for(var i in e)e.hasOwnProperty(i)&&l.deserializeBodyUpdate(e[i],this.bodies[i])}else{if(t.data.type!==a.COLLIDE)throw new Error("[WorkerDriver] Unexpected message type.");var o=this.bodies[t.data.bodyID],n=this.bodies[t.data.targetID],s=l.deserializeContact(t.data.contact,this.bodies);if(o._listeners&&o._listeners.collide)for(var r=0;r<o._listeners.collide.length;r++)o._listeners.collide[r]({target:n,body:o,contact:s})}},c.prototype.addBody=function(t){l.assignID("body",t),this.bodies[t[h]]=t,this.worker.postMessage({type:a.ADD_BODY,body:l.serializeBody(t)})},c.prototype.removeBody=function(t){this.worker.postMessage({type:a.REMOVE_BODY,bodyID:t[h]}),delete this.bodies[t[h]]},c.prototype.applyBodyMethod=function(t,e,i){switch(e){case"applyForce":case"applyImpulse":this.worker.postMessage({type:a.APPLY_BODY_METHOD,bodyID:t[h],methodName:e,args:[i[0].toArray(),i[1].toArray()]});break;default:throw new Error("Unexpected methodName: %s",e)}},c.prototype.updateBodyProperties=function(t){this.worker.postMessage({type:a.UPDATE_BODY_PROPERTIES,body:l.serializeBody(t)})},c.prototype.getMaterial=function(t){},c.prototype.addMaterial=function(t){this.worker.postMessage({type:a.ADD_MATERIAL,materialConfig:t})},c.prototype.addContactMaterial=function(t,e,i){this.worker.postMessage({type:a.ADD_CONTACT_MATERIAL,materialName1:t,materialName2:e,contactMaterialConfig:i})},c.prototype.addConstraint=function(t){t.type||(t instanceof CANNON.LockConstraint?t.type="LockConstraint":t instanceof CANNON.DistanceConstraint?t.type="DistanceConstraint":t instanceof CANNON.HingeConstraint?t.type="HingeConstraint":t instanceof CANNON.ConeTwistConstraint?t.type="ConeTwistConstraint":t instanceof CANNON.PointToPointConstraint&&(t.type="PointToPointConstraint")),l.assignID("constraint",t),this.worker.postMessage({type:a.ADD_CONSTRAINT,constraint:l.serializeConstraint(t)})},c.prototype.removeConstraint=function(t){this.worker.postMessage({type:a.REMOVE_CONSTRAINT,constraintID:t[h]})},c.prototype.getContacts=function(){var e=this.bodies;return this.contacts.map(function(t){return l.deserializeContact(t,e)})}},{"../utils/protocol":30,"./driver":21,"./event":22,"./webworkify-debug":25,"./worker":27,webworkify:7}],27:[function(t,e,i){var h=t("./event"),c=t("./local-driver"),d=t("./ammo-driver"),u=t("../utils/protocol"),p=u.ID;e.exports=function(o){var n,s=null,r={},a={};function l(){s.step(n);var e={};Object.keys(r).forEach(function(t){e[t]=u.serializeBody(r[t])}),o.postMessage({type:h.STEP,bodies:e,contacts:s.getContacts().map(u.serializeContact)})}o.addEventListener("message",function(t){var e=t.data;switch(e.type){case h.INIT:(s=new("cannon"===e.engine?c:d)).init(e.worldConfig),n=1/e.fps,setInterval(l,1e3/e.fps);break;case h.ADD_BODY:var i=u.deserializeBody(e.body);i.material=s.getMaterial("defaultMaterial"),(r[i[p]]=i).addEventListener("collide",function(t){t={type:h.COLLIDE,bodyID:t.target[p],targetID:t.body[p],contact:u.serializeContact(t.contact)};o.postMessage(t)}),s.addBody(i);break;case h.REMOVE_BODY:s.removeBody(r[e.bodyID]),delete r[e.bodyID];break;case h.APPLY_BODY_METHOD:r[e.bodyID][e.methodName](u.deserializeVec3(e.args[0]),u.deserializeVec3(e.args[1]));break;case h.UPDATE_BODY_PROPERTIES:u.deserializeBodyUpdate(e.body,r[e.body.id]);break;case h.ADD_MATERIAL:s.addMaterial(e.materialConfig);break;case h.ADD_CONTACT_MATERIAL:s.addContactMaterial(e.materialName1,e.materialName2,e.contactMaterialConfig);break;case h.ADD_CONSTRAINT:i=u.deserializeConstraint(e.constraint,r);a[i[p]]=i,s.addConstraint(i);break;case h.REMOVE_CONSTRAINT:s.removeConstraint(a[e.constraintID]),delete a[e.constraintID];break;default:throw new Error("[Worker] Unexpected event type: %s",e.type)}})}},{"../utils/protocol":30,"./ammo-driver":20,"./event":22,"./local-driver":23}],28:[function(t,e,i){t("cannon-es");var o=t("./constants"),n=o.GRAVITY,s=o.CONTACT_MATERIAL,r=t("./drivers/local-driver"),a=t("./drivers/worker-driver"),l=t("./drivers/network-driver"),h=t("./drivers/ammo-driver");e.exports=AFRAME.registerSystem("physics",{schema:{driver:{default:"local",oneOf:["local","worker","network","ammo"]},networkUrl:{default:"",if:{driver:"network"}},workerFps:{default:60,if:{driver:"worker"}},workerInterpolate:{default:!0,if:{driver:"worker"}},workerInterpBufferSize:{default:2,if:{driver:"worker"}},workerEngine:{default:"cannon",if:{driver:"worker"},oneOf:["cannon"]},workerDebug:{default:!1,if:{driver:"worker"}},gravity:{default:n},iterations:{default:o.ITERATIONS},friction:{default:s.friction},restitution:{default:s.restitution},contactEquationStiffness:{default:s.contactEquationStiffness},contactEquationRelaxation:{default:s.contactEquationRelaxation},frictionEquationStiffness:{default:s.frictionEquationStiffness},frictionEquationRegularization:{default:s.frictionEquationRegularization},maxInterval:{default:4/60},debug:{default:!1},debugDrawMode:{default:THREE.AmmoDebugConstants.NoDebug},maxSubSteps:{default:4},fixedTimeStep:{default:1/60}},async init(){var t=this.data;switch(this.debug=t.debug,this.callbacks={beforeStep:[],step:[],afterStep:[]},this.listeners={},this.driver=null,t.driver){case"local":this.driver=new r;break;case"ammo":this.driver=new h;break;case"network":this.driver=new l(t.networkUrl);break;case"worker":this.driver=new a({fps:t.workerFps,engine:t.workerEngine,interpolate:t.workerInterpolate,interpolationBufferSize:t.workerInterpBufferSize,debug:t.workerDebug});break;default:throw new Error('[physics] Driver not recognized: "%s".',t.driver)}"ammo"!==t.driver?(await this.driver.init({quatNormalizeSkip:0,quatNormalizeFast:!1,solverIterations:t.iterations,gravity:t.gravity}),this.driver.addMaterial({name:"defaultMaterial"}),this.driver.addMaterial({name:"staticMaterial"}),this.driver.addContactMaterial("defaultMaterial","defaultMaterial",{friction:t.friction,restitution:t.restitution,contactEquationStiffness:t.contactEquationStiffness,contactEquationRelaxation:t.contactEquationRelaxation,frictionEquationStiffness:t.frictionEquationStiffness,frictionEquationRegularization:t.frictionEquationRegularization}),this.driver.addContactMaterial("staticMaterial","defaultMaterial",{friction:1,restitution:0,contactEquationStiffness:t.contactEquationStiffness,contactEquationRelaxation:t.contactEquationRelaxation,frictionEquationStiffness:t.frictionEquationStiffness,frictionEquationRegularization:t.frictionEquationRegularization})):await this.driver.init({gravity:t.gravity,debugDrawMode:t.debugDrawMode,solverIterations:t.iterations,maxSubSteps:t.maxSubSteps,fixedTimeStep:t.fixedTimeStep}),this.initialized=!0,this.debug&&this.setDebug(!0)},tick:function(t,e){if(this.initialized&&e){for(var i=this.callbacks,o=0;o<this.callbacks.beforeStep.length;o++)this.callbacks.beforeStep[o].beforeStep(t,e);for(this.driver.step(Math.min(e/1e3,this.data.maxInterval)),o=0;o<i.step.length;o++)i.step[o].step(t,e);for(o=0;o<i.afterStep.length;o++)i.afterStep[o].afterStep(t,e)}},setDebug:function(t){this.debug=t,"ammo"===this.data.driver&&this.initialized&&(t&&!this.debugDrawer?(this.debugDrawer=this.driver.getDebugDrawer(this.el.object3D),this.debugDrawer.enable()):this.debugDrawer&&(this.debugDrawer.disable(),this.debugDrawer=null))},addBody:function(e,t,i){var o=this.driver;"local"===this.data.driver&&(e.__applyImpulse=e.applyImpulse,e.applyImpulse=function(){o.applyBodyMethod(e,"applyImpulse",arguments)},e.__applyForce=e.applyForce,e.applyForce=function(){o.applyBodyMethod(e,"applyForce",arguments)},e.updateProperties=function(){o.updateBodyProperties(e)},this.listeners[e.id]=function(t){e.el.emit("collide",t)},e.addEventListener("collide",this.listeners[e.id])),this.driver.addBody(e,t,i)},removeBody:function(t){this.driver.removeBody(t),"local"!==this.data.driver&&"worker"!==this.data.driver||(t.removeEventListener("collide",this.listeners[t.id]),delete this.listeners[t.id],t.applyImpulse=t.__applyImpulse,delete t.__applyImpulse,t.applyForce=t.__applyForce,delete t.__applyForce,delete t.updateProperties)},addConstraint:function(t){this.driver.addConstraint(t)},removeConstraint:function(t){this.driver.removeConstraint(t)},addComponent:function(t){var e=this.callbacks;t.beforeStep&&e.beforeStep.push(t),t.step&&e.step.push(t),t.afterStep&&e.afterStep.push(t)},removeComponent:function(t){var e=this.callbacks;t.beforeStep&&e.beforeStep.splice(e.beforeStep.indexOf(t),1),t.step&&e.step.splice(e.step.indexOf(t),1),t.afterStep&&e.afterStep.splice(e.afterStep.indexOf(t),1)},getContacts:function(){return this.driver.getContacts()},getMaterial:function(t){return this.driver.getMaterial(t)}})},{"./constants":19,"./drivers/ammo-driver":20,"./drivers/local-driver":23,"./drivers/network-driver":24,"./drivers/worker-driver":26,"cannon-es":4}],29:[function(t,e,i){e.exports.slerp=function(t,e,i){var o,n,s,r,a,l,h;return i<=0?t:!(1<=i)&&(o=t[0],(l=(r=t[3])*e[3]+o*e[0]+(n=t[1])*e[1]+(s=t[2])*e[2])<0)?((t=t.slice())[3]=-e[3],t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],1<=(l=-l)?(t[3]=r,t[0]=o,t[1]=n,t[2]=s,this):(a=Math.sqrt(1-l*l),Math.abs(a)<.001?(t[3]=.5*(r+t[3]),t[0]=.5*(o+t[0]),t[1]=.5*(n+t[1]),t[2]=.5*(s+t[2]),this):(l=Math.atan2(a,l),h=Math.sin((1-i)*l)/a,i=Math.sin(i*l)/a,t[3]=r*h+t[3]*i,t[0]=o*h+t[0]*i,t[1]=n*h+t[1]*i,t[2]=s*h+t[2]*i,t))):e}},{}],30:[function(t,e,i){var r=t("cannon-es"),a=t("./math"),t="__id",o=(e.exports.ID=t,{});function n(t){var e={type:t.type};if(t.type===r.Shape.types.BOX)e.halfExtents=l(t.halfExtents);else if(t.type===r.Shape.types.SPHERE)e.radius=t.radius;else{if(t._type!==r.Shape.types.CYLINDER)throw new Error("Unimplemented shape type: %s",t.type);e.type=r.Shape.types.CYLINDER,e.radiusTop=t.radiusTop,e.radiusBottom=t.radiusBottom,e.height=t.height,e.numSegments=t.numSegments}return e}function s(t){var e;if(t.type===r.Shape.types.BOX)e=new r.Box(h(t.halfExtents));else if(t.type===r.Shape.types.SPHERE)e=new r.Sphere(t.radius);else{if(t.type!==r.Shape.types.CYLINDER)throw new Error("Unimplemented shape type: %s",t.type);(e=new r.Cylinder(t.radiusTop,t.radiusBottom,t.height,t.numSegments))._type=r.Shape.types.CYLINDER}return e}function l(t){return t.toArray()}function h(t){return new r.Vec3(t[0],t[1],t[2])}function c(t){return t.toArray()}function d(t){return new r.Quaternion(t[0],t[1],t[2],t[3])}e.exports.assignID=function(t,e){e.__id||(o[t]=o[t]||1,e.__id=t+"_"+o[t]++)},e.exports.serializeBody=function(t){return{shapes:t.shapes.map(n),shapeOffsets:t.shapeOffsets.map(l),shapeOrientations:t.shapeOrientations.map(c),position:l(t.position),quaternion:t.quaternion.toArray(),velocity:l(t.velocity),angularVelocity:l(t.angularVelocity),id:t.__id,mass:t.mass,linearDamping:t.linearDamping,angularDamping:t.angularDamping,fixedRotation:t.fixedRotation,allowSleep:t.allowSleep,sleepSpeedLimit:t.sleepSpeedLimit,sleepTimeLimit:t.sleepTimeLimit}},e.exports.deserializeBodyUpdate=function(t,e){return e.position.set(t.position[0],t.position[1],t.position[2]),e.quaternion.set(t.quaternion[0],t.quaternion[1],t.quaternion[2],t.quaternion[3]),e.velocity.set(t.velocity[0],t.velocity[1],t.velocity[2]),e.angularVelocity.set(t.angularVelocity[0],t.angularVelocity[1],t.angularVelocity[2]),e.linearDamping=t.linearDamping,e.angularDamping=t.angularDamping,e.fixedRotation=t.fixedRotation,e.allowSleep=t.allowSleep,e.sleepSpeedLimit=t.sleepSpeedLimit,e.sleepTimeLimit=t.sleepTimeLimit,e.mass!==t.mass&&(e.mass=t.mass,e.updateMassProperties()),e},e.exports.deserializeInterpBodyUpdate=function(t,e,i,o){var n=1-o,s=o,o=(i.position.set(t.position[0]*n+e.position[0]*s,t.position[1]*n+e.position[1]*s,t.position[2]*n+e.position[2]*s),a.slerp(t.quaternion,e.quaternion,o));return i.quaternion.set(o[0],o[1],o[2],o[3]),i.velocity.set(t.velocity[0]*n+e.velocity[0]*s,t.velocity[1]*n+e.velocity[1]*s,t.velocity[2]*n+e.velocity[2]*s),i.angularVelocity.set(t.angularVelocity[0]*n+e.angularVelocity[0]*s,t.angularVelocity[1]*n+e.angularVelocity[1]*s,t.angularVelocity[2]*n+e.angularVelocity[2]*s),i.linearDamping=e.linearDamping,i.angularDamping=e.angularDamping,i.fixedRotation=e.fixedRotation,i.allowSleep=e.allowSleep,i.sleepSpeedLimit=e.sleepSpeedLimit,i.sleepTimeLimit=e.sleepTimeLimit,i.mass!==e.mass&&(i.mass=e.mass,i.updateMassProperties()),i},e.exports.deserializeBody=function(t){for(var e,i=new r.Body({mass:t.mass,position:h(t.position),quaternion:d(t.quaternion),velocity:h(t.velocity),angularVelocity:h(t.angularVelocity),linearDamping:t.linearDamping,angularDamping:t.angularDamping,fixedRotation:t.fixedRotation,allowSleep:t.allowSleep,sleepSpeedLimit:t.sleepSpeedLimit,sleepTimeLimit:t.sleepTimeLimit}),o=0;e=t.shapes[o];o++)i.addShape(s(e),h(t.shapeOffsets[o]),d(t.shapeOrientations[o]));return i.__id=t.id,i},e.exports.serializeShape=n,e.exports.deserializeShape=s,e.exports.serializeConstraint=function(t){var e={id:t.__id,type:t.type,maxForce:t.maxForce,bodyA:t.bodyA.__id,bodyB:t.bodyB.__id};switch(t.type){case"LockConstraint":break;case"DistanceConstraint":e.distance=t.distance;break;case"HingeConstraint":case"ConeTwistConstraint":e.axisA=l(t.axisA),e.axisB=l(t.axisB),e.pivotA=l(t.pivotA),e.pivotB=l(t.pivotB);break;case"PointToPointConstraint":e.pivotA=l(t.pivotA),e.pivotB=l(t.pivotB);break;default:throw new Error("Unexpected constraint type: "+t.type+'. You may need to manually set `constraint.type = "FooConstraint";`.')}return e},e.exports.deserializeConstraint=function(t,e){var i,o=r[t.type],n=e[t.bodyA],s=e[t.bodyB];switch(t.type){case"LockConstraint":i=new r.LockConstraint(n,s,t);break;case"DistanceConstraint":i=new r.DistanceConstraint(n,s,t.distance,t.maxForce);break;case"HingeConstraint":case"ConeTwistConstraint":i=new o(n,s,{pivotA:h(t.pivotA),pivotB:h(t.pivotB),axisA:h(t.axisA),axisB:h(t.axisB),maxForce:t.maxForce});break;case"PointToPointConstraint":i=new r.PointToPointConstraint(n,h(t.pivotA),s,h(t.pivotB),t.maxForce);break;default:throw new Error("Unexpected constraint type: "+t.type)}return i.__id=t.id,i},e.exports.serializeContact=function(t){return{bi:t.bi.__id,bj:t.bj.__id,ni:l(t.ni),ri:l(t.ri),rj:l(t.rj)}},e.exports.deserializeContact=function(t,e){return{bi:e[t.bi],bj:e[t.bj],ni:h(t.ni),ri:h(t.ri),rj:h(t.rj)}},e.exports.serializeVec3=l,e.exports.deserializeVec3=h,e.exports.serializeQuaternion=c,e.exports.deserializeQuaternion=d},{"./math":29,"cannon-es":4}]},{},[1]);
